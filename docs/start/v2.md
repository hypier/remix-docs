---
title: å‡çº§åˆ° v2
order: 3
---

# å‡çº§åˆ° v2

<docs-warning>æœ¬æ–‡ä»¶æä¾›äº†ä» v1 è¿ç§»åˆ° v2 çš„æŒ‡å¯¼ï¼Œä½¿ç”¨çš„æ˜¯ [Classic Remix compiler][classic-remix-compiler]ã€‚æœ‰å…³è¿ç§»åˆ° Vite çš„æ›´å¤šæŒ‡å¯¼ï¼Œè¯·å‚è€ƒ [Remix Vite documentation][remix-vite]ã€‚</docs-warning>

æ‰€æœ‰ v2 çš„ API å’Œè¡Œä¸ºåœ¨ v1 ä¸­éƒ½å¯ä»¥é€šè¿‡ [Future Flags][future-flags] è·å¾—ã€‚å®ƒä»¬å¯ä»¥é€ä¸ªå¯ç”¨ï¼Œä»¥é¿å…å¯¹æ‚¨é¡¹ç›®çš„å¼€å‘é€ æˆå¹²æ‰°ã€‚åœ¨æ‚¨å¯ç”¨æ‰€æœ‰æ ‡å¿—åï¼Œå‡çº§åˆ° v2 åº”è¯¥æ˜¯ä¸€ä¸ªéç ´åæ€§çš„å‡çº§ã€‚

å¦‚æœæ‚¨é‡åˆ°é—®é¢˜ï¼Œè¯·å‚é˜… [Troubleshooting][troubleshooting] éƒ¨åˆ†ã€‚

æœ‰å…³ä¸€äº›å¸¸è§å‡çº§é—®é¢˜çš„å¿«é€Ÿæ¼”ç»ƒï¼Œè¯·æŸ¥çœ‹ [ğŸ¥ 2 minutes to v2][2-min-to-v2]ã€‚

## `remix dev`

æœ‰å…³é…ç½®é€‰é¡¹ï¼Œè¯·å‚è§ [`remix dev` æ–‡æ¡£][dev-docs]ã€‚

### `remix-serve`

å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ Remix åº”ç”¨æœåŠ¡å™¨ (`remix-serve`)ï¼Œè¯·å¯ç”¨ `v2_dev`ï¼š

```js filename=remix.config.js
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  future: {
    v2_dev: true,
  },
};
```

å°±è¿™æ ·ï¼

### è‡ªå®šä¹‰åº”ç”¨æœåŠ¡å™¨

å¦‚æœæ‚¨ä½¿ç”¨è‡ªå·±çš„åº”ç”¨æœåŠ¡å™¨ (`server.js`)ï¼Œ
è¯·æŸ¥çœ‹æˆ‘ä»¬çš„ [æ¨¡æ¿][templates] ä»¥è·å–å¦‚ä½•ä¸ `v2_dev` é›†æˆçš„ç¤ºä¾‹ï¼Œæˆ–æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1. å¯ç”¨ `v2_dev`ï¼š

   ```js filename=remix.config.js
   /** @type {import('@remix-run/dev').AppConfig} */
   module.exports = {
     future: {
       v2_dev: true,
     },
   };
   ```

2. æ›´æ–° `package.json` ä¸­çš„ `scripts`ï¼š

   - å°†ä»»ä½• `remix watch` æ›¿æ¢ä¸º `remix dev`
   - ç§»é™¤å¤šä½™çš„ `NODE_ENV=development`
   - ä½¿ç”¨ `-c` / `--command` æ¥è¿è¡Œæ‚¨çš„åº”ç”¨æœåŠ¡å™¨

   ä¾‹å¦‚ï¼š

   ```diff filename=package.json
    {
      "scripts": {
   -    "dev:remix": "cross-env NODE_ENV=development remix watch",
   -    "dev:server": "cross-env NODE_ENV=development node ./server.js"
   +    "dev": "remix dev -c 'node ./server.js'",
      }
    }
   ```

3. ä¸€æ—¦æ‚¨çš„åº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œï¼Œå‘ Remix ç¼–è¯‘å™¨å‘é€â€œå‡†å¤‡å¥½â€æ¶ˆæ¯

   ```ts filename=server.js lines=[1-2,11]
   import { broadcastDevReady } from "@remix-run/node";
   // import { logDevReady } from "@remix-run/cloudflare" // å¦‚æœä½¿ç”¨ CloudFlareï¼Œè¯·ä½¿ç”¨ `logDevReady`

   const BUILD_DIR = path.join(process.cwd(), "build");

   // ... è®¾ç½®æ‚¨çš„æœåŠ¡å™¨çš„ä»£ç åœ¨è¿™é‡Œ ...

   const port = 3000;
   app.listen(port, async () => {
     console.log(`ğŸ‘‰ http://localhost:${port}`);
     broadcastDevReady(await import(BUILD_DIR));
   });
   ```

4. ï¼ˆå¯é€‰ï¼‰`--manual`

   å¦‚æœæ‚¨ä¾èµ–äº `require` ç¼“å­˜æ¸…é™¤ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ `--manual` æ ‡å¿—ç»§ç»­è¿™æ ·åšï¼š

   ```shellscript nonumber
   remix dev --manual -c 'node ./server.js'
   ```

   è¯·æŸ¥çœ‹ [æ‰‹åŠ¨æ¨¡å¼æŒ‡å—][manual-mode] ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

### ä» v1 å‡çº§åˆ° v2 å

åœ¨ä½ å¯ç”¨äº† v1 ä¸­çš„ `future.v2_dev` æ ‡å¿—å¹¶ä½¿å…¶æ­£å¸¸å·¥ä½œåï¼Œä½ å°±å¯ä»¥å‡†å¤‡å‡çº§åˆ° v2ã€‚
å¦‚æœä½ åªæ˜¯å°† `v2_dev` è®¾ç½®ä¸º `true`ï¼Œä½ å¯ä»¥å°†å…¶ç§»é™¤ï¼Œç³»ç»Ÿåº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œã€‚

å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ `v2_dev` é…ç½®ï¼Œä½ éœ€è¦å°†å…¶ç§»åˆ° `dev` é…ç½®å­—æ®µï¼š

```diff filename=remix.config.js
  /** @type {import('@remix-run/dev').AppConfig} */
  module.exports = {
-   future: {
-     v2_dev: {
-       port: 4004
-     }
-   }
+   dev: {
+     port: 4004
+   }
  }
```

## æ–‡ä»¶ç³»ç»Ÿè·¯ç”±çº¦å®š

#### åœ¨ä¸æ›´æ”¹æ–‡ä»¶çš„æƒ…å†µä¸‹å‡çº§

å¦‚æœæ‚¨ç°åœ¨ï¼ˆæˆ–æ°¸è¿œï¼‰ä¸æƒ³è¿›è¡Œæ›´æ”¹ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨æ—§çš„çº¦å®š `@remix-run/v1-route-convention`ï¼Œå³ä½¿åœ¨å‡çº§åˆ° v2 åä¹Ÿæ˜¯å¦‚æ­¤ï¼Œè¿™åªæ˜¯ä¸€ä¸ªçº¦å®šï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•æ‚¨å–œæ¬¢çš„æ–‡ä»¶ç»„ç»‡æ–¹å¼ã€‚

```shellscript nonumber
npm i -D @remix-run/v1-route-convention
```

```js filename=remix.config.js
const {
  createRoutesFromFolders,
} = require("@remix-run/v1-route-convention");

/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  future: {
    // åœ¨ v1.15+ ä¸­æ¶ˆé™¤è­¦å‘Š
    v2_routeConvention: true,
  },

  routes(defineRoutes) {
    // ä½¿ç”¨ v1 çº¦å®šï¼Œé€‚ç”¨äº v1.15+ å’Œ v2
    return createRoutesFromFolders(defineRoutes);
  },
};
```

#### å‡çº§åˆ°æ–°çº¦å®š

- è·¯ç”±åµŒå¥—ç°åœ¨é€šè¿‡æ–‡ä»¶åä¸­çš„ç‚¹ï¼ˆ`.`ï¼‰åˆ›å»ºï¼Œè€Œä¸æ˜¯æ–‡ä»¶å¤¹åµŒå¥—
- æ®µä¸­çš„ `suffixed_` ä¸‹åˆ’çº¿é€‰æ‹©é€€å‡ºåµŒå¥—ï¼Œè€Œæ˜¯ä½¿ç”¨æ½œåœ¨åŒ¹é…çš„çˆ¶è·¯ç”±ï¼Œè€Œä¸æ˜¯ç‚¹ï¼ˆ`.`ï¼‰ã€‚
- æ®µä¸­çš„ `_prefixed` ä¸‹åˆ’çº¿åˆ›å»ºæ²¡æœ‰è·¯å¾„çš„å¸ƒå±€è·¯ç”±ï¼Œè€Œä¸æ˜¯ `__double` ä¸‹åˆ’çº¿å‰ç¼€ã€‚
- `_index.tsx` æ–‡ä»¶åˆ›å»ºç´¢å¼•è·¯ç”±ï¼Œè€Œä¸æ˜¯ `index.tsx`

åœ¨ v1 ä¸­çœ‹èµ·æ¥åƒè¿™æ ·çš„è·¯ç”±æ–‡ä»¶å¤¹ï¼š

```text bad
app/
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ __auth/
â”‚   â”‚   â”œâ”€â”€ login.tsx
â”‚   â”‚   â”œâ”€â”€ logout.tsx
â”‚   â”‚   â””â”€â”€ signup.tsx
â”‚   â”œâ”€â”€ __public/
â”‚   â”‚   â”œâ”€â”€ about-us.tsx
â”‚   â”‚   â”œâ”€â”€ contact.tsx
â”‚   â”‚   â””â”€â”€ index.tsx
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ calendar/
â”‚   â”‚   â”‚   â”œâ”€â”€ $day.tsx
â”‚   â”‚   â”‚   â””â”€â”€ index.tsx
â”‚   â”‚   â”œâ”€â”€ projects/
â”‚   â”‚   â”‚   â”œâ”€â”€ $projectId/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ collaborators.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ edit.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ settings.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tasks.$taskId.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ $projectId.tsx
â”‚   â”‚   â”‚   â””â”€â”€ new.tsx
â”‚   â”‚   â”œâ”€â”€ calendar.tsx
â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â””â”€â”€ projects.tsx
â”‚   â”œâ”€â”€ __auth.tsx
â”‚   â”œâ”€â”€ __public.tsx
â”‚   â””â”€â”€ dashboard.projects.$projectId.print.tsx
â””â”€â”€ root.tsx
```

åœ¨ä½¿ç”¨ `v2_routeConvention` åå˜ä¸ºï¼š

```text good
app/
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ _auth.login.tsx
â”‚   â”œâ”€â”€ _auth.logout.tsx
â”‚   â”œâ”€â”€ _auth.signup.tsx
â”‚   â”œâ”€â”€ _auth.tsx
â”‚   â”œâ”€â”€ _public._index.tsx
â”‚   â”œâ”€â”€ _public.about-us.tsx
â”‚   â”œâ”€â”€ _public.contact.tsx
â”‚   â”œâ”€â”€ _public.tsx
â”‚   â”œâ”€â”€ dashboard._index.tsx
â”‚   â”œâ”€â”€ dashboard.calendar._index.tsx
â”‚   â”œâ”€â”€ dashboard.calendar.$day.tsx
â”‚   â”œâ”€â”€ dashboard.calendar.tsx
â”‚   â”œâ”€â”€ dashboard.projects.$projectId._index.tsx
â”‚   â”œâ”€â”€ dashboard.projects.$projectId.collaborators.tsx
â”‚   â”œâ”€â”€ dashboard.projects.$projectId.edit.tsx
â”‚   â”œâ”€â”€ dashboard.projects.$projectId.settings.tsx
â”‚   â”œâ”€â”€ dashboard.projects.$projectId.tasks.$taskId.tsx
â”‚   â”œâ”€â”€ dashboard.projects.$projectId.tsx
â”‚   â”œâ”€â”€ dashboard.projects.new.tsx
â”‚   â”œâ”€â”€ dashboard.projects.tsx
â”‚   â””â”€â”€ dashboard_.projects.$projectId.print.tsx
â””â”€â”€ root.tsx
```

è¯·æ³¨æ„ï¼Œçˆ¶è·¯ç”±ç°åœ¨è¢«åˆ†ç»„åœ¨ä¸€èµ·ï¼Œè€Œä¸æ˜¯åœ¨å®ƒä»¬ä¹‹é—´æœ‰æ•°åä¸ªè·¯ç”±ï¼ˆå¦‚èº«ä»½éªŒè¯è·¯ç”±ï¼‰ã€‚å…·æœ‰ç›¸åŒè·¯å¾„ä½†åµŒå¥—ä¸åŒçš„è·¯ç”±ï¼ˆå¦‚ `dashboard` å’Œ `dashboard_`ï¼‰ä¹Ÿä¼šåˆ†ç»„åœ¨ä¸€èµ·ã€‚

ä½¿ç”¨æ–°çº¦å®šï¼Œä»»ä½•è·¯ç”±éƒ½å¯ä»¥æ˜¯ä¸€ä¸ªåŒ…å« `route.tsx` æ–‡ä»¶çš„ç›®å½•ï¼Œä»¥å®šä¹‰è·¯ç”±æ¨¡å—ã€‚è¿™ä½¿å¾—æ¨¡å—ä¸å®ƒä»¬ä½¿ç”¨çš„è·¯ç”±çš„å…±å­˜æˆä¸ºå¯èƒ½ï¼š

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å°† `_public.tsx` ç§»åŠ¨åˆ° `_public/route.tsx`ï¼Œç„¶åä¸è·¯ç”±ä½¿ç”¨çš„æ¨¡å—å…±å­˜ï¼š

```text
app/
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ _auth.tsx
â”‚   â”œâ”€â”€ _public/
â”‚   â”‚   â”œâ”€â”€ footer.tsx
â”‚   â”‚   â”œâ”€â”€ header.tsx
â”‚   â”‚   â””â”€â”€ route.tsx
â”‚   â”œâ”€â”€ _public._index.tsx
â”‚   â”œâ”€â”€ _public.about-us.tsx
â”‚   â””â”€â”€ etc.
â””â”€â”€ root.tsx
```

æœ‰å…³æ­¤æ›´æ”¹çš„æ›´å¤šèƒŒæ™¯ä¿¡æ¯ï¼Œè¯·å‚é˜… [åŸå§‹â€œå¹³é¢è·¯ç”±â€ææ¡ˆ][flat-routes]ã€‚

## è·¯ç”± `headers`

åœ¨ Remix v2 ä¸­ï¼Œè·¯ç”± `headers` å‡½æ•°çš„è¡Œä¸ºç•¥æœ‰å˜åŒ–ã€‚æ‚¨å¯ä»¥é€šè¿‡åœ¨ `remix.config.js` ä¸­ä½¿ç”¨ `future.v2_headers` æ ‡å¿—æå‰é€‰æ‹©è¿™ç§æ–°è¡Œä¸ºã€‚

åœ¨ v1 ä¸­ï¼ŒRemix ä»…ä½¿ç”¨å¶å­â€œæ¸²æŸ“â€è·¯ç”± `headers` å‡½æ•°çš„ç»“æœã€‚æ‚¨æœ‰è´£ä»»ä¸ºæ¯ä¸ªæ½œåœ¨çš„å¶å­æ·»åŠ ä¸€ä¸ª `headers` å‡½æ•°ï¼Œå¹¶ç›¸åº”åœ°åˆå¹¶ `parentHeaders`ã€‚è¿™å¾ˆå¿«å°±ä¼šå˜å¾—ç¹çï¼Œå¹¶ä¸”åœ¨æ·»åŠ æ–°è·¯ç”±æ—¶ï¼Œä¹Ÿå¾ˆå®¹æ˜“å¿˜è®°æ·»åŠ  `headers` å‡½æ•°ï¼Œå³ä½¿æ‚¨å¸Œæœ›å®ƒä»…å…±äº«æ¥è‡ªçˆ¶çº§çš„ç›¸åŒå¤´éƒ¨ã€‚

åœ¨ v2 ä¸­ï¼ŒRemix ç°åœ¨ä½¿ç”¨å®ƒåœ¨æ¸²æŸ“çš„è·¯ç”±ä¸­æ‰¾åˆ°çš„æœ€æ·±çš„ `headers` å‡½æ•°ã€‚è¿™æ›´å®¹æ˜“è®©æ‚¨ä»ä¸€ä¸ªå…±åŒçš„ç¥–å…ˆå…±äº«è·¯ç”±ä¹‹é—´çš„å¤´éƒ¨ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä¸ºæ›´æ·±çš„è·¯ç”±æ·»åŠ  `headers` å‡½æ•°ï¼Œå¦‚æœå®ƒä»¬éœ€è¦ç‰¹å®šçš„è¡Œä¸ºã€‚

## è·¯ç”± `meta`

åœ¨ Remix v2 ä¸­ï¼Œè·¯ç”± `meta` å‡½æ•°çš„ç­¾åä»¥åŠ Remix åœ¨åå°å¤„ç† meta æ ‡ç­¾çš„æ–¹å¼å‘ç”Ÿäº†å˜åŒ–ã€‚

æ‚¨ç°åœ¨å°†è¿”å›ä¸€ä¸ªæè¿°ç¬¦æ•°ç»„ï¼Œè€Œä¸æ˜¯ä» `meta` è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶è‡ªè¡Œç®¡ç†åˆå¹¶ã€‚è¿™ä½¿å¾— `meta` API æ›´æ¥è¿‘ `links`ï¼Œå¹¶å…è®¸å¯¹ meta æ ‡ç­¾çš„æ¸²æŸ“æ–¹å¼æœ‰æ›´å¤§çš„çµæ´»æ€§å’Œæ§åˆ¶ã€‚

æ­¤å¤–ï¼Œ`<Meta />` å°†ä¸å†ä¸ºå±‚çº§ä¸­çš„æ¯ä¸ªè·¯ç”±æ¸²æŸ“ metaã€‚åªæœ‰æ¥è‡ªå¶å­è·¯ç”±çš„ `meta` è¿”å›çš„æ•°æ®ä¼šè¢«æ¸²æŸ“ã€‚æ‚¨ä»ç„¶å¯ä»¥é€šè¿‡è®¿é—® [`matches` åœ¨å‡½æ•°å‚æ•°ä¸­][meta-v2-matches] æ¥é€‰æ‹©åŒ…å«æ¥è‡ªçˆ¶è·¯ç”±çš„ metaã€‚

æœ‰å…³æ­¤æ›´æ”¹çš„æ›´å¤šèƒŒæ™¯ä¿¡æ¯ï¼Œè¯·å‚è§ [åŸå§‹ v2 `meta` ææ¡ˆ][meta-v2-rfc]ã€‚

#### åœ¨ v2 ä¸­ä½¿ç”¨ v1 `meta` çº¦å®š

æ‚¨å¯ä»¥ä½¿ç”¨ `@remix-run/v1-meta` åŒ…æ›´æ–°æ‚¨çš„ `meta` å¯¼å‡ºï¼Œä»¥ç»§ç»­ä½¿ç”¨ v1 çº¦å®šã€‚

ä½¿ç”¨ `metaV1` å‡½æ•°ï¼Œæ‚¨å¯ä»¥ä¼ å…¥ `meta` å‡½æ•°çš„å‚æ•°å’Œå½“å‰è¿”å›çš„ç›¸åŒå¯¹è±¡ã€‚è¯¥å‡½æ•°å°†ä½¿ç”¨ç›¸åŒçš„åˆå¹¶é€»è¾‘å°†å¶å­è·¯ç”±çš„ meta ä¸å…¶ **ç›´æ¥çˆ¶è·¯ç”±** çš„ meta åˆå¹¶ï¼Œç„¶åå°†å…¶è½¬æ¢ä¸ºå¯åœ¨ v2 ä¸­ä½¿ç”¨çš„ meta æè¿°ç¬¦æ•°ç»„ã€‚

```tsx bad filename=app/routes/v1-route.tsx
export function meta() {
  return {
    title: "...",
    description: "...",
    "og:title": "...",
  };
}
```

```tsx filename=app/routes/v2-route.tsx good
import { metaV1 } from "@remix-run/v1-meta";

export function meta(args) {
  return metaV1(args, {
    title: "...",
    description: "...",
    "og:title": "...",
  });
}
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥å‡½æ•°é»˜è®¤ _ä¸ä¼š_ åœ¨æ•´ä¸ªå±‚çº§ä¸­åˆå¹¶ metaã€‚è¿™æ˜¯å› ä¸ºæ‚¨å¯èƒ½æœ‰ä¸€äº›è·¯ç”±ç›´æ¥è¿”å›ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œè€Œä¸ä½¿ç”¨ `metaV1` å‡½æ•°ï¼Œè¿™å¯èƒ½å¯¼è‡´ä¸å¯é¢„æµ‹çš„è¡Œä¸ºã€‚å¦‚æœæ‚¨å¸Œæœ›åœ¨æ•´ä¸ªå±‚çº§ä¸­åˆå¹¶ metaï¼Œè¯·å¯¹æ‰€æœ‰è·¯ç”±çš„ meta å¯¼å‡ºä½¿ç”¨ `metaV1` å‡½æ•°ã€‚

#### `parentsData` å‚æ•°

åœ¨ v2 ä¸­ï¼Œ`meta` å‡½æ•°ä¸å†æ¥æ”¶ `parentsData` å‚æ•°ã€‚è¿™æ˜¯å› ä¸º `meta` ç°åœ¨å¯ä»¥é€šè¿‡ [`matches` å‚æ•°][meta-v2-matches] è®¿é—®æ‚¨æ‰€æœ‰çš„è·¯ç”±åŒ¹é…ï¼Œè¿™åŒ…æ‹¬æ¯ä¸ªåŒ¹é…çš„åŠ è½½å™¨æ•°æ®ã€‚

ä¸ºäº†å¤åˆ¶ `parentsData` çš„ APIï¼Œ`@remix-run/v1-meta` åŒ…æä¾›äº†ä¸€ä¸ª `getMatchesData` å‡½æ•°ã€‚å®ƒè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­æ¯ä¸ªåŒ¹é…çš„æ•°æ®ä»¥è·¯ç”±çš„ ID ä¸ºé”®ã€‚

```tsx bad filename=app/routes/v1-route.tsx
export function meta(args) {
  const parentData = args.parentsData["routes/parent"];
}
```

å˜ä¸ºï¼š

```tsx filename=app/routes/v2-route.tsx good
import { getMatchesData } from "@remix-run/v1-meta";

export function meta(args) {
  const matchesData = getMatchesData(args);
  const parentData = matchesData["routes/parent"];
}
```

#### æ›´æ–°åˆ°æ–°çš„ `meta`

```tsx bad filename=app/routes/v1-route.tsx
export function meta() {
  return {
    title: "...",
    description: "...",
    "og:title": "...",
  };
}
```

```tsx filename=app/routes/v2-route.tsx good
export function meta() {
  return [
    { title: "..." },
    { name: "description", content: "..." },
    { property: "og:title", content: "..." },

    // æ‚¨ç°åœ¨å¯ä»¥æ·»åŠ ä¸ SEO ç›¸å…³çš„ <links>
    { tagName: "link", rel: "canonical", href: "..." },

    // ä»¥åŠ <script type=ld+json>
    {
      "script:ld+json": {
        some: "value",
      },
    },
  ];
}
```

#### `matches` å‚æ•°

è¯·æ³¨æ„ï¼Œåœ¨ v1 ä¸­ï¼ŒåµŒå¥—è·¯ç”±è¿”å›çš„å¯¹è±¡éƒ½æ˜¯åˆå¹¶çš„ï¼Œæ‚¨ç°åœ¨éœ€è¦ä½¿ç”¨ `matches` è‡ªè¡Œç®¡ç†åˆå¹¶ï¼š

```tsx filename=app/routes/v2-route.tsx good
export function meta({ matches }) {
  const rootMeta = matches[0].meta;
  const title = rootMeta.find((m) => m.title);

  return [
    title,
    { name: "description", content: "..." },
    { property: "og:title", content: "..." },

    // æ‚¨ç°åœ¨å¯ä»¥æ·»åŠ ä¸ SEO ç›¸å…³çš„ <links>
    { tagName: "link", rel: "canonical", href: "..." },

    // ä»¥åŠ <script type=ld+json>
    {
      "script:ld+json": {
        "@context": "https://schema.org",
        "@type": "Organization",
        name: "Remix",
      },
    },
  ];
}
```

[meta][meta] æ–‡æ¡£ä¸­è¿˜æœ‰æ›´å¤šå…³äºåˆå¹¶è·¯ç”± meta çš„æç¤ºã€‚

## `CatchBoundary` å’Œ `ErrorBoundary`

```js filename=remix.config.js
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  future: {
    v2_errorBoundary: true,
  },
};
```

åœ¨ v1 ä¸­ï¼ŒæŠ›å‡ºçš„ `Response` æ¸²æŸ“æœ€è¿‘çš„ `CatchBoundary`ï¼Œè€Œæ‰€æœ‰å…¶ä»–æœªå¤„ç†çš„å¼‚å¸¸æ¸²æŸ“ `ErrorBoundary`ã€‚åœ¨ v2 ä¸­æ²¡æœ‰ `CatchBoundary`ï¼Œæ‰€æœ‰æœªå¤„ç†çš„å¼‚å¸¸å°†æ¸²æŸ“ `ErrorBoundary`ï¼Œæ— è®ºæ˜¯å“åº”è¿˜æ˜¯å…¶ä»–ã€‚

æ­¤å¤–ï¼Œé”™è¯¯ä¸å†ä½œä¸º props ä¼ é€’ç»™ `ErrorBoundary`ï¼Œè€Œæ˜¯é€šè¿‡ `useRouteError` é’©å­è®¿é—®ã€‚

```tsx bad filename=app/routes/v1-route.tsx
import { useCatch } from "@remix-run/react";

export function CatchBoundary() {
  const caught = useCatch();

  return (
    <div>
      <h1>Oops</h1>
      <p>Status: {caught.status}</p>
      <p>{caught.data.message}</p>
    </div>
  );
}

export function ErrorBoundary({ error }) {
  console.error(error);
  return (
    <div>
      <h1>Uh oh ...</h1>
      <p>Something went wrong</p>
      <pre>{error.message || "Unknown error"}</pre>
    </div>
  );
}
```

å˜ä¸ºï¼š

```tsx filename=app/routes/v2-route.tsx good
import {
  useRouteError,
  isRouteErrorResponse,
} from "@remix-run/react";

export function ErrorBoundary() {
  const error = useRouteError();

  // å½“ä¸º true æ—¶ï¼Œè¿™å°±æ˜¯ä»¥å‰ä¼ é€’ç»™ `CatchBoundary` çš„å†…å®¹
  if (isRouteErrorResponse(error)) {
    return (
      <div>
        <h1>Oops</h1>
        <p>Status: {error.status}</p>
        <p>{error.data.message}</p>
      </div>
    );
  }

  // ä¸è¦å¿˜è®°æ ¹æ®è‡ªå·±çš„é€»è¾‘è¿›è¡Œç±»å‹æ£€æŸ¥ã€‚
  // ä»»ä½•å€¼éƒ½å¯ä»¥è¢«æŠ›å‡ºï¼Œä¸ä»…ä»…æ˜¯é”™è¯¯ï¼
  let errorMessage = "æœªçŸ¥é”™è¯¯";
  if (isDefinitelyAnError(error)) {
    errorMessage = error.message;
  }

  return (
    <div>
      <h1>Uh oh ...</h1>
      <p>å‡ºäº†ä¸€äº›é—®é¢˜ã€‚</p>
      <pre>{errorMessage}</pre>
    </div>
  );
}
```

## `formMethod`

```js filename=remix.config.js
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  future: {
    v2_normalizeFormMethod: true,
  },
};
```

å¤šä¸ª API è¿”å›æäº¤çš„ `formMethod`ã€‚åœ¨ v1 ä¸­ï¼Œå®ƒä»¬è¿”å›æ–¹æ³•çš„å°å†™ç‰ˆæœ¬ï¼Œä½†åœ¨ v2 ä¸­ï¼Œå®ƒä»¬è¿”å›å¤§å†™ç‰ˆæœ¬ã€‚è¿™æ˜¯ä¸ºäº†ä¸ HTTP å’Œ `fetch` è§„èŒƒä¿æŒä¸€è‡´ã€‚

```tsx
function Something() {
  const navigation = useNavigation();

  // v1
  navigation.formMethod === "post";

  // v2
  navigation.formMethod === "POST";
}

export function shouldRevalidate({ formMethod }) {
  // v1
  formMethod === "post";

  // v2
  formMethod === "POST";
}
```

## `useTransition`

è¿™ä¸ª hook ç°åœ¨è¢«ç§°ä¸º `useNavigation`ï¼Œä»¥é¿å…ä¸æœ€è¿‘åŒåçš„ React hook æ··æ·†ã€‚å®ƒä¹Ÿä¸å†åŒ…å« `type` å­—æ®µï¼Œå¹¶å°† `submission` å¯¹è±¡æ‰å¹³åŒ–åˆ° `navigation` å¯¹è±¡ä¸­ã€‚

```tsx bad filename=app/routes/v1-route.tsx
import { useTransition } from "@remix-run/react";

function SomeComponent() {
  const transition = useTransition();
  transition.submission.formData;
  transition.submission.formMethod;
  transition.submission.formAction;
  transition.type;
}
```

```tsx filename=app/routes/v2-route.tsx good
import { useNavigation } from "@remix-run/react";

function SomeComponent() {
  const navigation = useNavigation();

  // transition.submission keys are flattened onto `navigation[key]`
  navigation.formData;
  navigation.formMethod;
  navigation.formAction;

  // this key is removed
  navigation.type;
}
```

æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ç¤ºä¾‹æ¨å¯¼å‡ºä¹‹å‰çš„ `transition.type`ã€‚è¯·è®°ä½ï¼Œå¯èƒ½æœ‰æ›´ç®€å•çš„æ–¹æ³•æ¥è·å¾—ç›¸åŒçš„è¡Œä¸ºï¼Œé€šå¸¸æ£€æŸ¥ `navigation.state`ã€`navigation.formData` æˆ–é€šè¿‡ `useActionData` è¿”å›çš„æ•°æ®å¯ä»¥è·å¾—æ‚¨æ‰€æœŸæœ›çš„ç”¨æˆ·ä½“éªŒã€‚å¦‚æœ‰ç–‘é—®ï¼Œè¯·éšæ—¶åœ¨ Discord ä¸Šè¯¢é—®ï¼Œæˆ‘ä»¬ä¼šå¸®åŠ©æ‚¨ :D

```tsx
function Component() {
  const navigation = useNavigation();

  // transition.type === "actionSubmission"
  const isActionSubmission =
    navigation.state === "submitting";

  // transition.type === "actionReload"
  const isActionReload =
    navigation.state === "loading" &&
    navigation.formMethod != null &&
    navigation.formMethod != "GET" &&
    // We had a submission navigation and are loading the submitted location
    navigation.formAction === navigation.location.pathname;

  // transition.type === "actionRedirect"
  const isActionRedirect =
    navigation.state === "loading" &&
    navigation.formMethod != null &&
    navigation.formMethod != "GET" &&
    // We had a submission navigation and are now navigating to different location
    navigation.formAction !== navigation.location.pathname;

  // transition.type === "loaderSubmission"
  const isLoaderSubmission =
    navigation.state === "loading" &&
    navigation.state.formMethod === "GET" &&
    // We had a loader submission and are navigating to the submitted location
    navigation.formAction === navigation.location.pathname;

  // transition.type === "loaderSubmissionRedirect"
  const isLoaderSubmissionRedirect =
    navigation.state === "loading" &&
    navigation.state.formMethod === "GET" &&
    // We had a loader submission and are navigating to a new location
    navigation.formAction !== navigation.location.pathname;
}
```

**å…³äº GET æäº¤çš„è¯´æ˜**

åœ¨ Remix v1 ä¸­ï¼ŒGET æäº¤ï¼Œå¦‚ `<Form method="get">` æˆ– `submit({}, { method: 'get' })`ï¼Œåœ¨ `transition.state` ä¸­ç»å†äº† `idle -> submitting -> idle`ã€‚è¿™åœ¨è¯­ä¹‰ä¸Šå¹¶ä¸å®Œå…¨æ­£ç¡®ï¼Œå› ä¸ºå³ä½¿æ‚¨æ­£åœ¨â€œæäº¤â€ä¸€ä¸ªè¡¨å•ï¼Œæ‚¨å®é™…ä¸Šæ˜¯åœ¨æ‰§è¡Œä¸€ä¸ª GET å¯¼èˆªï¼Œå¹¶ä¸”åªåœ¨æ‰§è¡ŒåŠ è½½å™¨ï¼ˆè€Œä¸æ˜¯æ“ä½œï¼‰ã€‚åœ¨åŠŸèƒ½ä¸Šï¼Œè¿™ä¸ `<Link>` æˆ– `navigate()` æ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯ç”¨æˆ·å¯èƒ½é€šè¿‡è¾“å…¥æŒ‡å®šæœç´¢å‚æ•°å€¼ã€‚

åœ¨ v2 ä¸­ï¼ŒGET æäº¤æ›´å‡†ç¡®åœ°åæ˜ ä¸ºåŠ è½½å¯¼èˆªï¼Œå› æ­¤çŠ¶æ€å˜ä¸º `idle -> loading -> idle`ï¼Œä»¥ä½¿ `navigation.state` ä¸æ™®é€šé“¾æ¥çš„è¡Œä¸ºä¿æŒä¸€è‡´ã€‚å¦‚æœæ‚¨çš„ GET æäº¤æ¥è‡ª `<Form>` æˆ– `submit()`ï¼Œé‚£ä¹ˆ `useNavigation.form*` å°†ä¼šè¢«å¡«å……ï¼Œå› æ­¤æ‚¨å¯ä»¥åœ¨éœ€è¦æ—¶è¿›è¡ŒåŒºåˆ†ã€‚

## `useFetcher`

ä¸ `useNavigation` ç±»ä¼¼ï¼Œ`useFetcher` å·²ç»æ‰å¹³åŒ–äº† `submission` å¹¶ç§»é™¤äº† `type` å­—æ®µã€‚

```tsx bad filename=app/routes/v1-route.tsx
import { useFetcher } from "@remix-run/react";

function SomeComponent() {
  const fetcher = useFetcher();
  fetcher.submission.formData;
  fetcher.submission.formMethod;
  fetcher.submission.formAction;
  fetcher.type;
}
```

```tsx filename=app/routes/v2-route.tsx good
import { useFetcher } from "@remix-run/react";

function SomeComponent() {
  const fetcher = useFetcher();

  // è¿™äº›é”®å·²è¢«æ‰å¹³åŒ–
  fetcher.formData;
  fetcher.formMethod;
  fetcher.formAction;

  // æ­¤é”®å·²è¢«ç§»é™¤
  fetcher.type;
}
```

æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ç¤ºä¾‹æ¨å¯¼å‡ºä¹‹å‰çš„ `fetcher.type`ã€‚è¯·è®°ä½ï¼Œå¯èƒ½æœ‰æ›´ç®€å•çš„æ–¹æ³•æ¥è·å¾—ç›¸åŒçš„è¡Œä¸ºï¼Œé€šå¸¸æ£€æŸ¥ `fetcher.state`ã€`fetcher.formData` æˆ–ä» `fetcher.data` è¿”å›çš„æ•°æ®å¯ä»¥è·å¾—æ‚¨æƒ³è¦çš„ç”¨æˆ·ä½“éªŒã€‚å¦‚æœ‰ç–‘é—®ï¼Œè¯·éšæ—¶åœ¨ Discord ä¸Šè¯¢é—®ï¼Œæˆ‘ä»¬ä¼šå¸®åŠ©æ‚¨ :D

```tsx
function Component() {
  const fetcher = useFetcher();

  // fetcher.type === "init"
  const isInit =
    fetcher.state === "idle" && fetcher.data == null;

  // fetcher.type === "done"
  const isDone =
    fetcher.state === "idle" && fetcher.data != null;

  // fetcher.type === "actionSubmission"
  const isActionSubmission = fetcher.state === "submitting";

  // fetcher.type === "actionReload"
  const isActionReload =
    fetcher.state === "loading" &&
    fetcher.formMethod != null &&
    fetcher.formMethod != "GET" &&
    // å¦‚æœæˆ‘ä»¬è¿”å›äº†æ•°æ®ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨é‡æ–°åŠ è½½
    fetcher.data != null;

  // fetcher.type === "actionRedirect"
  const isActionRedirect =
    fetcher.state === "loading" &&
    fetcher.formMethod != null &&
    fetcher.formMethod != "GET" &&
    // å¦‚æœæˆ‘ä»¬æ²¡æœ‰æ•°æ®ï¼Œæˆ‘ä»¬å¿…é¡»å·²ç»é‡å®šå‘
    fetcher.data == null;

  // fetcher.type === "loaderSubmission"
  const isLoaderSubmission =
    fetcher.state === "loading" &&
    fetcher.formMethod === "GET";

  // fetcher.type === "normalLoad"
  const isNormalLoad =
    fetcher.state === "loading" &&
    fetcher.formMethod == null;
}
```

**å…³äº GET æäº¤çš„è¯´æ˜**

åœ¨ Remix v1 ä¸­ï¼ŒGET æäº¤å¦‚ `<fetcher.Form method="get">` æˆ– `fetcher.submit({}, { method: 'get' })` åœ¨ `fetcher.state` ä¸­çš„å˜åŒ–ä¸º `idle -> submitting -> idle`ã€‚è¿™åœ¨è¯­ä¹‰ä¸Šå¹¶ä¸å®Œå…¨æ­£ç¡®ï¼Œå› ä¸ºå³ä½¿æ‚¨æ­£åœ¨â€œæäº¤â€è¡¨å•ï¼Œæ‚¨å®é™…ä¸Šæ˜¯åœ¨æ‰§è¡Œ GET è¯·æ±‚å¹¶ä»…æ‰§è¡ŒåŠ è½½å™¨ï¼ˆè€Œä¸æ˜¯åŠ¨ä½œï¼‰ã€‚åŠŸèƒ½ä¸Šï¼Œå®ƒä¸ `fetcher.load()` æ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯ç”¨æˆ·å¯èƒ½é€šè¿‡è¾“å…¥æŒ‡å®šæœç´¢å‚æ•°å€¼ã€‚

åœ¨ v2 ä¸­ï¼ŒGET æäº¤æ›´å‡†ç¡®åœ°åæ˜ ä¸ºåŠ è½½è¯·æ±‚ï¼Œå› æ­¤çŠ¶æ€å˜åŒ–ä¸º `idle -> loading -> idle`ï¼Œä»¥ä½¿ `fetcher.state` ä¸æ­£å¸¸ fetcher åŠ è½½çš„è¡Œä¸ºä¿æŒä¸€è‡´ã€‚å¦‚æœæ‚¨çš„ GET æäº¤æ¥è‡ª `<fetcher.Form>` æˆ– `fetcher.submit()`ï¼Œé‚£ä¹ˆ `fetcher.form*` å°†è¢«å¡«å……ï¼Œå› æ­¤æ‚¨å¯ä»¥åœ¨éœ€è¦æ—¶è¿›è¡ŒåŒºåˆ†ã€‚

## Links `imagesizes` å’Œ `imagesrcset`

è·¯ç”± `links` å±æ€§åº”å…¨éƒ¨ä½¿ç”¨ React çš„ camelCase å€¼ï¼Œè€Œä¸æ˜¯ HTML çš„å°å†™å€¼ã€‚è¿™ä¸¤ä¸ªå€¼åœ¨ v1 ä¸­è¢«é”™è¯¯åœ°ä»¥å°å†™å½¢å¼å¼•å…¥ã€‚åœ¨ v2 ä¸­ï¼Œä»… camelCase ç‰ˆæœ¬æ˜¯æœ‰æ•ˆçš„ï¼š

```tsx bad filename=app/routes/v1-route.tsx
export const links: LinksFunction = () => {
  return [
    {
      rel: "preload",
      as: "image",
      imagesrcset: "...",
      imagesizes: "...",
    },
  ];
};
```

```tsx filename=app/routes/v2-route.tsx good
export const links: V2_LinksFunction = () => {
  return [
    {
      rel: "preload",
      as: "image",
      imageSrcSet: "...",
      imageSizes: "...",
    },
  ];
};
```

## `browserBuildDirectory`

åœ¨æ‚¨çš„ `remix.config.js` ä¸­ï¼Œå°† `browserBuildDirectory` é‡å‘½åä¸º `assetsBuildDirectory`ã€‚

```js bad filename=remix.config.js lines=[3]
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  browserBuildDirectory: "./public/build",
};
```

```js filename=remix.config.js good lines=[3]
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  assetsBuildDirectory: "./public/build",
};
```

## `devServerBroadcastDelay`

ä»æ‚¨çš„ `remix.config.js` ä¸­ç§»é™¤ `devServerBroadcastDelay`ï¼Œå› ä¸ºåœ¨ v2 æˆ– `v2_dev` ä¸­å·²æ¶ˆé™¤äº†éœ€è¦æ­¤é€‰é¡¹çš„ç«äº‰æ¡ä»¶ã€‚

```diff filename=remix.config.js
  /** @type {import('@remix-run/dev').AppConfig} */
  module.exports = {
-   devServerBroadcastDelay: 300,
  };
```

## `devServerPort`

åœ¨æ‚¨çš„ `remix.config.js` ä¸­ï¼Œå°† `devServerPort` é‡å‘½åä¸º `future.v2_dev.port`ã€‚

```js bad filename=remix.config.js lines=[3]
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  devServerPort: 8002,
};
```

```js filename=remix.config.js good lines=[3-7]
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  // åœ¨ v1.x ç‰ˆæœ¬ä¸­ï¼Œè¿™æ˜¯é€šè¿‡ä¸€ä¸ªæœªæ¥æ ‡å¿—å®ç°çš„
  future: {
    v2_dev: {
      port: 8002,
    },
  },
};
```

ä¸€æ—¦æ‚¨ä» v1 å‡çº§åˆ° v2ï¼Œè¿™å°†æ‰å¹³åŒ–ä¸ºä¸€ä¸ª [æ ¹çº§åˆ«çš„ `dev` é…ç½®][dev-after-upgrading]ã€‚

## `serverBuildDirectory`

åœ¨æ‚¨çš„ `remix.config.js` ä¸­ï¼Œå°† `serverBuildDirectory` é‡å‘½åä¸º `serverBuildPath`ï¼Œå¹¶æŒ‡å®šä¸€ä¸ªæ¨¡å—è·¯å¾„ï¼Œè€Œä¸æ˜¯ç›®å½•ã€‚

```js bad filename=remix.config.js lines=[3]
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  serverBuildDirectory: "./build",
};
```

```js filename=remix.config.js good lines=[3]
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  serverBuildPath: "./build/index.js",
};
```

Remix ä»¥å‰ä¸ºæœåŠ¡å™¨åˆ›å»ºå¤šä¸ªæ¨¡å—ï¼Œä½†ç°åœ¨åªåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ã€‚

## `serverBuildTarget`

ä¸å†æŒ‡å®šæ„å»ºç›®æ ‡ï¼Œè€Œæ˜¯ä½¿ç”¨ [`remix.config.js`][remix_config] é€‰é¡¹æ¥ç”Ÿæˆæ‚¨çš„æœåŠ¡å™¨ç›®æ ‡æ‰€éœ€çš„æœåŠ¡å™¨æ„å»ºã€‚æ­¤æ›´æ”¹å…è®¸ Remix éƒ¨ç½²åˆ°æ›´å¤šçš„ JavaScript è¿è¡Œæ—¶ã€æœåŠ¡å™¨å’Œä¸»æœºï¼Œè€Œæ— éœ€ Remix æºä»£ç äº†è§£å®ƒä»¬ã€‚

ä»¥ä¸‹é…ç½®åº”æ›¿æ¢æ‚¨å½“å‰çš„ `serverBuildTarget`ï¼š

#### `arc`

```js filename=remix.config.js
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  publicPath: "/_static/build/",
  serverBuildPath: "server/index.js",
  serverMainFields: ["main", "module"], // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
  serverMinify: false, // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
  serverModuleFormat: "cjs", // 1.x ä¸­çš„é»˜è®¤å€¼ï¼Œå‡çº§å‰æ·»åŠ 
  serverPlatform: "node", // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
};
```

#### `cloudflare-pages`

```js filename=remix.config.js
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  publicPath: "/build/", // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
  serverBuildPath: "functions/[[path]].js",
  serverConditions: ["worker"],
  serverDependenciesToBundle: "all",
  serverMainFields: ["browser", "module", "main"],
  serverMinify: true,
  serverModuleFormat: "esm", // 2.x ä¸­çš„é»˜è®¤å€¼ï¼Œå‡çº§åå¯ä»¥åˆ é™¤
  serverPlatform: "neutral",
};
```

#### `cloudflare-workers`

```js filename=remix.config.js
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  publicPath: "/build/", // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
  serverBuildPath: "build/index.js", // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
  serverConditions: ["worker"],
  serverDependenciesToBundle: "all",
  serverMainFields: ["browser", "module", "main"],
  serverMinify: true,
  serverModuleFormat: "esm", // 2.x ä¸­çš„é»˜è®¤å€¼ï¼Œå‡çº§åå¯ä»¥åˆ é™¤
  serverPlatform: "neutral",
};
```

#### `deno`

```js filename=remix.config.js
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  publicPath: "/build/", // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
  serverBuildPath: "build/index.js", // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
  serverConditions: ["deno", "worker"],
  serverDependenciesToBundle: "all",
  serverMainFields: ["module", "main"],
  serverMinify: false, // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
  serverModuleFormat: "esm", // 2.x ä¸­çš„é»˜è®¤å€¼ï¼Œå‡çº§åå¯ä»¥åˆ é™¤
  serverPlatform: "neutral",
};
```

#### `node-cjs`

```js filename=remix.config.js
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  publicPath: "/build/", // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
  serverBuildPath: "build/index.js", // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
  serverMainFields: ["main", "module"], // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
  serverMinify: false, // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
  serverModuleFormat: "cjs", // 1.x ä¸­çš„é»˜è®¤å€¼ï¼Œå‡çº§å‰æ·»åŠ 
  serverPlatform: "node", // é»˜è®¤å€¼ï¼Œå¯ä»¥åˆ é™¤
};
```

## `serverModuleFormat`

é»˜è®¤çš„æœåŠ¡å™¨æ¨¡å—è¾“å‡ºæ ¼å¼å·²ä» `cjs` æ›´æ”¹ä¸º `esm`ã€‚æ‚¨å¯ä»¥åœ¨ v2 ä¸­ç»§ç»­ä½¿ç”¨ CJSï¼Œæ‚¨çš„åº”ç”¨ä¸­çš„è®¸å¤šä¾èµ–é¡¹å¯èƒ½ä¸ ESM ä¸å…¼å®¹ã€‚

åœ¨æ‚¨çš„ `remix.config.js` ä¸­ï¼Œæ‚¨åº”è¯¥æŒ‡å®š `serverModuleFormat: "cjs"` ä»¥ä¿æŒç°æœ‰è¡Œä¸ºï¼Œæˆ–æŒ‡å®š `serverModuleFormat: "esm"` ä»¥é€‰æ‹©æ–°çš„è¡Œä¸ºã€‚

## `browserNodeBuiltinsPolyfill`

Node.js å†…ç½®æ¨¡å—çš„ polyfills é»˜è®¤ä¸å†ä¸ºæµè§ˆå™¨æä¾›ã€‚åœ¨ Remix v2 ä¸­ï¼Œæ‚¨éœ€è¦æ ¹æ®éœ€è¦æ˜¾å¼é‡æ–°å¼•å…¥ä»»ä½• polyfillsï¼ˆæˆ–ç©ºçš„ polyfillsï¼‰ï¼š

```js filename=remix.config.js
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  browserNodeBuiltinsPolyfill: {
    modules: {
      buffer: true,
      fs: "empty",
    },
    globals: {
      Buffer: true,
    },
  },
};
```

å°½ç®¡æˆ‘ä»¬å»ºè®®æ˜ç¡®å…è®¸å“ªäº› polyfills åœ¨æ‚¨çš„æµè§ˆå™¨åŒ…ä¸­ï¼Œç‰¹åˆ«æ˜¯å› ä¸ºæŸäº› polyfills å¯èƒ½ç›¸å½“å¤§ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®å¿«é€Ÿæ¢å¤ Remix v1 çš„å®Œæ•´ polyfills é›†ï¼š

```js filename=remix.config.js
const { builtinModules } = require("node:module");

/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  browserNodeBuiltinsPolyfill: {
    modules: builtinModules,
  },
};
```

## `serverNodeBuiltinsPolyfill`

Node.js å†…ç½®æ¨¡å—çš„ Polyfills ä¸å†é»˜è®¤ä¸ºé Node.js æœåŠ¡å™¨å¹³å°æä¾›ã€‚

å¦‚æœæ‚¨æ­£åœ¨é’ˆå¯¹é Node.js æœåŠ¡å™¨å¹³å°ï¼Œå¹¶å¸Œæœ›åœ¨ v1 ä¸­é€‰æ‹©æ–°çš„é»˜è®¤è¡Œä¸ºï¼Œåœ¨ `remix.config.js` ä¸­ï¼Œæ‚¨åº”é¦–å…ˆé€šè¿‡æ˜¾å¼æä¾›ä¸€ä¸ªç©ºå¯¹è±¡æ¥ç§»é™¤æ‰€æœ‰æœåŠ¡å™¨ polyfillsï¼Œé’ˆå¯¹ `serverNodeBuiltinsPolyfill.modules`ï¼š

```js filename=remix.config.js
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  serverNodeBuiltinsPolyfill: {
    modules: {},
  },
};
```

ç„¶åï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦é‡æ–°å¼•å…¥ä»»ä½• polyfillsï¼ˆæˆ–ç©ºçš„ polyfillsï¼‰ã€‚

```js filename=remix.config.js
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  serverNodeBuiltinsPolyfill: {
    modules: {
      buffer: true,
      fs: "empty",
    },
    globals: {
      Buffer: true,
    },
  },
};
```

ä½œä¸ºå‚è€ƒï¼Œå¯ä»¥æ‰‹åŠ¨æŒ‡å®š v1 çš„å®Œæ•´é»˜è®¤ polyfills é›†åˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```js filename=remix.config.js
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  serverNodeBuiltinsPolyfill: {
    modules: {
      _stream_duplex: true,
      _stream_passthrough: true,
      _stream_readable: true,
      _stream_transform: true,
      _stream_writable: true,
      assert: true,
      "assert/strict": true,
      buffer: true,
      console: true,
      constants: true,
      crypto: "empty",
      diagnostics_channel: true,
      domain: true,
      events: true,
      fs: "empty",
      "fs/promises": "empty",
      http: true,
      https: true,
      module: true,
      os: true,
      path: true,
      "path/posix": true,
      "path/win32": true,
      perf_hooks: true,
      process: true,
      punycode: true,
      querystring: true,
      stream: true,
      "stream/promises": true,
      "stream/web": true,
      string_decoder: true,
      sys: true,
      timers: true,
      "timers/promises": true,
      tty: true,
      url: true,
      util: true,
      "util/types": true,
      vm: true,
      wasi: true,
      worker_threads: true,
      zlib: true,
    },
  },
};
```

## `installGlobals`

ä¸ºäº†å‡†å¤‡ä½¿ç”¨ Node å†…ç½®çš„ fetch å®ç°ï¼Œå®‰è£… fetch å…¨å±€å˜é‡ç°åœ¨æ˜¯åº”ç”¨æœåŠ¡å™¨çš„è´£ä»»ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ `remix-serve`ï¼Œåˆ™æ— éœ€ä»»ä½•æ“ä½œã€‚å¦‚æœæ‚¨ä½¿ç”¨è‡ªå·±çš„åº”ç”¨æœåŠ¡å™¨ï¼Œåˆ™éœ€è¦è‡ªå·±å®‰è£…å…¨å±€å˜é‡ã€‚

```ts filename=server.ts
import { installGlobals } from "@remix-run/node";

installGlobals();
```

### ç§»é™¤å¯¼å‡ºçš„ polyfills

Remix v2 ä¹Ÿä¸å†ä» `@remix-run/node` å¯¼å‡ºè¿™äº› polyfill å®ç°ï¼Œæ‚¨åº”è¯¥ç›´æ¥ä½¿ç”¨å…¨å±€å‘½åç©ºé—´ä¸­çš„å®ä¾‹ã€‚ä¸€ä¸ªå¯èƒ½éœ€è¦æ›´æ”¹çš„åœ°æ–¹æ˜¯æ‚¨çš„ `app/entry.server.tsx` æ–‡ä»¶ï¼Œåœ¨è¿™é‡Œæ‚¨è¿˜éœ€è¦é€šè¿‡ `createReadableStreamFromReadable` å°† Node çš„ [`PassThrough`][pass_through_class] è½¬æ¢ä¸º Web çš„ [`ReadableStream`][readable_stream]ï¼š

```diff filename=app/entry.server.tsx
  import { PassThrough } from "node:stream";
  import type { AppLoadContext, EntryContext } from "@remix-run/node"; // æˆ– cloudflare/deno
- import { Response } from "@remix-run/node"; // æˆ– cloudflare/deno
+ import { createReadableStreamFromReadable } from "@remix-run/node"; // æˆ– cloudflare/deno
  import { RemixServer } from "@remix-run/react";
  import { isbot } from "isbot";
  import { renderToPipeableStream } from "react-dom/server";

  const ABORT_DELAY = 5_000;

  export default function handleRequest({ /* ... */ }) { ... }

  function handleBotRequest(...) {
    return new Promise((resolve, reject) => {
      let shellRendered = false;
      const { pipe, abort } = renderToPipeableStream(
        <RemixServer ... />,
        {
          onAllReady() {
            shellRendered = true;
            const body = new PassThrough();

            responseHeaders.set("Content-Type", "text/html");

            resolve(
-             new Response(body, {
+             new Response(createReadableStreamFromReadable(body), {
                headers: responseHeaders,
                status: responseStatusCode,
              })
            );

            pipe(body);
          },
          ...
          onShellError(error: unknown) { ... }
          onError(error: unknown) { ... }
        }
      );

      setTimeout(abort, ABORT_DELAY);
    });
  }

  function handleBrowserRequest(...) {
    return new Promise((resolve, reject) => {
      let shellRendered = false;
      const { pipe, abort } = renderToPipeableStream(
        <RemixServer ... />,
        {
          onShellReady() {
            shellRendered = true;
            const body = new PassThrough();

            responseHeaders.set("Content-Type", "text/html");

            resolve(
-              new Response(body, {
+              new Response(createReadableStreamFromReadable(body), {
                headers: responseHeaders,
                status: responseStatusCode,
              })
            );

            pipe(body);
          },
          onShellError(error: unknown) { ... },
          onError(error: unknown) { ... },
        }
      );

      setTimeout(abort, ABORT_DELAY);
    });
  }
```

## `source-map-support`

æºæ˜ å°„æ”¯æŒç°åœ¨ç”±åº”ç”¨æœåŠ¡å™¨è´Ÿè´£ã€‚å¦‚æœæ‚¨ä½¿ç”¨ `remix-serve`ï¼Œåˆ™æ— éœ€ä»»ä½•æ“ä½œã€‚å¦‚æœæ‚¨ä½¿ç”¨è‡ªå·±çš„åº”ç”¨æœåŠ¡å™¨ï¼Œåˆ™éœ€è¦è‡ªè¡Œå®‰è£… [`source-map-support`][source-map-support]ã€‚

```shellscript nonumber
npm i source-map-support
```

```ts filename=server.ts
import sourceMapSupport from "source-map-support";

sourceMapSupport.install();
```

## Netlify é€‚é…å™¨

`@remix-run/netlify` è¿è¡Œæ—¶é€‚é…å™¨å·²è¢«å¼ƒç”¨ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯
[`@netlify/remix-adapter`][official-netlify-adapter] å’Œ [`@netlify/remix-edge-adapter`][official-netlify-edge-adapter]ï¼Œ
å¹¶ä¸”ä» Remix v2 å¼€å§‹å·²è¢«ç§»é™¤ã€‚è¯·é€šè¿‡å°†æ‰€æœ‰ `@remix-run/netlify` å¯¼å…¥æ›´æ”¹ä¸º
`@netlify/remix-adapter` æ¥æ›´æ–°æ‚¨çš„ä»£ç ã€‚\
è¯·æ³¨æ„ï¼Œ`@netlify/remix-adapter` éœ€è¦ `@netlify/functions@^1.0.0`ï¼Œè¿™ä¸å½“å‰æ”¯æŒçš„ `@remix-run/netlify` ä¸­çš„ `@netlify/functions` ç‰ˆæœ¬ç›¸æ¯”æ˜¯ä¸€ä¸ªé‡å¤§å˜åŒ–ã€‚

ç”±äºæ­¤é€‚é…å™¨çš„ç§»é™¤ï¼Œæˆ‘ä»¬è¿˜ç§»é™¤äº†æˆ‘ä»¬çš„ [Netlify æ¨¡æ¿][netlify-template]ï¼Œä»¥æ”¯æŒ
[å®˜æ–¹ Netlify æ¨¡æ¿][official-netlify-template]ã€‚

## Vercel é€‚é…å™¨

`@remix-run/vercel` è¿è¡Œæ—¶é€‚é…å™¨å·²è¢«å¼ƒç”¨ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å¼€ç®±å³ç”¨çš„ Vercel åŠŸèƒ½ï¼Œå¹¶å·²åœ¨ Remix v2 ä¸­ç§»é™¤ã€‚è¯·é€šè¿‡ä»æ‚¨çš„ `package.json` ä¸­åˆ é™¤ `@remix-run/vercel` å’Œ `@vercel/node`ï¼Œåˆ é™¤æ‚¨çš„ `server.js`/`server.ts` æ–‡ä»¶ï¼Œä»¥åŠä»æ‚¨çš„ `remix.config.js` ä¸­åˆ é™¤ `server` å’Œ `serverBuildPath` é€‰é¡¹æ¥æ›´æ–°æ‚¨çš„ä»£ç ã€‚

ç”±äºæ­¤é€‚é…å™¨çš„ç§»é™¤ï¼Œæˆ‘ä»¬è¿˜ç§»é™¤äº†æˆ‘ä»¬çš„ [Vercel æ¨¡æ¿][vercel-template]ï¼Œè½¬è€Œä½¿ç”¨ [å®˜æ–¹ Vercel æ¨¡æ¿][official-vercel-template]ã€‚

## å†…ç½® PostCSS/Tailwind æ”¯æŒ

åœ¨ v2 ä¸­ï¼Œå¦‚æœæ‚¨çš„é¡¹ç›®ä¸­å­˜åœ¨ PostCSS å’Œ/æˆ– Tailwind é…ç½®æ–‡ä»¶ï¼Œè¿™äº›å·¥å…·å°†åœ¨ Remix ç¼–è¯‘å™¨ä¸­è‡ªåŠ¨ä½¿ç”¨ã€‚

å¦‚æœæ‚¨æœ‰ä¸€ä¸ªè‡ªå®šä¹‰çš„ PostCSS å’Œ/æˆ– Tailwind è®¾ç½®ï¼Œå¸Œæœ›åœ¨è¿ç§»åˆ° v2 æ—¶ä¿æŒï¼Œå¯ä»¥åœ¨æ‚¨çš„ `remix.config.js` ä¸­ç¦ç”¨è¿™äº›åŠŸèƒ½ã€‚

```js filename=remix.config.js
/** @type {import('@remix-run/dev').AppConfig} */
module.exports = {
  postcss: false,
  tailwind: false,
};
```

## æ•…éšœæ’é™¤

### ESM / CommonJS é”™è¯¯

```sh
"SyntaxError: Named export '<something>' not found. The requested module '<something>' is a CommonJS module, which may not support all module.exports as named exports."
```

è¯·å‚è§ [`serverModuleFormat`][server-module-format] éƒ¨åˆ†ã€‚

[classic-remix-compiler]: ../guides/vite#classic-remix-compiler-vs-remix-vite
[remix-vite]: ../guides/vite
[future-flags]: ./future-flags
[remix_config]: ../file-conventions/remix-config
[pass_through_class]: https://nodejs.org/api/stream.html#class-streampassthrough
[readable_stream]: https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream
[flat-routes]: https://github.com/remix-run/remix/discussions/4482
[meta]: ../route/meta
[meta-v2-rfc]: https://github.com/remix-run/remix/discussions/4462
[meta-v2-matches]: #the-matches-argument
[templates]: https://github.com/remix-run/remix/tree/main/templates
[dev-docs]: ../other-api/dev
[manual-mode]: ../guides/manual-mode
[source-map-support]: https://npm.im/source-map-support
[official-netlify-adapter]: https://github.com/netlify/remix-compute/tree/main/packages/remix-adapter
[official-netlify-edge-adapter]: https://github.com/netlify/remix-compute/tree/main/packages/remix-edge-adapter
[netlify-template]: https://github.com/remix-run/remix/tree/main/templates/netlify
[official-netlify-template]: https://github.com/netlify/remix-template
[vercel-template]: https://github.com/remix-run/remix/tree/main/templates/vercel
[official-vercel-template]: https://github.com/vercel/vercel/tree/main/examples/remix
[troubleshooting]: #troubleshooting
[server-module-format]: #servermoduleformat
[2-min-to-v2]: https://twitter.com/BrooksLybrand/status/1704265835546578989
[dev-after-upgrading]: #after-upgrading-from-v1-to-v2