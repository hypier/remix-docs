---
title: åº”ç”¨æ•™ç¨‹ï¼ˆé•¿ï¼‰
position: 4
hidden: true
---

# ç¬‘è¯åº”ç”¨æ•™ç¨‹

<docs-warning>æœ¬æ•™ç¨‹ç›®å‰å‡è®¾æ‚¨ä½¿ç”¨çš„æ˜¯[Classic Remix Compiler][classic-remix-compiler]è€Œä¸æ˜¯[Remix Vite][remix-vite]ã€‚</docs-warning>

æƒ³å­¦ä¹ Remixå—ï¼Ÿæ‚¨æ¥å¯¹åœ°æ–¹äº†ã€‚è®©æˆ‘ä»¬æ¥æ„å»º[Remix Jokes][remix-jokes]ï¼

<docs-info><a target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/watch?v=hsIWJpuxNj0">åœ¨è¿™ä¸ªç›´æ’­ä¸­ä¸Kentä¸€èµ·å®Œæˆæœ¬æ•™ç¨‹</a></docs-info>

<a href="https://remix-jokes.lol"><img src="https://remix-jokes.lol/social.png" style="aspect-ratio: 300 / 157; width: 100%"/></a>

æœ¬æ•™ç¨‹æ˜¯å…¨é¢äº†è§£Remixä¸­å¯ç”¨ä¸»è¦APIçš„æ–¹å¼ã€‚åˆ°æœ€åï¼Œæ‚¨å°†æ‹¥æœ‰ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥å±•ç¤ºç»™æ‚¨çš„å¦ˆå¦ˆã€ä¼´ä¾£æˆ–ç‹—ï¼Œæˆ‘ç›¸ä¿¡ä»–ä»¬ä¼šå’Œæ‚¨ä¸€æ ·å¯¹Remixæ„Ÿåˆ°å…´å¥‹ï¼ˆè™½ç„¶æˆ‘ä¸åšä»»ä½•ä¿è¯ï¼‰ã€‚

æˆ‘ä»¬å°†ä¸“æ³¨äºRemixã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å°†è·³è¿‡ä¸€äº›ä¸æˆ‘ä»¬å¸Œæœ›æ‚¨å­¦ä¹ çš„Remixæ ¸å¿ƒç†å¿µæ— å…³çš„å†…å®¹ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä¼šå‘æ‚¨å±•ç¤ºå¦‚ä½•åœ¨é¡µé¢ä¸Šè·å–CSSæ ·å¼è¡¨ï¼Œä½†æˆ‘ä»¬ä¸ä¼šè®©æ‚¨è‡ªå·±ç¼–å†™æ ·å¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¼šç»™æ‚¨ä¸€äº›å¯ä»¥å¤åˆ¶/ç²˜è´´çš„å†…å®¹ã€‚ä¸è¿‡ï¼Œå¦‚æœæ‚¨æ›´å–œæ¬¢è‡ªå·±å†™ï¼Œé‚£ä¹Ÿæ˜¯å®Œå…¨å¯ä»¥çš„ï¼ˆåªæ˜¯ä¼šèŠ±è´¹æ‚¨æ›´å¤šæ—¶é—´ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬ä¼šæŠŠå®ƒæ”¾åœ¨å°çš„`<details>`å…ƒç´ ä¸­ï¼Œæ‚¨éœ€è¦ç‚¹å‡»ä»¥å±•å¼€ï¼Œä»¥å…ç ´åä»»ä½•å†…å®¹ï¼Œå¦‚æœæ‚¨æ›´å–œæ¬¢è‡ªå·±ç¼–ç çš„è¯ã€‚

<details>

<summary>ç‚¹å‡»æˆ‘</summary>

åœ¨æ•™ç¨‹ä¸­æœ‰å‡ ä¸ªåœ°æ–¹æˆ‘ä»¬å°†ä»£ç æ”¾åœ¨è¿™äº›`<details>`å…ƒç´ åé¢ã€‚è¿™æ˜¯ä¸ºäº†è®©æ‚¨é€‰æ‹©æƒ³è¦è¿›è¡Œå¤šå°‘å¤åˆ¶/ç²˜è´´ï¼Œè€Œä¸ä¼šè¢«æˆ‘ä»¬ç ´åã€‚æˆ‘ä»¬ä¸å»ºè®®æ‚¨åœ¨ä¸Remixæ— å…³çš„æ¦‚å¿µä¸ŠæŒ£æ‰ï¼Œæ¯”å¦‚çŒœæµ‹ä½¿ç”¨ä»€ä¹ˆç±»åã€‚å®Œæˆæ•™ç¨‹çš„ä¸»è¦å†…å®¹åï¼Œéšæ—¶å¯ä»¥å‚è€ƒè¿™äº›éƒ¨åˆ†æ¥æ£€æŸ¥æ‚¨çš„å·¥ä½œã€‚æˆ–è€…å¦‚æœæ‚¨æƒ³å¿«é€Ÿæµè§ˆï¼Œä¹Ÿå¯ä»¥åœ¨è¿›è¡Œæ—¶ç›´æ¥å¤åˆ¶/ç²˜è´´å†…å®¹ã€‚æˆ‘ä»¬ä¸ä¼šå¯¹æ‚¨è¿›è¡Œè¯„åˆ¤ï¼

</details>

åœ¨æ•´ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†é“¾æ¥åˆ°å„ç§æ–‡æ¡£ï¼ˆåŒ…æ‹¬Remixæ–‡æ¡£ä»¥åŠå…³äº[MDN][mdn]çš„ç½‘é¡µæ–‡æ¡£ï¼‰ï¼ˆå¦‚æœæ‚¨è¿˜æ²¡æœ‰ä½¿ç”¨MDNï¼Œæ‚¨ä¼šå‘ç°è‡ªå·±åœ¨ä½¿ç”¨Remixæ—¶ä¼šä½¿ç”¨å®ƒå¾ˆå¤šï¼Œå¹¶ä¸”åœ¨æ­¤è¿‡ç¨‹ä¸­æé«˜æ‚¨çš„ç½‘é¡µæŠ€èƒ½ï¼‰ã€‚å¦‚æœæ‚¨é‡åˆ°å›°éš¾ï¼Œè¯·ç¡®ä¿æŸ¥çœ‹æ‚¨å¯èƒ½è·³è¿‡çš„ä»»ä½•æ–‡æ¡£é“¾æ¥ã€‚æœ¬æ•™ç¨‹çš„éƒ¨åˆ†ç›®æ ‡æ˜¯è®©æ‚¨ç†Ÿæ‚‰Remixå’Œç½‘é¡µAPIæ–‡æ¡£ï¼Œå› æ­¤å¦‚æœæ–‡æ¡£ä¸­æœ‰è§£é‡Šçš„å†…å®¹ï¼Œæ‚¨å°†é“¾æ¥åˆ°é‚£äº›æ–‡æ¡£ï¼Œè€Œä¸æ˜¯åœ¨è¿™é‡Œé‡æ–°è§£é‡Šã€‚

æœ¬æ•™ç¨‹å°†ä½¿ç”¨TypeScriptã€‚éšæ„è·Ÿéšå¹¶è·³è¿‡/åˆ é™¤TypeScriptéƒ¨åˆ†ã€‚æˆ‘ä»¬å‘ç°ä½¿ç”¨TypeScriptæ—¶Remixä¼šå˜å¾—æ›´å¥½ï¼Œç‰¹åˆ«æ˜¯å› ä¸ºæˆ‘ä»¬è¿˜å°†ä½¿ç”¨[Prisma][prisma]ä»SQLiteæ•°æ®åº“è®¿é—®æˆ‘ä»¬çš„æ•°æ®æ¨¡å‹ã€‚

<docs-info>ğŸ’¿ ä½ å¥½ï¼Œæˆ‘æ˜¯Remix Discçš„Rachelã€‚æ¯å½“æ‚¨éœ€è¦å®é™…æ‰§è¡ŒæŸäº›æ“ä½œæ—¶ï¼Œæˆ‘ä¼šå‡ºç°ã€‚</docs-info>

<docs-warning>åœ¨æ‚¨æ¢ç´¢çš„è¿‡ç¨‹ä¸­ï¼Œè¯·éšæ„ï¼Œä½†å¦‚æœæ‚¨åç¦»æ•™ç¨‹å¤ªå¤šï¼ˆä¾‹å¦‚åœ¨åˆ°è¾¾è¯¥æ­¥éª¤ä¹‹å‰å°è¯•éƒ¨ç½²ï¼‰ï¼Œæ‚¨å¯èƒ½ä¼šå‘ç°å®ƒçš„å·¥ä½œæ–¹å¼ä¸æ‚¨é¢„æœŸçš„ä¸åŒï¼Œå› ä¸ºæ‚¨é”™è¿‡äº†ä¸€äº›é‡è¦å†…å®¹ã€‚</docs-warning>

<docs-error>æˆ‘ä»¬ä¸ä¼šåœ¨æµè§ˆå™¨ä¸­æ·»åŠ JavaScriptï¼Œç›´åˆ°æ•™ç¨‹æ¥è¿‘å°¾å£°ã€‚è¿™æ˜¯ä¸ºäº†å‘æ‚¨å±•ç¤ºå½“JavaScriptåŠ è½½æ—¶é—´è¿‡é•¿ï¼ˆæˆ–æ ¹æœ¬æ— æ³•åŠ è½½ï¼‰æ—¶ï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºå°†å¦‚ä½•æ­£å¸¸å·¥ä½œã€‚å› æ­¤ï¼Œåœ¨æˆ‘ä»¬å®é™…å°†JavaScriptæ·»åŠ åˆ°é¡µé¢ä¹‹å‰ï¼Œæ‚¨å°†æ— æ³•ä½¿ç”¨`useState`ç­‰å†…å®¹ï¼Œç›´åˆ°æˆ‘ä»¬åˆ°è¾¾è¯¥æ­¥éª¤ã€‚</docs-error>

## å¤§çº²

ä»¥ä¸‹æ˜¯æˆ‘ä»¬å°†åœ¨æœ¬æ•™ç¨‹ä¸­æ¶µç›–çš„ä¸»é¢˜ï¼š

- ç”Ÿæˆä¸€ä¸ªæ–°çš„ Remix é¡¹ç›®
- å¸¸è§„æ–‡ä»¶
- è·¯ç”±ï¼ˆåŒ…æ‹¬åµŒå¥—è·¯ç”± âœ¨ï¼‰
- æ ·å¼
- æ•°æ®åº“äº¤äº’ï¼ˆé€šè¿‡ `sqlite` å’Œ `prisma`ï¼‰
- å˜æ›´
- éªŒè¯
- èº«ä»½éªŒè¯
- é”™è¯¯å¤„ç†ï¼šåŒ…æ‹¬æ„å¤–é”™è¯¯ï¼ˆå¼€å‘è€…çŠ¯çš„é”™è¯¯ï¼‰å’Œé¢„æœŸé”™è¯¯ï¼ˆæœ€ç»ˆç”¨æˆ·çŠ¯çš„é”™è¯¯ï¼‰
- ä½¿ç”¨ Meta æ ‡ç­¾è¿›è¡Œ SEO
- JavaScript...
- èµ„æºè·¯ç”±
- éƒ¨ç½²

æ‚¨å¯ä»¥åœ¨å¯¼èˆªæ ä¸­æ‰¾åˆ°æ•™ç¨‹å„ä¸ªéƒ¨åˆ†çš„é“¾æ¥ï¼ˆç§»åŠ¨è®¾å¤‡åœ¨é¡µé¢é¡¶éƒ¨ï¼Œæ¡Œé¢è®¾å¤‡åœ¨å³ä¾§ï¼‰ã€‚

## å‰ææ¡ä»¶

æ‚¨å¯ä»¥åœ¨ [CodeSandbox][code-sandbox]ï¼ˆä¸€ä¸ªå¾ˆæ£’çš„åœ¨çº¿ç¼–è¾‘å™¨ï¼‰ä¸Šæˆ–åœ¨è‡ªå·±ç”µè„‘ä¸Šè·Ÿéšæœ¬æ•™ç¨‹ã€‚å¦‚æœæ‚¨é€‰æ‹© CodeSandbox çš„æ–¹æ³•ï¼Œé‚£ä¹ˆæ‚¨åªéœ€è¦è‰¯å¥½çš„äº’è”ç½‘è¿æ¥å’Œç°ä»£æµè§ˆå™¨ã€‚å¦‚æœæ‚¨é€‰æ‹©æœ¬åœ°è¿è¡Œï¼Œé‚£ä¹ˆæ‚¨éœ€è¦å®‰è£…ä¸€äº›ä¸œè¥¿ï¼š

- [Node.js][node-js] ç‰ˆæœ¬ (>=18.0.0)
- [npm][npm] 7 æˆ–æ›´é«˜ç‰ˆæœ¬
- ä¸€ä¸ªä»£ç ç¼–è¾‘å™¨ï¼ˆ[VSCode][vs-code] æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼‰

å¦‚æœæ‚¨æƒ³åœ¨æœ€åçš„éƒ¨ç½²æ­¥éª¤ä¸­ä¸€èµ·æ“ä½œï¼Œæ‚¨è¿˜éœ€è¦ä¸€ä¸ª [Fly.io][fly-io] çš„è´¦æˆ·ã€‚

æˆ‘ä»¬è¿˜å°†åœ¨æ‚¨çš„ç³»ç»Ÿå‘½ä»¤è¡Œ/ç»ˆç«¯ç•Œé¢ä¸­æ‰§è¡Œå‘½ä»¤ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦ç†Ÿæ‚‰è¿™ä¸€ç‚¹ã€‚

å‡è®¾æ‚¨å¯¹ React å’Œ TypeScript/JavaScript æœ‰ä¸€äº›ç»éªŒã€‚å¦‚æœæ‚¨æƒ³å¤ä¹ ä¸€ä¸‹è‡ªå·±çš„çŸ¥è¯†ï¼Œå¯ä»¥æŸ¥çœ‹è¿™äº›èµ„æºï¼š

- [JavaScript to know for React][java-script-to-know-for-react]
- [The Beginner's Guide to React][the-beginner-s-guide-to-react]

å¯¹ [HTTP API][the-http-api] æœ‰è‰¯å¥½çš„ç†è§£ä¹Ÿæ˜¯æœ‰å¸®åŠ©çš„ï¼Œä½†ä¸æ˜¯ç»å¯¹å¿…è¦çš„ã€‚

è¿™æ ·ï¼Œæˆ‘æƒ³æˆ‘ä»¬å¯ä»¥å¼€å§‹äº†ï¼

## ç”Ÿæˆä¸€ä¸ªæ–°çš„ Remix é¡¹ç›®

<docs-info>

å¦‚æœæ‚¨æ‰“ç®—ä½¿ç”¨ CodeSandboxï¼Œå¯ä»¥ä½¿ç”¨ [åŸºæœ¬ç¤ºä¾‹][the-basic-example] æ¥å¼€å§‹ã€‚

</docs-info>

ğŸ’¿ æ‰“å¼€æ‚¨çš„ç»ˆç«¯å¹¶è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```shellscript nonumber
npx create-remix@latest
```

<docs-info>

è¿™å¯èƒ½ä¼šè¯¢é—®æ‚¨æ˜¯å¦è¦å®‰è£… `create-remix@latest`ã€‚è¾“å…¥ `y`ã€‚å®ƒåªä¼šåœ¨ç¬¬ä¸€æ¬¡è¿è¡Œè®¾ç½®è„šæœ¬æ—¶å®‰è£…ã€‚

</docs-info>

ä¸€æ—¦è®¾ç½®è„šæœ¬è¿è¡Œå®Œæ¯•ï¼Œå®ƒä¼šè¯¢é—®æ‚¨å‡ ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬å°†åº”ç”¨å‘½åä¸º "remix-jokes"ï¼Œé€‰æ‹©åˆå§‹åŒ–ä¸€ä¸ª Git ä»“åº“å¹¶è®©å®ƒä¸ºæˆ‘ä»¬è¿è¡Œå®‰è£…ï¼š

```
Where should we create your new project?
remix-jokes

Initialize a new git repository?
Yes

Install dependencies with npm?
Yes
```

Remix å¯ä»¥éƒ¨ç½²åœ¨è¶Šæ¥è¶Šå¤šçš„ JavaScript ç¯å¢ƒä¸­ã€‚â€œRemix App Serverâ€æ˜¯ä¸€ä¸ªåŸºäº [Express][express] çš„å…¨åŠŸèƒ½ [Node.js][node-js] æœåŠ¡å™¨ã€‚å®ƒæ˜¯æœ€ç®€å•çš„é€‰é¡¹ï¼Œæ»¡è¶³å¤§å¤šæ•°äººçš„éœ€æ±‚ï¼Œå› æ­¤æˆ‘ä»¬åœ¨æœ¬æ•™ç¨‹ä¸­é€‰æ‹©è¿™ä¸ªã€‚æœªæ¥å¯ä»¥éšæ„å°è¯•å…¶ä»–é€‰é¡¹ï¼

ä¸€æ—¦ `npm install` å®Œæˆï¼Œæˆ‘ä»¬å°†åˆ‡æ¢åˆ° `remix-jokes` ç›®å½•ï¼š

ğŸ’¿ è¿è¡Œæ­¤å‘½ä»¤

```shellscript nonumber
cd remix-jokes
```

ç°åœ¨æ‚¨åœ¨ `remix-jokes` ç›®å½•ä¸­ã€‚ä»ç°åœ¨å¼€å§‹ï¼Œæ‚¨è¿è¡Œçš„æ‰€æœ‰å…¶ä»–å‘½ä»¤éƒ½å°†åœ¨è¯¥ç›®å½•ä¸­è¿›è¡Œã€‚

ğŸ’¿ å¾ˆå¥½ï¼Œç°åœ¨åœ¨æ‚¨å–œæ¬¢çš„ç¼–è¾‘å™¨ä¸­æ‰“å¼€å®ƒï¼Œè®©æˆ‘ä»¬ç¨å¾®æ¢ç´¢ä¸€ä¸‹é¡¹ç›®ç»“æ„ã€‚

## æ¢ç´¢é¡¹ç›®ç»“æ„

è¿™æ˜¯æ ‘å½¢ç»“æ„ã€‚å¸Œæœ›ä½ çœ‹åˆ°çš„ç»“æ„ä¸æ­¤ç±»ä¼¼ï¼š

```
remix-jokes
â”œâ”€â”€ README.md
â”œâ”€â”€ app
â”‚   â”œâ”€â”€ entry.client.tsx
â”‚   â”œâ”€â”€ entry.server.tsx
â”‚   â”œâ”€â”€ root.tsx
â”‚   â””â”€â”€ routes
â”‚       â””â”€â”€ _index.tsx
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ public
â”‚   â””â”€â”€ favicon.ico
â”œâ”€â”€ remix.config.js
â”œâ”€â”€ remix.env.d.ts
â””â”€â”€ tsconfig.json
```

è®©æˆ‘ä»¬ç®€è¦è®¨è®ºä¸€ä¸‹è¿™äº›æ–‡ä»¶ï¼š

- `app/` - è¿™æ˜¯ä½ æ‰€æœ‰ Remix åº”ç”¨ä»£ç çš„åœ°æ–¹
- `app/entry.client.tsx` - è¿™æ˜¯å½“åº”ç”¨åœ¨æµè§ˆå™¨ä¸­åŠ è½½æ—¶è¿è¡Œçš„ç¬¬ä¸€æ®µ JavaScriptã€‚æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶æ¥ [hydrate][hydrate] æˆ‘ä»¬çš„ React ç»„ä»¶ã€‚
- `app/entry.server.tsx` - è¿™æ˜¯å½“è¯·æ±‚åˆ°è¾¾ä½ çš„æœåŠ¡å™¨æ—¶è¿è¡Œçš„ç¬¬ä¸€æ®µ JavaScriptã€‚Remix å¤„ç†åŠ è½½æ‰€æœ‰å¿…è¦çš„æ•°æ®ï¼Œè€Œä½ è´Ÿè´£å‘é€å“åº”ã€‚æˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶å°†æˆ‘ä»¬çš„ React åº”ç”¨æ¸²æŸ“ä¸ºå­—ç¬¦ä¸²/æµï¼Œå¹¶å°†å…¶ä½œä¸ºå“åº”å‘é€ç»™å®¢æˆ·ç«¯ã€‚
- `app/root.tsx` - è¿™æ˜¯æˆ‘ä»¬æ”¾ç½®åº”ç”¨ç¨‹åºæ ¹ç»„ä»¶çš„åœ°æ–¹ã€‚ä½ åœ¨è¿™é‡Œæ¸²æŸ“ `<html>` å…ƒç´ ã€‚
- `app/routes/` - è¿™æ˜¯ä½ æ‰€æœ‰â€œè·¯ç”±æ¨¡å—â€çš„ä½ç½®ã€‚Remix ä½¿ç”¨è¯¥ç›®å½•ä¸­çš„æ–‡ä»¶æ ¹æ®æ–‡ä»¶ååˆ›å»ºåº”ç”¨ç¨‹åºçš„ URL è·¯ç”±ã€‚
- `public/` - è¿™æ˜¯ä½ çš„é™æ€èµ„æºæ‰€åœ¨çš„ä½ç½®ï¼ˆå›¾ç‰‡/å­—ä½“/ç­‰ï¼‰ã€‚
- `remix.config.js` - Remix åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­æœ‰ä¸€äº›é…ç½®é€‰é¡¹å¯ä»¥è®¾ç½®ã€‚

ğŸ’¿ ç°åœ¨è®©æˆ‘ä»¬è¿è¡Œæ„å»ºï¼š

```shellscript nonumber
npm run build
```

è¿™åº”è¯¥ä¼šè¾“å‡ºç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š

```
Building Remix app in production mode...
Built in 132ms
```

ç°åœ¨ä½ åº”è¯¥è¿˜æœ‰ä¸€ä¸ª `.cache/` ç›®å½•ï¼ˆè¿™æ˜¯ Remix å†…éƒ¨ä½¿ç”¨çš„ä¸œè¥¿ï¼‰ï¼Œä¸€ä¸ª `build/` ç›®å½•ï¼Œä»¥åŠä¸€ä¸ª `public/build` ç›®å½•ã€‚`build/` ç›®å½•æ˜¯æˆ‘ä»¬çš„æœåŠ¡å™¨ç«¯ä»£ç ã€‚`public/build/` å­˜æ”¾æˆ‘ä»¬æ‰€æœ‰çš„å®¢æˆ·ç«¯ä»£ç ã€‚è¿™ä¸‰ä¸ªç›®å½•åœ¨ä½ çš„ `.gitignore` æ–‡ä»¶ä¸­åˆ—å‡ºï¼Œå› æ­¤ä½ ä¸ä¼šå°†ç”Ÿæˆçš„æ–‡ä»¶æäº¤åˆ°æºä»£ç ç®¡ç†ä¸­ã€‚

ğŸ’¿ ç°åœ¨è®©æˆ‘ä»¬è¿è¡Œæ„å»ºå¥½çš„åº”ç”¨ï¼š

```shellscript nonumber
npm start
```

è¿™å°†å¯åŠ¨æœåŠ¡å™¨å¹¶è¾“å‡ºï¼š

```
Remix App Server started at http://localhost:3000
```

æ‰“å¼€è¯¥ URLï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªæŒ‡å‘ä¸€äº›æ–‡æ¡£çš„æœ€å°é¡µé¢ã€‚

ğŸ’¿ ç°åœ¨åœæ­¢æœåŠ¡å™¨å¹¶åˆ é™¤è¯¥ç›®å½•ï¼š

- `app/routes`

æˆ‘ä»¬å°†æŠŠè¿™ä¸ªç®€åŒ–åˆ°æœ€åŸºæœ¬çš„ç»“æ„ï¼Œå¹¶é€æ­¥å¼•å…¥å†…å®¹ã€‚

ğŸ’¿ ç”¨ä»¥ä¸‹å†…å®¹æ›¿æ¢ `app/root.tsx` çš„å†…å®¹ï¼š

```tsx filename=app/root.tsx
import { LiveReload } from "@remix-run/react";

export default function App() {
  return (
    <html lang="en">
      <head>
        <meta charSet="utf-8" />
        <meta
          name="viewport"
          content="width=device-width, initial-scale=1"
        />
        <title>Remix: So great, it's funny!</title>
      </head>
      <body>
        Hello world
        <LiveReload />
      </body>
    </html>
  );
}
```

<docs-info>

`<LiveReload />` ç»„ä»¶åœ¨å¼€å‘è¿‡ç¨‹ä¸­éå¸¸æœ‰ç”¨ï¼Œå®ƒä¼šåœ¨æˆ‘ä»¬è¿›è¡Œæ›´æ”¹æ—¶è‡ªåŠ¨åˆ·æ–°æµè§ˆå™¨ã€‚ç”±äºæˆ‘ä»¬çš„æ„å»ºæœåŠ¡å™¨éå¸¸å¿«ï¼Œé‡æ–°åŠ è½½é€šå¸¸ä¼šåœ¨ä½ æ³¨æ„åˆ°ä¹‹å‰å°±å‘ç”Ÿ âš¡

</docs-info>

ä½ çš„ `app/` ç›®å½•ç°åœ¨åº”è¯¥çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```
app
â”œâ”€â”€ entry.client.tsx
â”œâ”€â”€ entry.server.tsx
â””â”€â”€ root.tsx
```

ğŸ’¿ è®¾ç½®å®Œæˆåï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š

```shellscript nonumber
npm run dev
```

æ‰“å¼€ [http://localhost:3000][http-localhost-3000]ï¼Œåº”ç”¨ç¨‹åºåº”è¯¥ä¼šå‘ä¸–ç•Œé—®å¥½ï¼š

![Bare bones hello world app][bare-bones-hello-world-app]

å¾ˆå¥½ï¼Œç°åœ¨æˆ‘ä»¬å‡†å¤‡å¼€å§‹é€æ­¥æ·»åŠ å†…å®¹ã€‚

## è·¯ç”±

æˆ‘ä»¬é¦–å…ˆè¦åšçš„æ˜¯è®¾ç½®æˆ‘ä»¬çš„è·¯ç”±ç»“æ„ã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„åº”ç”¨å°†è¦æ‹¥æœ‰çš„æ‰€æœ‰è·¯ç”±ï¼š

```
/
/jokes
/jokes/:jokeId
/jokes/new
/login
```

æ‚¨å¯ä»¥é€šè¿‡ [`remix.config.js`][remix-config-js] ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»ºè·¯ç”±ï¼Œä½†åˆ›å»ºè·¯ç”±çš„æ›´å¸¸è§æ–¹æ³•æ˜¯é€šè¿‡æ–‡ä»¶ç³»ç»Ÿã€‚è¿™è¢«ç§°ä¸ºâ€œåŸºäºæ–‡ä»¶çš„è·¯ç”±â€ã€‚

æˆ‘ä»¬æ”¾åœ¨ `app/routes` ç›®å½•ä¸­çš„æ¯ä¸ªæ–‡ä»¶ç§°ä¸ºè·¯ç”±æ¨¡å—ï¼Œé€šè¿‡éµå¾ª [è·¯ç”±æ–‡ä»¶åçº¦å®š][the-route-filename-convention]ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºæ‰€éœ€çš„è·¯ç”± URL ç»“æ„ã€‚Remix åœ¨åº•å±‚ä½¿ç”¨ [React Router][react_router] æ¥å¤„ç†è¿™äº›è·¯ç”±ã€‚

ğŸ’¿ è®©æˆ‘ä»¬ä»ç´¢å¼•è·¯ç”± (`/`) å¼€å§‹ã€‚ä¸ºæ­¤ï¼Œåœ¨ `app/routes/_index.tsx` åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶ä»è¯¥è·¯ç”±æ¨¡å—ä¸­ `export default` ä¸€ä¸ªç»„ä»¶ã€‚ç°åœ¨ï¼Œæ‚¨å¯ä»¥è®©å®ƒåªæ˜¾ç¤ºâ€œHello Index Routeâ€æˆ–ç±»ä¼¼å†…å®¹ã€‚

<details>

<summary>app/routes/_index.tsx</summary>

```tsx filename=app/routes/_index.tsx
export default function IndexRoute() {
  return <div>Hello Index Route</div>;
}
```

</details>

React Router æ”¯æŒâ€œåµŒå¥—è·¯ç”±â€ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„è·¯ç”±ä¸­æœ‰çˆ¶å­å…³ç³»ã€‚`app/routes/_index.tsx` æ˜¯ `app/root.tsx` è·¯ç”±çš„å­è·¯ç”±ã€‚åœ¨åµŒå¥—è·¯ç”±ä¸­ï¼Œçˆ¶è·¯ç”±è´Ÿè´£å¸ƒå±€å…¶å­è·¯ç”±ã€‚

ğŸ’¿ æ›´æ–° `app/root.tsx` ä»¥å®šä½å­è·¯ç”±ã€‚æ‚¨å°†ä½¿ç”¨æ¥è‡ª `@remix-run/react` çš„ `<Outlet />` ç»„ä»¶æ¥å®ç°è¿™ä¸€ç‚¹ï¼š

<details>

<summary>app/root.tsx</summary>

```tsx filename=app/root.tsx lines=[1,15]
import { LiveReload, Outlet } from "@remix-run/react";

export default function App() {
  return (
    <html lang="en">
      <head>
        <meta charSet="utf-8" />
        <meta
          name="viewport"
          content="width=device-width, initial-scale=1"
        />
        <title>Remix: So great, it's funny!</title>
      </head>
      <body>
        <Outlet />
        <LiveReload />
      </body>
    </html>
  );
}
```

</details>

<docs-info>è®°å¾—ä½¿ç”¨ `npm run dev` è¿è¡Œå¼€å‘æœåŠ¡å™¨</docs-info>

è¿™å°†ç›‘è§†æ‚¨çš„æ–‡ä»¶ç³»ç»Ÿä»¥è¿›è¡Œæ›´æ”¹ï¼Œé‡å»ºç«™ç‚¹ï¼Œå¹¶ä¸”ç”±äº `<LiveReload />` ç»„ä»¶ï¼Œæ‚¨çš„æµè§ˆå™¨å°†åˆ·æ–°ã€‚

ğŸ’¿ ç»§ç»­æ‰“å¼€ç½‘ç«™ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°æ¥è‡ªç´¢å¼•è·¯ç”±çš„é—®å€™ã€‚

![æ¥è‡ªç´¢å¼•è·¯ç”±çš„é—®å€™][a-greeting-from-the-index-route]

å¤ªå¥½äº†ï¼æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å¤„ç† `/jokes` è·¯ç”±ã€‚

ğŸ’¿ åœ¨ `app/routes/jokes.tsx` åˆ›å»ºä¸€ä¸ªæ–°è·¯ç”±ï¼ˆè¯·è®°ä½ï¼Œè¿™å°†æ˜¯ä¸€ä¸ªçˆ¶è·¯ç”±ï¼Œå› æ­¤æ‚¨éœ€è¦å†æ¬¡ä½¿ç”¨ `<Outlet />`ï¼‰ã€‚

<details>

<summary>app/routes/jokes.tsx</summary>

```tsx filename=app/routes/jokes.tsx
import { Outlet } from "@remix-run/react";

export default function JokesRoute() {
  return (
    <div>
      <h1>JğŸ¤ªKES</h1>
      <main>
        <Outlet />
      </main>
    </div>
  );
}
```

</details>

å½“æ‚¨è®¿é—® [`/jokes`][jokes] æ—¶ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°è¯¥ç»„ä»¶ã€‚ç°åœ¨ï¼Œåœ¨é‚£ä¸ª `<Outlet />` ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦æ¸²æŸ“ä¸€äº›éšæœºç¬‘è¯ä½œä¸ºâ€œç´¢å¼•è·¯ç”±â€ã€‚

ğŸ’¿ åœ¨ `app/routes/jokes._index.tsx` åˆ›å»ºä¸€ä¸ªè·¯ç”±ã€‚

<details>

<summary>app/routes/jokes._index.tsx</summary>

```tsx filename=app/routes/jokes._index.tsx
export default function JokesIndexRoute() {
  return (
    <div>
      <p>è¿™æ˜¯ä¸€ä¸ªéšæœºç¬‘è¯ï¼š</p>
      <p>
        æˆ‘åœ¨æƒ³ä¸ºä»€ä¹ˆé£ç›˜è¶Šæ¥è¶Šå¤§ï¼Œ
        ç„¶åæˆ‘æ˜ç™½äº†ã€‚
      </p>
    </div>
  );
}
```

</details>

ç°åœ¨å¦‚æœæ‚¨åˆ·æ–° [`/jokes`][jokes]ï¼Œæ‚¨å°†è·å¾— `app/routes/jokes.tsx` å’Œ `app/routes/jokes._index.tsx` çš„å†…å®¹ã€‚æˆ‘çš„æ•ˆæœå¦‚ä¸‹ï¼š

![ç¬‘è¯é¡µé¢ä¸Šçš„éšæœºç¬‘è¯ï¼šâ€œæˆ‘åœ¨æƒ³ä¸ºä»€ä¹ˆé£ç›˜è¶Šæ¥è¶Šå¤§ï¼Œç„¶åæˆ‘æ˜ç™½äº†â€][a-random-joke-on-the-jokes-page-i-was-wondering-why-the-frisbee-was-getting-bigger-then-it-hit-me]

è¯·æ³¨æ„ï¼Œæ¯ä¸ªè·¯ç”±æ¨¡å—åªå…³æ³¨å…¶ URL çš„ä¸€éƒ¨åˆ†ã€‚å¾ˆä¸é”™å§ï¼ï¼ŸåµŒå¥—è·¯ç”±éå¸¸ä¸é”™ï¼Œæˆ‘ä»¬æ‰åˆšåˆšå¼€å§‹ã€‚è®©æˆ‘ä»¬ç»§ç»­ã€‚

ğŸ’¿ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å¤„ç† `/jokes/new` è·¯ç”±ã€‚æˆ‘æ•¢æ‰“èµŒæ‚¨èƒ½æƒ³å‡ºå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ ğŸ˜„ã€‚è¯·è®°ä½ï¼Œæˆ‘ä»¬å°†åœ¨æ­¤é¡µé¢ä¸Šå…è®¸ç”¨æˆ·åˆ›å»ºç¬‘è¯ï¼Œå› æ­¤æ‚¨éœ€è¦æ¸²æŸ“ä¸€ä¸ªåŒ…å« `name` å’Œ `content` å­—æ®µçš„ `form`ã€‚

<details>

<summary>app/routes/jokes.new.tsx</summary>

```tsx filename=app/routes/jokes.new.tsx
export default function NewJokeRoute() {
  return (
    <div>
      <p>æ·»åŠ æ‚¨è‡ªå·±çš„æç¬‘ç¬‘è¯</p>
      <form method="post">
        <div>
          <label>
            åç§°ï¼š <input type="text" name="name" />
          </label>
        </div>
        <div>
          <label>
            å†…å®¹ï¼š <textarea name="content" />
          </label>
        </div>
        <div>
          <button type="submit" className="button">
            æ·»åŠ 
          </button>
        </div>
      </form>
    </div>
  );
}
```

</details>

å¤ªå¥½äº†ï¼Œç°åœ¨è®¿é—® [`/jokes/new`][jokes-new] åº”è¯¥ä¼šæ˜¾ç¤ºæ‚¨çš„è¡¨å•ï¼š

![æ–°çš„ç¬‘è¯è¡¨å•][a-new-joke-form]

### å‚æ•°åŒ–è·¯ç”±

å¾ˆå¿«æˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªæ•°æ®åº“ï¼Œç”¨äºé€šè¿‡ ID å­˜å‚¨æˆ‘ä»¬çš„ç¬‘è¯ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæ›´ç‹¬ç‰¹çš„è·¯ç”±ï¼Œä¸€ä¸ªå‚æ•°åŒ–è·¯ç”±ï¼š

`/jokes/$jokeId`

è¿™é‡Œçš„å‚æ•° `$jokeId` å¯ä»¥æ˜¯ä»»ä½•å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾ URL çš„è¿™ä¸€éƒ¨åˆ†ä»¥æ˜¾ç¤ºæ­£ç¡®çš„ç¬‘è¯ã€‚è¦åˆ›å»ºä¸€ä¸ªå‚æ•°åŒ–è·¯ç”±ï¼Œæˆ‘ä»¬åœ¨æ–‡ä»¶åä¸­ä½¿ç”¨ `$` å­—ç¬¦ã€‚([åœ¨è¿™é‡Œé˜…è¯»æœ‰å…³è¯¥çº¦å®šçš„æ›´å¤šä¿¡æ¯][the-route-filename-convention]).

ğŸ’¿ åœ¨ `app/routes/jokes.$jokeId.tsx` åˆ›å»ºä¸€ä¸ªæ–°è·¯ç”±ã€‚ç°åœ¨ä¸å¿…å¤ªæ‹…å¿ƒå®ƒæ˜¾ç¤ºä»€ä¹ˆï¼ˆæˆ‘ä»¬è¿˜æ²¡æœ‰è®¾ç½®æ•°æ®åº“ï¼ï¼‰ï¼š

<details>

<summary>app/routes/jokes.$jokeId.tsx</summary>

```tsx filename=app/routes/jokes.$jokeId.tsx
export default function JokeRoute() {
  return (
    <div>
      <p>Here's your hilarious joke:</p>
      <p>
        Why don't you find hippopotamuses hiding in trees?
        They're really good at it.
      </p>
    </div>
  );
}
```

</details>

å¾ˆå¥½ï¼Œç°åœ¨è®¿é—® [`/jokes/anything-you-want`][jokes-anything-you-want] åº”è¯¥ä¼šæ˜¾ç¤ºä½ åˆšåˆšåˆ›å»ºçš„å†…å®¹ï¼ˆä»¥åŠçˆ¶è·¯ç”±ï¼‰ï¼š

![A new joke form][a-new-joke-form-2]

å¤ªå¥½äº†ï¼æˆ‘ä»¬çš„ä¸»è¦è·¯ç”±éƒ½è®¾ç½®å¥½äº†ï¼

## æ ·å¼

ä»ç½‘é¡µæ ·å¼çš„å¼€å§‹ï¼Œåˆ°åœ¨é¡µé¢ä¸Šè·å– CSSï¼Œæˆ‘ä»¬ä¸€ç›´ä½¿ç”¨ `<link rel="stylesheet" href="/path-to-file.css" />`ã€‚è¿™ä¹Ÿæ˜¯ä½ ä¸º Remix åº”ç”¨ç¨‹åºè®¾ç½®æ ·å¼çš„æ–¹å¼ï¼Œä½† Remix ä½¿è¿™æ¯”éšå¤„ä¹±ä¸¢ `link` æ ‡ç­¾ç®€å•å¾—å¤šã€‚Remix å°†å…¶åµŒå¥—è·¯ç”±æ”¯æŒçš„å¼ºå¤§åŠŸèƒ½å¼•å…¥ CSSï¼Œå¹¶å…è®¸ä½ å°† `link` æ ‡ç­¾ä¸è·¯ç”±å…³è”ã€‚å½“è·¯ç”±å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶ï¼Œ`link` æ ‡ç­¾ä¼šå‡ºç°åœ¨é¡µé¢ä¸Šï¼ŒCSS ä¹Ÿä¼šåº”ç”¨ã€‚å½“è·¯ç”±ä¸å¤„äºæ´»åŠ¨çŠ¶æ€ï¼ˆç”¨æˆ·å¯¼èˆªç¦»å¼€ï¼‰æ—¶ï¼Œ`link` æ ‡ç­¾ä¼šè¢«ç§»é™¤ï¼ŒCSS å°†ä¸å†åº”ç”¨ã€‚

ä½ å¯ä»¥é€šè¿‡åœ¨è·¯ç”±æ¨¡å—ä¸­å¯¼å‡ºä¸€ä¸ª [`links`][links] å‡½æ•°æ¥å®ç°è¿™ä¸€ç‚¹ã€‚è®©æˆ‘ä»¬æ¥ä¸ºä¸»é¡µæ·»åŠ æ ·å¼ã€‚ä½ å¯ä»¥å°† CSS æ–‡ä»¶æ”¾åœ¨ `app` ç›®å½•ä¸­çš„ä»»ä½•ä½ç½®ã€‚æˆ‘ä»¬å°†å…¶æ”¾åœ¨ `app/styles/` ä¸­ã€‚

æˆ‘ä»¬å°†é¦–å…ˆä¸ºä¸»é¡µï¼ˆç´¢å¼•è·¯ç”± `/`ï¼‰æ·»åŠ æ ·å¼ã€‚

ğŸ’¿ åˆ›å»º `app/styles/index.css` å¹¶å°†ä»¥ä¸‹ CSS æ”¾å…¥å…¶ä¸­ï¼š

```css
body {
  color: hsl(0, 0%, 100%);
  background-image: radial-gradient(
    circle,
    rgba(152, 11, 238, 1) 0%,
    rgba(118, 15, 181, 1) 35%,
    rgba(58, 13, 85, 1) 100%
  );
}
```

ğŸ’¿ ç°åœ¨æ›´æ–° `app/routes/_index.tsx` ä»¥å¯¼å…¥è¯¥ CSS æ–‡ä»¶ã€‚ç„¶åæ·»åŠ ä¸€ä¸ª `links` å¯¼å‡ºï¼ˆå¦‚ [æ–‡æ¡£][links] ä¸­æ‰€è¿°ï¼‰ä»¥å°†è¯¥é“¾æ¥æ·»åŠ åˆ°é¡µé¢ã€‚

<details>

<summary>app/routes/_index.tsx</summary>

```tsx filename=app/routes/_index.tsx lines=[1,3,5-7]
import type { LinksFunction } from "@remix-run/node";

import stylesUrl from "~/styles/index.css";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

export default function IndexRoute() {
  return <div>Hello Index Route</div>;
}
```

</details>

ç°åœ¨å¦‚æœä½ è®¿é—® [`/`][http-localhost-3000]ï¼Œä½ å¯èƒ½ä¼šæœ‰äº›å¤±æœ›ã€‚æˆ‘ä»¬ç¾ä¸½çš„æ ·å¼æ²¡æœ‰åº”ç”¨ï¼ä½ å¯èƒ½ä¼šè®°å¾—åœ¨ `app/root.tsx` ä¸­ï¼Œæˆ‘ä»¬è´Ÿè´£æ¸²æŸ“æˆ‘ä»¬åº”ç”¨çš„ _ä¸€åˆ‡_ã€‚ä» `<html>` åˆ° `</html>`ã€‚è¿™æ„å‘³ç€å¦‚æœæŸäº›å†…å®¹æ²¡æœ‰æ˜¾ç¤ºåœ¨å…¶ä¸­ï¼Œå®ƒæ ¹æœ¬ä¸ä¼šæ˜¾ç¤ºï¼

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æŸç§æ–¹å¼ä»æ‰€æœ‰æ´»åŠ¨è·¯ç”±è·å– `link` å¯¼å‡ºï¼Œå¹¶ä¸ºæ‰€æœ‰è¿™äº›æ·»åŠ  `<link />` æ ‡ç­¾ã€‚å¹¸è¿çš„æ˜¯ï¼ŒRemix ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªä¾¿åˆ©çš„ [`<Links />`][links-component] ç»„ä»¶ï¼Œä½¿è¿™å˜å¾—ç®€å•ã€‚

ğŸ’¿ ç»§ç»­åœ¨ `<head>` ä¸­å°† Remix `<Links />` ç»„ä»¶æ·»åŠ åˆ° `app/root.tsx`ã€‚

<details>

<summary>app/root.tsx</summary>

```tsx filename=app/root.tsx lines=[2,17]
import {
  Links,
  LiveReload,
  Outlet,
} from "@remix-run/react";

export default function App() {
  return (
    <html lang="en">
      <head>
        <meta charSet="utf-8" />
        <meta
          name="viewport"
          content="width=device-width, initial-scale=1"
        />
        <title>Remix: So great, it's funny!</title>
        <Links />
      </head>
      <body>
        <Outlet />
        <LiveReload />
      </body>
    </html>
  );
}
```

</details>

å¤ªå¥½äº†ï¼Œç°åœ¨å†æ¬¡æ£€æŸ¥ [`/`][http-localhost-3000]ï¼Œå®ƒåº”è¯¥çœ‹èµ·æ¥å¾ˆå¥½å¹¶ä¸”æœ‰æ ·å¼ï¼š

![å¸¦æœ‰ç´«è‰²æ¸å˜èƒŒæ™¯å’Œç™½è‰²æ–‡æœ¬çš„ä¸»é¡µï¼Œä¸Šé¢å†™ç€â€œHello Index Routeâ€][the-homepage-with-a-purple-gradient-background-and-white-text-with-the-words-hello-index-route]

å¤ªæ£’äº†ï¼ä½†æˆ‘æƒ³å¼ºè°ƒä¸€äº›é‡è¦è€Œä»¤äººå…´å¥‹çš„äº‹æƒ…ã€‚ä½ çŸ¥é“æˆ‘ä»¬å†™çš„ CSS æ˜¯å¦‚ä½•æ ·å¼åŒ– `body` å…ƒç´ çš„å—ï¼Ÿä½ æœŸæœ›åœ¨ [`/jokes`][jokes] è·¯ç”±ä¸Šå‘ç”Ÿä»€ä¹ˆï¼Ÿå»çœ‹çœ‹å§ã€‚

![æ²¡æœ‰èƒŒæ™¯æ¸å˜çš„ç¬‘è¯é¡µé¢][the-jokes-page-with-no-background-gradient]

ğŸ¤¯ è¿™æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆ CSS è§„åˆ™æ²¡æœ‰åº”ç”¨ï¼Ÿ`body` è¢«ç§»é™¤äº†å—ï¼Ÿä¸ã€‚å¦‚æœä½ æ‰“å¼€å¼€å‘å·¥å…·çš„å…ƒç´ é€‰é¡¹å¡ï¼Œä½ ä¼šæ³¨æ„åˆ°é“¾æ¥æ ‡ç­¾æ ¹æœ¬ä¸å­˜åœ¨ï¼

<docs-info>

è¿™æ„å‘³ç€ä½ åœ¨ç¼–å†™ CSS æ—¶ä¸å¿…æ‹…å¿ƒæ„å¤–çš„ CSS å†²çªã€‚ä½ å¯ä»¥éšæ„ç¼–å†™ï¼Œåªè¦æ£€æŸ¥æ¯ä¸ªè·¯ç”±ï¼Œä½ çš„æ–‡ä»¶è¢«é“¾æ¥çš„åœ°æ–¹ï¼Œä½ å°±ä¼šçŸ¥é“ä½ æ²¡æœ‰å½±å“å…¶ä»–é¡µé¢ï¼ğŸ”¥

è¿™ä¹Ÿæ„å‘³ç€ä½ çš„ CSS æ–‡ä»¶å¯ä»¥é•¿æœŸç¼“å­˜ï¼Œå¹¶ä¸”ä½ çš„ CSS è‡ªç„¶ä¼šè¿›è¡Œä»£ç åˆ†å‰²ã€‚æ€§èƒ½çœŸæ˜¯å¤ªæ£’äº† âš¡

</docs-info>

è¿™å°±æ˜¯æœ¬æ•™ç¨‹ä¸­æ ·å¼çš„å…¨éƒ¨å†…å®¹ã€‚å‰©ä¸‹çš„å°±æ˜¯ç¼–å†™ CSSï¼Œå¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥éšæ„è¿›è¡Œï¼Œæˆ–è€…ç®€å•åœ°å¤åˆ¶ä¸‹é¢çš„æ ·å¼ã€‚

<details>

<summary>ğŸ’¿ å¤åˆ¶åˆ° `app/styles/global.css`</summary>

```css filename=app/styles/global.css
@font-face {
  font-family: "baloo";
  src: url("/fonts/baloo/baloo.woff") format("woff");
  font-weight: normal;
  font-style: normal;
}

:root {
  --hs-links: 48 100%;
  --color-foreground: hsl(0, 0%, 100%);
  --color-background: hsl(278, 73%, 19%);
  --color-links: hsl(var(--hs-links) 50%);
  --color-links-hover: hsl(var(--hs-links) 45%);
  --color-border: hsl(277, 85%, 38%);
  --color-invalid: hsl(356, 100%, 71%);
  --gradient-background: radial-gradient(
    circle,
    rgba(152, 11, 238, 1) 0%,
    rgba(118, 15, 181, 1) 35%,
    rgba(58, 13, 85, 1) 100%
  );
  --font-body: -apple-system, "Segoe UI", Helvetica Neue, Helvetica,
    Roboto, Arial, sans-serif, system-ui, "Apple Color Emoji",
    "Segoe UI Emoji";
  --font-display: baloo, var(--font-body);
}

html {
  box-sizing: border-box;
}

*,
*::before,
*::after {
  box-sizing: inherit;
}

:-moz-focusring {
  outline: auto;
}

:focus {
  outline: var(--color-links) solid 2px;
  outline-offset: 2px;
}

html,
body {
  padding: 0;
  margin: 0;
  color: var(--color-foreground);
  background-color: var(--color-background);
}

[data-light] {
  --color-invalid: hsl(356, 70%, 39%);
  color: var(--color-background);
  background-color: var(--color-foreground);
}

body {
  font-family: var(--font-body);
  line-height: 1.5;
  background-repeat: no-repeat;
  min-height: 100vh;
  min-height: calc(100vh - env(safe-area-inset-bottom));
}

a {
  color: var(--color-links);
  text-decoration: none;
}

a:hover {
  color: var(--color-links-hover);
  text-decoration: underline;
}

hr {
  display: block;
  height: 1px;
  border: 0;
  background-color: var(--color-border);
  margin-top: 2rem;
  margin-bottom: 2rem;
}

h1,
h2,
h3,
h4,
h5,
h6 {
  font-family: var(--font-display);
  margin: 0;
}

h1 {
  font-size: 2.25rem;
  line-height: 2.5rem;
}

h2 {
  font-size: 1.5rem;
  line-height: 2rem;
}

h3 {
  font-size: 1.25rem;
  line-height: 1.75rem;
}

h4 {
  font-size: 1.125rem;
  line-height: 1.75rem;
}

h5,
h6 {
  font-size: 0.875rem;
  line-height: 1.25rem;
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}

.container {
  --gutter: 16px;
  width: 1024px;
  max-width: calc(100% - var(--gutter) * 2);
  margin-right: auto;
  margin-left: auto;
}

/* buttons */

.button {
  --shadow-color: hsl(var(--hs-links) 30%);
  --shadow-size: 3px;
  -webkit-appearance: none;
  -moz-appearance: none;
  cursor: pointer;
  appearance: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background-color: var(--color-links);
  color: var(--color-background);
  font-family: var(--font-display);
  font-weight: bold;
  line-height: 1;
  font-size: 1.125rem;
  margin: 0;
  padding: 0.625em 1em;
  border: 0;
  border-radius: 4px;
  box-shadow: 0 var(--shadow-size) 0 0 var(--shadow-color);
  outline-offset: 2px;
  transform: translateY(0);
  transition: background-color 50ms ease-out, box-shadow
      50ms ease-out,
    transform 100ms cubic-bezier(0.3, 0.6, 0.8, 1.25);
}

.button:hover {
  --raise: 1px;
  color: var(--color-background);
  text-decoration: none;
  box-shadow: 0 calc(var(--shadow-size) + var(--raise)) 0 0 var(
      --shadow-color
    );
  transform: translateY(calc(var(--raise) * -1));
}

.button:active {
  --press: 1px;
  box-shadow: 0 calc(var(--shadow-size) - var(--press)) 0 0 var(
      --shadow-color
    );
  transform: translateY(var(--press));
  background-color: var(--color-links-hover);
}

.button[disabled],
.button[aria-disabled="true"] {
  transform: translateY(0);
  pointer-events: none;
  opacity: 0.7;
}

.button:focus:not(:focus-visible) {
  outline: none;
}

/* forms */

form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  width: 100%;
}

fieldset {
  margin: 0;
  padding: 0;
  border: 0;
}

legend {
  display: block;
  max-width: 100%;
  margin-bottom: 0.5rem;
  color: inherit;
  white-space: normal;
}

[type="text"],
[type="password"],
[type="date"],
[type="datetime"],
[type="datetime-local"],
[type="month"],
[type="week"],
[type="email"],
[type="number"],
[type="search"],
[type="tel"],
[type="time"],
[type="url"],
[type="color"],
textarea {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  display: block;
  display: flex;
  align-items: center;
  width: 100%;
  height: 2.5rem;
  margin: 0;
  padding: 0.5rem 0.75rem;
  border: 1px solid var(--color-border);
  border-radius: 4px;
  background-color: hsl(0 0% 100% / 10%);
  background-blend-mode: luminosity;
  box-shadow: none;
  font-family: var(--font-body);
  font-size: 1rem;
  font-weight: normal;
  line-height: 1.5;
  color: var(--color-foreground);
  transition: box-shadow 200ms, border-color 50ms ease-out,
    background-color 50ms ease-out, color 50ms ease-out;
}

[data-light] [type="text"],
[data-light] [type="password"],
[data-light] [type="date"],
[data-light] [type="datetime"],
[data-light] [type="datetime-local"],
[data-light] [type="month"],
[data-light] [type="week"],
[data-light] [type="email"],
[data-light] [type="number"],
[data-light] [type="search"],
[data-light] [type="tel"],
[data-light] [type="time"],
[data-light] [type="url"],
[data-light] [type="color"],
[data-light] textarea {
  color: var(--color-background);
  background-color: hsl(0 0% 0% / 10%);
}

[type="text"][aria-invalid="true"],
[type="password"][aria-invalid="true"],
[type="date"][aria-invalid="true"],
[type="datetime"][aria-invalid="true"],
[type="datetime-local"][aria-invalid="true"],
[type="month"][aria-invalid="true"],
[type="week"][aria-invalid="true"],
[type="email"][aria-invalid="true"],
[type="number"][aria-invalid="true"],
[type="search"][aria-invalid="true"],
[type="tel"][aria-invalid="true"],
[type="time"][aria-invalid="true"],
[type="url"][aria-invalid="true"],
[type="color"][aria-invalid="true"],
textarea[aria-invalid="true"] {
  border-color: var(--color-invalid);
}

textarea {
  display: block;
  min-height: 50px;
  max-width: 100%;
}

textarea[rows] {
  height: auto;
}

input:disabled,
input[readonly],
textarea:disabled,
textarea[readonly] {
  opacity: 0.7;
  cursor: not-allowed;
}

[type="file"],
[type="checkbox"],
[type="radio"] {
  margin: 0;
}

[type="file"] {
  width: 100%;
}

label {
  margin: 0;
}

[type="checkbox"] + label,
[type="radio"] + label {
  margin-left: 0.5rem;
}

label > [type="checkbox"],
label > [type="radio"] {
  margin-right: 0.5rem;
}

::placeholder {
  color: hsl(0 0% 100% / 65%);
}

.form-validation-error {
  margin: 0;
  margin-top: 0.25em;
  color: var(--color-invalid);
  font-size: 0.8rem;
}

.error-container {
  background-color: hsla(356, 77%, 59%, 0.747);
  border-radius: 0.25rem;
  padding: 0.5rem 1rem;
}
```

</details>

<details>

<summary>ğŸ’¿ å°†æ­¤å¤åˆ¶åˆ° `app/styles/global-large.css`</summary>

```css filename=app/styles/global-large.css
h1 {
  font-size: 3.75rem;
  line-height: 1;
}

h2 {
  font-size: 1.875rem;
  line-height: 2.25rem;
}

h3 {
  font-size: 1.5rem;
  line-height: 2rem;
}

h4 {
  font-size: 1.25rem;
  line-height: 1.75rem;
}

h5 {
  font-size: 1.125rem;
  line-height: 1.75rem;
}
```

</details>

<details>

<summary>ğŸ’¿ å°†æ­¤å¤åˆ¶åˆ° `app/styles/global-medium.css`</summary>

```css filename=app/styles/global-medium.css
h1 {
  font-size: 3rem;
  line-height: 1;
}

h2 {
  font-size: 2.25rem;
  line-height: 2.5rem;
}

h3 {
  font-size: 1.25rem;
  line-height: 1.75rem;
}

h4 {
  font-size: 1.125rem;
  line-height: 1.75rem;
}

h5,
h6 {
  font-size: 1rem;
  line-height: 1.5rem;
}

.container {
  --gutter: 40px;
}
```

</details>

<details>

<summary>ğŸ’¿ å°†æ­¤å¤åˆ¶åˆ° `app/styles/index.css`</summary>

```css filename=app/styles/index.css
/*
 * å½“ç”¨æˆ·è®¿é—®æ­¤é¡µé¢æ—¶ï¼Œæ­¤æ ·å¼å°†åº”ç”¨ï¼Œå½“ä»–ä»¬ç¦»å¼€æ—¶ï¼Œå®ƒ
 * å°†è¢«å¸è½½ï¼Œå› æ­¤ä¸å¿…å¤ªæ‹…å¿ƒé¡µé¢ä¹‹é—´çš„æ ·å¼å†²çªï¼
 */

body {
  background-image: var(--gradient-background);
}

.container {
  min-height: inherit;
}

.container,
.content {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.content {
  padding-top: 3rem;
  padding-bottom: 3rem;
}

h1 {
  margin: 0;
  text-shadow: 0 3px 0 rgba(0, 0, 0, 0.75);
  text-align: center;
  line-height: 0.5;
}

h1 span {
  display: block;
  font-size: 4.5rem;
  line-height: 1;
  text-transform: uppercase;
  text-shadow: 0 0.2em 0.5em rgba(0, 0, 0, 0.5), 0 5px 0
      rgba(0, 0, 0, 0.75);
}

nav ul {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  gap: 1rem;
  font-family: var(--font-display);
  font-size: 1.125rem;
  line-height: 1;
}

nav ul a:hover {
  text-decoration-style: wavy;
  text-decoration-thickness: 1px;
}

@media print, (min-width: 640px) {
  h1 span {
    font-size: 6rem;
  }

  nav ul {
    font-size: 1.25rem;
    gap: 1.5rem;
  }
}

@media screen and (min-width: 1024px) {
  h1 span {
    font-size: 8rem;
  }
}
```

</details>

<details>

<summary>ğŸ’¿ å°†æ­¤å¤åˆ¶åˆ° `app/styles/jokes.css`</summary>

```css filename=app/styles/jokes.css
.jokes-layout {
  display: flex;
  flex-direction: column;
  min-height: inherit;
}

.jokes-header {
  padding-top: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--color-border);
}

.jokes-header .container {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.jokes-header .home-link {
  font-family: var(--font-display);
  font-size: 3rem;
}

.jokes-header .home-link a {
  color: var(--color-foreground);
}

.jokes-header .home-link a:hover {
  text-decoration: none;
}

.jokes-header .logo-medium {
  display: none;
}

.jokes-header a:hover {
  text-decoration-style: wavy;
  text-decoration-thickness: 1px;
}

.jokes-header .user-info {
  display: flex;
  gap: 1rem;
  align-items: center;
  white-space: nowrap;
}

.jokes-main {
  padding-top: 2rem;
  padding-bottom: 2rem;
  flex: 1 1 100%;
}

.jokes-main .container {
  display: flex;
  gap: 1rem;
}

.jokes-list {
  max-width: 12rem;
}

.jokes-outlet {
  flex: 1;
}

.jokes-footer {
  padding-top: 2rem;
  padding-bottom: 1rem;
  border-top: 1px solid var(--color-border);
}

@media print, (min-width: 640px) {
  .jokes-header .logo {
    display: none;
  }

  .jokes-header .logo-medium {
    display: block;
  }

  .jokes-main {
    padding-top: 3rem;
    padding-bottom: 3rem;
  }
}

@media (max-width: 639px) {
  .jokes-main .container {
    flex-direction: column;
  }
}
```

</details>

ğŸ’¿ å¦å¤–ï¼Œä¸‹è½½ <a href="/jokes-tutorial/baloo/baloo.woff" data-noprefetch target="_blank">è¯¥å­—ä½“</a> å’Œ <a href="/jokes-tutorial/baloo/License.txt" data-noprefetch target="_blank">å…¶è®¸å¯è¯</a> å¹¶å°†å…¶æ”¾åœ¨ `public/fonts/baloo` ä¸­ã€‚

ğŸ’¿ åœ¨æ‚¨ä¸‹è½½èµ„æºæ—¶ï¼Œæ‚¨è¿˜å¯ä»¥ä¸‹è½½ <a href="/jokes-tutorial/social.png" data-noprefetch target="_blank">ç¤¾äº¤å›¾ç‰‡</a> å¹¶å°†å…¶æ”¾åœ¨ `public/social.png`ã€‚æ‚¨ç¨åä¼šéœ€è¦å®ƒã€‚

ğŸ’¿ å°† `links` å¯¼å‡ºæ·»åŠ åˆ° `app/root.tsx` å’Œ `app/routes/jokes.tsx` ä»¥å¼•å…¥ä¸€äº› CSSï¼Œä½¿é¡µé¢çœ‹èµ·æ¥ç¾è§‚ï¼ˆæ³¨æ„ï¼šæ¯ä¸ªæ–‡ä»¶éƒ½æœ‰è‡ªå·±çš„ CSS æ–‡ä»¶ï¼‰ã€‚æ‚¨å¯ä»¥æŸ¥çœ‹ CSSï¼Œå¹¶ä¸ºæ‚¨çš„ JSX å…ƒç´ æ·»åŠ ä¸€äº›ç»“æ„ï¼Œä½¿å…¶çœ‹èµ·æ¥æ›´å…·å¸å¼•åŠ›ã€‚æˆ‘ä¹Ÿå°†æ·»åŠ ä¸€äº›é“¾æ¥ã€‚

<docs-info>`app/root.tsx` å°†æ˜¯é“¾æ¥åˆ° `global` CSS æ–‡ä»¶çš„æ–‡ä»¶ã€‚æ‚¨è®¤ä¸ºâ€œglobalâ€è¿™ä¸ªåç§°å¯¹äºæ ¹è·¯ç”±çš„æ ·å¼æ¥è¯´æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿ</docs-info>

`global-large.css` å’Œ `global-medium.css` æ–‡ä»¶ç”¨äºåŸºäºåª’ä½“æŸ¥è¯¢çš„ CSSã€‚

<docs-info>æ‚¨çŸ¥é“ `<link />` æ ‡ç­¾å¯ä»¥ä½¿ç”¨åª’ä½“æŸ¥è¯¢å—ï¼Ÿ[æŸ¥çœ‹ MDN é¡µé¢å…³äº `<link />`][check-out-the-mdn-page-for-link]ã€‚</docs-info>

<details>

<summary>app/root.tsx</summary>

```tsx filename=app/root.tsx lines=[1,8-10,12-24]
import type { LinksFunction } from "@remix-run/node";
import {
  Links,
  LiveReload,
  Outlet,
} from "@remix-run/react";

import globalLargeStylesUrl from "~/styles/global-large.css";
import globalMediumStylesUrl from "~/styles/global-medium.css";
import globalStylesUrl from "~/styles/global.css";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: globalStylesUrl },
  {
    rel: "stylesheet",
    href: globalMediumStylesUrl,
    media: "print, (min-width: 640px)",
  },
  {
    rel: "stylesheet",
    href: globalLargeStylesUrl,
    media: "screen and (min-width: 1024px)",
  },
];

export default function App() {
  return (
    <html lang="en">
      <head>
        <meta charSet="utf-8" />
        <meta
          name="viewport"
          content="width=device-width, initial-scale=1"
        />
        <title>Remix: So great, it's funny!</title>
        <Links />
      </head>
      <body>
        <Outlet />
        <LiveReload />
      </body>
    </html>
  );
}
```

</details>

<details>

<summary>app/routes/jokes.tsx</summary>

```tsx filename=app/routes/jokes.tsx lines=[1,4,6-8]
import type { LinksFunction } from "@remix-run/node";
import { Link, Outlet } from "@remix-run/react";

import stylesUrl from "~/styles/jokes.css";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

export default function JokesRoute() {
  return (
    <div className="jokes-layout">
      <header className="jokes-header">
        <div className="container">
          <h1 className="home-link">
            <Link
              to="/"
              title="Remix Jokes"
              aria-label="Remix Jokes"
            >
              <span className="logo">ğŸ¤ª</span>
              <span className="logo-medium">JğŸ¤ªKES</span>
            </Link>
          </h1>
        </div>
      </header>
      <main className="jokes-main">
        <div className="container">
          <div className="jokes-list">
            <Link to=".">è·å–ä¸€ä¸ªéšæœºç¬‘è¯</Link>
            <p>è¿™é‡Œè¿˜æœ‰ä¸€äº›ç¬‘è¯å¯ä»¥æŸ¥çœ‹ï¼š</p>
            <ul>
              <li>
                <Link to="some-joke-id">æ²³é©¬</Link>
              </li>
            </ul>
            <Link to="new" className="button">
              æ·»åŠ ä½ è‡ªå·±çš„
            </Link>
          </div>
          <div className="jokes-outlet">
            <Outlet />
          </div>
        </div>
      </main>
    </div>
  );
}
```

</details>

ğŸ’¿ è®©æˆ‘ä»¬ä»ä¸»é¡µæ·»åŠ ä¸€ä¸ªæŒ‡å‘ç¬‘è¯çš„é“¾æ¥ï¼Œå¹¶éµå¾ª CSS ä¸­çš„ä¸€äº›ç±»åï¼Œä½¿ä¸»é¡µçœ‹èµ·æ¥ç¾è§‚ã€‚

<details>

<summary>app/routes/_index.tsx</summary>

```tsx filename=app/routes/_index.tsx lines=[2,11-26]
import type { LinksFunction } from "@remix-run/node";
import { Link } from "@remix-run/react";

import stylesUrl from "~/styles/index.css";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

export default function IndexRoute() {
  return (
    <div className="container">
      <div className="content">
        <h1>
          Remix <span>ç¬‘è¯ï¼</span>
        </h1>
        <nav>
          <ul>
            <li>
              <Link to="jokes">é˜…è¯»ç¬‘è¯</Link>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  );
}
```

</details>

åœ¨æˆ‘ä»¬å®Œæˆæ•™ç¨‹çš„å…¶ä½™éƒ¨åˆ†æ—¶ï¼Œæ‚¨å¯èƒ½å¸Œæœ›æ£€æŸ¥è¿™äº› CSS æ–‡ä»¶ä¸­çš„ç±»åï¼Œä»¥ä¾¿å……åˆ†åˆ©ç”¨è¿™äº› CSSã€‚

å…³äº CSS çš„ä¸€ä¸ªå¿«é€Ÿè¯´æ˜ã€‚è®¸å¤šäººå¯èƒ½ä¹ æƒ¯äºä½¿ç”¨è¿è¡Œæ—¶åº“æ¥å¤„ç† CSSï¼ˆå¦‚ [Styled-Components][styled-components]ï¼‰ã€‚è™½ç„¶æ‚¨å¯ä»¥åœ¨ Remix ä¸­ä½¿ç”¨è¿™äº›ï¼Œä½†æˆ‘ä»¬å¸Œæœ›é¼“åŠ±æ‚¨è€ƒè™‘æ›´ä¼ ç»Ÿçš„ CSS å¤„ç†æ–¹æ³•ã€‚å¯¼è‡´è¿™äº›æ ·å¼è§£å†³æ–¹æ¡ˆå‡ºç°çš„è®¸å¤šé—®é¢˜åœ¨ Remix ä¸­å¹¶ä¸æ˜¯é—®é¢˜ï¼Œå› æ­¤æ‚¨é€šå¸¸å¯ä»¥é‡‡ç”¨æ›´ç®€å•çš„æ ·å¼å¤„ç†æ–¹æ³•ã€‚

è¯è™½å¦‚æ­¤ï¼Œè®¸å¤š Remix ç”¨æˆ·å¯¹ [Tailwind CSS][tailwind] æ„Ÿåˆ°éå¸¸æ»¡æ„ï¼Œæˆ‘ä»¬æ¨èè¿™ç§æ–¹æ³•ã€‚åŸºæœ¬ä¸Šï¼Œå¦‚æœå®ƒå¯ä»¥ç»™æ‚¨ä¸€ä¸ª URLï¼ˆæˆ–ä¸€ä¸ªå¯ä»¥å¯¼å…¥ä»¥è·å– URL çš„ CSS æ–‡ä»¶ï¼‰ï¼Œé‚£ä¹ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¥½æ–¹æ³•ï¼Œå› ä¸º Remix å¯ä»¥åˆ©ç”¨æµè§ˆå™¨å¹³å°è¿›è¡Œç¼“å­˜å’ŒåŠ è½½/å¸è½½ã€‚

## æ•°æ®åº“

å¤§å¤šæ•°ç°å®ä¸–ç•Œçš„åº”ç”¨ç¨‹åºéƒ½éœ€è¦æŸç§å½¢å¼çš„æ•°æ®æŒä¹…æ€§ã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬æƒ³å°†ç¬‘è¯ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œä»¥ä¾¿äººä»¬å¯ä»¥äº«å—æˆ‘ä»¬çš„å¹½é»˜ï¼Œç”šè‡³æäº¤ä»–ä»¬è‡ªå·±çš„ç¬‘è¯ï¼ˆå³å°†åœ¨èº«ä»½éªŒè¯éƒ¨åˆ†æ¨å‡ºï¼ï¼‰ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•æ‚¨å–œæ¬¢çš„æŒä¹…æ€§è§£å†³æ–¹æ¡ˆä¸ Remixï¼›[Firebase][firebase]ã€[Supabase][supabase]ã€[Airtable][airtable]ã€[Hasura][hasura]ã€[Google Spreadsheets][google-spreadsheets]ã€[Cloudflare Workers KV][cloudflare-workers-kv]ã€[Fauna][fauna]ã€è‡ªå®šä¹‰çš„ [PostgreSQL][postgre-sql]ï¼Œç”šè‡³æ˜¯æ‚¨åç«¯å›¢é˜Ÿçš„ REST/GraphQL APIã€‚è®¤çœŸåœ°è¯´ã€‚éšæ‚¨æ‰€æ„¿ã€‚

### è®¾ç½® Prisma

<docs-info>Prisma å›¢é˜Ÿæ„å»ºäº†ä¸€ä¸ª [VSCode æ‰©å±•][a-vs-code-extension]ï¼Œåœ¨å¤„ç† Prisma schema æ—¶å¯èƒ½ä¼šéå¸¸æœ‰å¸®åŠ©ã€‚</docs-info>

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è‡ªå·±çš„ [SQLite][sq-lite] æ•°æ®åº“ã€‚åŸºæœ¬ä¸Šï¼Œå®ƒæ˜¯ä¸€ä¸ªå­˜å‚¨åœ¨æ‚¨è®¡ç®—æœºæ–‡ä»¶ä¸­çš„æ•°æ®åº“ï¼ŒåŠŸèƒ½å‡ºä¹æ„æ–™åœ°å¼ºå¤§ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œå®ƒå¾—åˆ°äº†æˆ‘ä»¬æœ€å–œæ¬¢çš„æ•°æ®åº“ ORM [Prisma][prisma] çš„æ”¯æŒï¼å¦‚æœæ‚¨ä¸ç¡®å®šä½¿ç”¨å“ªä¸ªæ•°æ®åº“ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ã€‚

æˆ‘ä»¬éœ€è¦ä¸¤ä¸ªåŒ…æ¥å¼€å§‹ï¼š

- `prisma` ç”¨äºåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¸æˆ‘ä»¬çš„æ•°æ®åº“å’Œ schema äº¤äº’ã€‚
- `@prisma/client` ç”¨äºåœ¨è¿è¡Œæ—¶å¯¹æˆ‘ä»¬çš„æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢ã€‚

ğŸ’¿ å®‰è£… Prisma åŒ…ï¼š

```shellscript nonumber
npm install --save-dev prisma
npm install @prisma/client
```

ğŸ’¿ ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ SQLite åˆå§‹åŒ– Prismaï¼š

```shellscript nonumber
npx prisma init --datasource-provider sqlite
```

è¿™å°†ç»™æˆ‘ä»¬ä»¥ä¸‹è¾“å‡ºï¼š

```
âœ” Your Prisma schema was created at prisma/schema.prisma
  You can now open it in your favorite editor.

warn You already have a .gitignore file. Don't forget to add `.env` in it to not commit any private information.

Next steps:
1. Set the DATABASE_URL in the .env file to point to your existing database. If your database has no tables yet, read https://pris.ly/d/getting-started
2. Run prisma db pull to turn your database schema into a Prisma schema.
3. Run prisma generate to generate the Prisma Client. You can then start querying your database.

More information in our documentation:
https://pris.ly/d/getting-started
```

ç°åœ¨æˆ‘ä»¬å·²ç»åˆå§‹åŒ–äº† Prismaï¼Œå¯ä»¥å¼€å§‹å»ºæ¨¡æˆ‘ä»¬çš„åº”ç”¨æ•°æ®ã€‚å› ä¸ºè¿™ä¸æ˜¯ä¸€ä¸ª Prisma æ•™ç¨‹ï¼Œæˆ‘å°†ç›´æ¥ç»™ä½ è¿™ä¸ªï¼Œä½ å¯ä»¥ä» [ä»–ä»¬çš„æ–‡æ¡£][their-docs] ä¸­äº†è§£æ›´å¤šå…³äº Prisma schema çš„ä¿¡æ¯ï¼š

```prisma filename=prisma/schema.prisma lines=[13-19]
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Joke {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  name       String
  content    String
}
```

ğŸ’¿ æœ‰äº†è¿™äº›ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```shellscript nonumber
npx prisma db push
```

æ­¤å‘½ä»¤å°†ç»™æ‚¨ä»¥ä¸‹è¾“å‡ºï¼š

```
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": SQLite database "dev.db" at "file:./dev.db"

SQLite database dev.db created at file:./dev.db

ğŸš€  Your database is now in sync with your Prisma schema. Done in 39ms

âœ” Generated Prisma Client (4.12.0 | library) to ./node_modules/@prisma/client in 26ms
```

æ­¤å‘½ä»¤åšäº†å‡ ä»¶äº‹æƒ…ã€‚ä¸€æ–¹é¢ï¼Œå®ƒåœ¨ `prisma/dev.db` ä¸­åˆ›å»ºäº†æˆ‘ä»¬çš„æ•°æ®åº“æ–‡ä»¶ã€‚ç„¶åï¼Œå®ƒå°†æ‰€æœ‰å¿…è¦çš„æ›´æ”¹æ¨é€åˆ°æˆ‘ä»¬çš„æ•°æ®åº“ï¼Œä»¥åŒ¹é…æˆ‘ä»¬æä¾›çš„ schemaã€‚æœ€åï¼Œå®ƒç”Ÿæˆäº† Prisma çš„ TypeScript ç±»å‹ï¼Œå› æ­¤åœ¨ä½¿ç”¨å…¶ API ä¸æ•°æ®åº“äº¤äº’æ—¶ï¼Œæˆ‘ä»¬å°†è·å¾—å‡ºè‰²çš„è‡ªåŠ¨è¡¥å…¨å’Œç±»å‹æ£€æŸ¥ã€‚

ğŸ’¿ è®©æˆ‘ä»¬å°† `prisma/dev.db` æ·»åŠ åˆ°æˆ‘ä»¬çš„ `.gitignore` ä¸­ï¼Œä»¥å…æ„å¤–æäº¤åˆ°æˆ‘ä»¬çš„ä»£ç åº“ã€‚å¦‚ Prisma è¾“å‡ºä¸­æ‰€æåˆ°çš„ï¼Œæˆ‘ä»¬ä¸æƒ³æäº¤æˆ‘ä»¬çš„ç§˜å¯†ï¼Œå› æ­¤æ‚¨çš„ `.env` æ–‡ä»¶å·²ç»è‡ªåŠ¨æ·»åŠ åˆ° `.gitignore` ä¸­ï¼

```text filename=.gitignore lines=[8]
node_modules

/.cache
/build
/public/build
.env

/prisma/dev.db
```

<docs-warning>å¦‚æœæ‚¨çš„æ•°æ®åº“å‡ºç°é—®é¢˜ï¼Œæ‚¨å¯ä»¥éšæ—¶åˆ é™¤ `prisma/dev.db` æ–‡ä»¶å¹¶å†æ¬¡è¿è¡Œ `npx prisma db push`ã€‚</docs-warning>

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªå°æ–‡ä»¶ï¼Œç”¨äºç”¨æµ‹è¯•æ•°æ®â€œå¡«å……â€æˆ‘ä»¬çš„æ•°æ®åº“ã€‚åŒæ ·ï¼Œè¿™å¹¶ä¸æ˜¯ç‰¹å®šäº remix çš„å†…å®¹ï¼Œæ‰€ä»¥æˆ‘å°†ç›´æ¥ç»™ä½ è¿™ä¸ªï¼ˆåˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬å¾ˆå¿«ä¼šå›åˆ° remixï¼‰ï¼š

ğŸ’¿ å°†æ­¤å†…å®¹å¤åˆ¶åˆ°ä¸€ä¸ªåä¸º `prisma/seed.ts` çš„æ–°æ–‡ä»¶ä¸­ï¼š

```ts filename=prisma/seed.ts
import { PrismaClient } from "@prisma/client";
const db = new PrismaClient();

async function seed() {
  await Promise.all(
    getJokes().map((joke) => {
      return db.joke.create({ data: joke });
    })
  );
}

seed();

function getJokes() {
  // shout-out to https://icanhazdadjoke.com/

  return [
    {
      name: "Road worker",
      content: `I never wanted to believe that my Dad was stealing from his job as a road worker. But when I got home, all the signs were there.`,
    },
    {
      name: "Frisbee",
      content: `I was wondering why the frisbee was getting bigger, then it hit me.`,
    },
    {
      name: "Trees",
      content: `Why do trees seem suspicious on sunny days? Dunno, they're just a bit shady.`,
    },
    {
      name: "Skeletons",
      content: `Why don't skeletons ride roller coasters? They don't have the stomach for it.`,
    },
    {
      name: "Hippos",
      content: `Why don't you find hippopotamuses hiding in trees? They're really good at it.`,
    },
    {
      name: "Dinner",
      content: `What did one plate say to the other plate? Dinner is on me!`,
    },
    {
      name: "Elevator",
      content: `My first time using an elevator was an uplifting experience. The second time let me down.`,
    },
  ];
}
```

å¦‚æœæ‚¨æ„¿æ„ï¼Œå¯ä»¥éšæ„æ·»åŠ è‡ªå·±çš„ç¬‘è¯ã€‚

ç°åœ¨æˆ‘ä»¬åªéœ€è¿è¡Œè¿™ä¸ªæ–‡ä»¶ã€‚æˆ‘ä»¬ç”¨ TypeScript ç¼–å†™å®ƒä»¥è·å¾—ç±»å‹å®‰å…¨ï¼ˆéšç€æˆ‘ä»¬çš„åº”ç”¨å’Œæ•°æ®æ¨¡å‹å¤æ‚æ€§çš„å¢åŠ ï¼Œè¿™å°†å˜å¾—æ›´åŠ æœ‰ç”¨ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥è¿è¡Œå®ƒã€‚

ğŸ’¿ å®‰è£… `ts-node` å’Œ `tsconfig-paths` ä½œä¸ºå¼€å‘ä¾èµ–ï¼š

```shellscript nonumber
npm install --save-dev ts-node tsconfig-paths
```

ğŸ’¿ ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œæˆ‘ä»¬çš„ `seed.ts` æ–‡ä»¶ï¼š

```shellscript nonumber
npx ts-node --require tsconfig-paths/register prisma/seed.ts
```

ç°åœ¨æˆ‘ä»¬çš„æ•°æ®åº“ä¸­å·²ç»æœ‰äº†è¿™äº›ç¬‘è¯ã€‚æ²¡å¼€ç©ç¬‘ï¼

ä½†æˆ‘ä¸æƒ³æ¯æ¬¡é‡ç½®æ•°æ®åº“æ—¶éƒ½è®°å¾—è¿è¡Œè¿™ä¸ªè„šæœ¬ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸å¿…è¿™æ ·åšï¼

ğŸ’¿ å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°æ‚¨çš„ `package.json` ä¸­ï¼š

```json filename=package.json nocopy
{
  "prisma": {
    "seed": "ts-node --require tsconfig-paths/register prisma/seed.ts"
  }
}
```

ç°åœ¨ï¼Œæ¯å½“æˆ‘ä»¬é‡ç½®æ•°æ®åº“æ—¶ï¼ŒPrisma ä¹Ÿä¼šè°ƒç”¨æˆ‘ä»¬çš„å¡«å……æ–‡ä»¶ã€‚

### è¿æ¥åˆ°æ•°æ®åº“

å¥½çš„ï¼Œæˆ‘ä»¬éœ€è¦åšçš„æœ€åä¸€ä»¶äº‹æ˜¯è¿æ¥åˆ°æˆ‘ä»¬åº”ç”¨ä¸­çš„æ•°æ®åº“ã€‚æˆ‘ä»¬åœ¨ `prisma/seed.ts` æ–‡ä»¶çš„é¡¶éƒ¨å®Œæˆè¿™ä¸€æ“ä½œï¼š

```ts nocopy
import { PrismaClient } from "@prisma/client";
const db = new PrismaClient();
```

è¿™æ ·åšæ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†é—®é¢˜åœ¨äºï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸æƒ³æ¯æ¬¡å¯¹æœåŠ¡å™¨ç«¯è¿›è¡Œæ›´æ”¹æ—¶éƒ½å…³é—­å¹¶å®Œå…¨é‡å¯æœåŠ¡å™¨ã€‚å› æ­¤ï¼Œ`@remix-run/serve` å®é™…ä¸Šä¼šé‡å»ºæˆ‘ä»¬çš„ä»£ç å¹¶å…¨æ–°åŠ è½½ã€‚é—®é¢˜æ˜¯æ¯æ¬¡æˆ‘ä»¬è¿›è¡Œä»£ç æ›´æ”¹æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®åº“è¿æ¥ï¼Œæœ€ç»ˆä¼šç”¨å°½è¿æ¥ï¼è¿™æ˜¯æ•°æ®åº“è®¿é—®åº”ç”¨ä¸­éå¸¸å¸¸è§çš„é—®é¢˜ï¼ŒPrismaå¯¹æ­¤æœ‰ä¸€ä¸ªè­¦å‘Šï¼š

> è­¦å‘Šï¼š10ä¸ªPrismaå®¢æˆ·ç«¯å·²ç»åœ¨è¿è¡Œ

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›é¢å¤–çš„å·¥ä½œæ¥é¿å…è¿™ä¸ªå¼€å‘æ—¶çš„é—®é¢˜ã€‚

è¯·æ³¨æ„ï¼Œè¿™å¹¶ä¸æ˜¯ä»…é™äºRemixçš„é—®é¢˜ã€‚æ¯å½“æ‚¨æœ‰â€œå®æ—¶é‡è½½â€æœåŠ¡å™¨ä»£ç æ—¶ï¼Œæ‚¨éƒ½éœ€è¦æ–­å¼€å¹¶é‡æ–°è¿æ¥åˆ°æ•°æ®åº“ï¼ˆè¿™å¯èƒ½ä¼šå¾ˆæ…¢ï¼‰ï¼Œæˆ–è€…ä½¿ç”¨ [`global` å•ä¾‹è§£å†³æ–¹æ³•][global-singleton-workaround]ã€‚

ğŸ’¿ å°†æ­¤å¤åˆ¶åˆ°ä¸¤ä¸ªæ–°æ–‡ä»¶ä¸­ï¼Œå‘½åä¸º `app/utils/singleton.server.ts` å’Œ `app/utils/db.server.ts`

```ts filename=app/utils/singleton.server.ts
export const singleton = <Value>(
  name: string,
  valueFactory: () => Value
): Value => {
  const g = global as any;
  g.__singletons ??= {};
  g.__singletons[name] ??= valueFactory();
  return g.__singletons[name];
};
```

```ts filename=app/utils/db.server.ts
import { PrismaClient } from "@prisma/client";

import { singleton } from "./singleton.server";

// ç¡¬ç¼–ç ä¸€ä¸ªå”¯ä¸€é”®ï¼Œä»¥ä¾¿åœ¨æ­¤æ¨¡å—é‡æ–°å¯¼å…¥æ—¶æŸ¥æ‰¾å®¢æˆ·ç«¯
export const db = singleton(
  "prisma",
  () => new PrismaClient()
);
```

æˆ‘å°†æŠŠå¯¹è¿™æ®µä»£ç çš„åˆ†æç•™ç»™è¯»è€…ï¼Œå› ä¸ºè¿™ä¸Remixæ²¡æœ‰ç›´æ¥å…³ç³»ã€‚

æˆ‘æƒ³æŒ‡å‡ºçš„ä¸€ä»¶äº‹æ˜¯æ–‡ä»¶å‘½åçº¦å®šã€‚æ–‡ä»¶åä¸­çš„ `.server` éƒ¨åˆ†å‘ŠçŸ¥Remixè¿™æ®µä»£ç ç»ä¸åº”å‡ºç°åœ¨æµè§ˆå™¨ä¸­ã€‚è¿™æ˜¯å¯é€‰çš„ï¼Œå› ä¸ºRemixåœ¨ç¡®ä¿æœåŠ¡å™¨ä»£ç ä¸å‡ºç°åœ¨å®¢æˆ·ç«¯æ–¹é¢åšå¾—å¾ˆå¥½ã€‚ä½†æœ‰æ—¶ä¸€äº›ä»…é™æœåŠ¡å™¨çš„ä¾èµ–é¡¹å¾ˆéš¾è¿›è¡Œæ ‘æ‘‡ï¼Œå› æ­¤åœ¨æ–‡ä»¶åä¸­æ·»åŠ  `.server` æ˜¯å¯¹ç¼–è¯‘å™¨çš„æç¤ºï¼Œä»¥ä¾¿åœ¨ä¸ºæµè§ˆå™¨æ‰“åŒ…æ—¶ä¸å¿…æ‹…å¿ƒæ­¤æ¨¡å—æˆ–å…¶å¯¼å…¥ã€‚`.server` å……å½“ç¼–è¯‘å™¨çš„ä¸€ç§è¾¹ç•Œã€‚

### ä»æ•°æ®åº“è¯»å–æ•°æ®åˆ° Remix loader

å¥½å§ï¼Œå‡†å¤‡å¥½ç»§ç»­ç¼–å†™ Remix ä»£ç äº†å—ï¼Ÿæˆ‘ä¹Ÿæ˜¯ï¼

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åœ¨ `/jokes` è·¯ç”±ä¸Šæ”¾ç½®ä¸€ä¸ªç¬‘è¯åˆ—è¡¨ï¼Œä»¥ä¾¿äººä»¬å¯ä»¥é€‰æ‹©ç¬‘è¯é“¾æ¥ã€‚åœ¨ Remix ä¸­ï¼Œæ¯ä¸ªè·¯ç”±æ¨¡å—è´Ÿè´£è·å–è‡ªå·±çš„æ•°æ®ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åœ¨ `/jokes` è·¯ç”±ä¸Šè·å–æ•°æ®ï¼Œæˆ‘ä»¬å°†æ›´æ–° `app/routes/jokes.tsx` æ–‡ä»¶ã€‚

è¦åœ¨ Remix è·¯ç”±æ¨¡å—ä¸­ _åŠ è½½_ æ•°æ®ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ä¸€ä¸ª [`loader`][loader]ã€‚è¿™åªæ˜¯ä¸€ä¸ªæ‚¨å¯¼å‡ºçš„ `async` å‡½æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ªå“åº”ï¼Œå¹¶é€šè¿‡ [`useLoaderData`][use-loader-data] é’©å­åœ¨ç»„ä»¶ä¸­è®¿é—®ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¿«é€Ÿç¤ºä¾‹ï¼š

```tsx nocopy
// this is just an example. No need to copy/paste this ğŸ˜„
import { json } from "@remix-run/node";
import { useLoaderData } from "@remix-run/react";

import { db } from "~/utils/db.server";

export const loader = async () => {
  return json({
    sandwiches: await db.sandwich.findMany(),
  });
};

export default function Sandwiches() {
  const data = useLoaderData<typeof loader>();
  return (
    <ul>
      {data.sandwiches.map((sandwich) => (
        <li key={sandwich.id}>{sandwich.name}</li>
      ))}
    </ul>
  );
}
```

è¿™ç»™äº†ä½ ä¸€ä¸ªå…³äºè¯¥æ€ä¹ˆåšçš„å¥½ä¸»æ„å—ï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹æˆ‘åœ¨ä¸‹é¢çš„ `<details>` ä¸­çš„è§£å†³æ–¹æ¡ˆ ğŸ˜„

<docs-info>

Remix å’Œæ‚¨ä»å¯åŠ¨æ¨¡æ¿ä¸­è·å¾—çš„ `tsconfig.json` è¢«é…ç½®ä¸ºå…è®¸é€šè¿‡ `~` ä» `app/` ç›®å½•å¯¼å…¥ï¼Œå¦‚ä¸Šæ‰€ç¤ºï¼Œå› æ­¤æ‚¨ä¸éœ€è¦åˆ°å¤„éƒ½æ˜¯ `../../`ã€‚

</docs-info>

ğŸ’¿ æ›´æ–° `app/routes/jokes.tsx` è·¯ç”±æ¨¡å—ä»¥ä»æˆ‘ä»¬çš„æ•°æ®åº“åŠ è½½ç¬‘è¯å¹¶å‘ˆç°ç¬‘è¯é“¾æ¥åˆ—è¡¨ã€‚

<details>

<summary>app/routes/jokes.tsx</summary>

```tsx filename=app/routes/jokes.tsx lines=[2,6,10,16-20,23,47-51]
import type { LinksFunction } from "@remix-run/node";
import { json } from "@remix-run/node";
import {
  Link,
  Outlet,
  useLoaderData,
} from "@remix-run/react";

import stylesUrl from "~/styles/jokes.css";
import { db } from "~/utils/db.server";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

export const loader = async () => {
  return json({
    jokeListItems: await db.joke.findMany(),
  });
};

export default function JokesRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div className="jokes-layout">
      <header className="jokes-header">
        <div className="container">
          <h1 className="home-link">
            <Link
              to="/"
              title="Remix Jokes"
              aria-label="Remix Jokes"
            >
              <span className="logo">ğŸ¤ª</span>
              <span className="logo-medium">JğŸ¤ªKES</span>
            </Link>
          </h1>
        </div>
      </header>
      <main className="jokes-main">
        <div className="container">
          <div className="jokes-list">
            <Link to=".">è·å–ä¸€ä¸ªéšæœºç¬‘è¯</Link>
            <p>è¿™é‡Œè¿˜æœ‰æ›´å¤šç¬‘è¯ä¾›æ‚¨æŸ¥çœ‹ï¼š</p>
            <ul>
              {data.jokeListItems.map(({ id, name }) => (
                <li key={id}>
                  <Link to={id}>{name}</Link>
                </li>
              ))}
            </ul>
            <Link to="new" className="button">
              æ·»åŠ æ‚¨è‡ªå·±çš„
            </Link>
          </div>
          <div className="jokes-outlet">
            <Outlet />
          </div>
        </div>
      </main>
    </div>
  );
}
```

</details>

ç°åœ¨æˆ‘ä»¬æœ‰äº†è¿™ä¸ªï¼š

![List of links to jokes][list-of-links-to-jokes]

### æ•°æ®è¿‡åº¦è·å–

æˆ‘æƒ³åœ¨æˆ‘çš„è§£å†³æ–¹æ¡ˆä¸­æŒ‡å‡ºä¸€äº›å…·ä½“çš„å†…å®¹ã€‚è¿™æ˜¯æˆ‘çš„åŠ è½½å™¨ï¼š

```tsx lines=[3-7]
export const loader = async () => {
  return json({
    jokeListItems: await db.joke.findMany({
      orderBy: { createdAt: "desc" },
      select: { id: true, name: true },
      take: 5,
    }),
  });
};
```

è¯·æ³¨æ„ï¼Œæˆ‘è¿™ä¸ªé¡µé¢æ‰€éœ€çš„ä»…ä»…æ˜¯ç¬‘è¯çš„ `id` å’Œ `name`ã€‚æˆ‘ä¸éœ€è¦è·å– `content`ã€‚æˆ‘è¿˜é™åˆ¶äº†æ€»å…± 5 ä¸ªé¡¹ç›®ï¼Œå¹¶æŒ‰åˆ›å»ºæ—¥æœŸæ’åºï¼Œä»¥ä¾¿è·å–æœ€æ–°çš„ç¬‘è¯ã€‚å› æ­¤ï¼Œé€šè¿‡ `prisma`ï¼Œæˆ‘å¯ä»¥å°†æŸ¥è¯¢æ”¹ä¸ºæ­£å¥½æ»¡è¶³æˆ‘çš„éœ€æ±‚ï¼Œé¿å…å‘å®¢æˆ·ç«¯å‘é€è¿‡å¤šçš„æ•°æ®ï¼è¿™ä½¿æˆ‘çš„åº”ç”¨ç¨‹åºå¯¹ç”¨æˆ·æ¥è¯´æ›´å¿«ã€æ›´å“åº”ã€‚

ä¸ºäº†è®©äº‹æƒ…å˜å¾—æ›´é…·ï¼Œä½ ä¸ä¸€å®šéœ€è¦ Prisma æˆ–ç›´æ¥çš„æ•°æ®åº“è®¿é—®æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ä½ æœ‰ä¸€ä¸ª GraphQL åç«¯åœ¨ä½¿ç”¨ï¼Ÿå¤ªå¥½äº†ï¼Œåœ¨ä½ çš„åŠ è½½å™¨ä¸­ä½¿ç”¨ä½ å¸¸è§„çš„ GraphQL å†…å®¹ã€‚è¿™æ ·åšç”šè‡³æ¯”åœ¨å®¢æˆ·ç«¯æ›´å¥½ï¼Œå› ä¸ºä½ ä¸éœ€è¦æ‹…å¿ƒå°†ä¸€ä¸ª [åºå¤§çš„ GraphQL å®¢æˆ·ç«¯][huge-graphql-client] å‘é€åˆ°å®¢æˆ·ç«¯ã€‚å°†å…¶ä¿ç•™åœ¨æœåŠ¡å™¨ä¸Šï¼Œå¹¶è¿‡æ»¤å‡ºä½ æƒ³è¦çš„å†…å®¹ã€‚

å“¦ï¼Œä½ åªæ˜¯æœ‰ REST ç«¯ç‚¹ï¼Ÿé‚£ä¹Ÿæ²¡é—®é¢˜ï¼ä½ å¯ä»¥è½»æ¾åœ°åœ¨åŠ è½½å™¨ä¸­è¿‡æ»¤æ‰å¤šä½™çš„æ•°æ®ã€‚å› ä¸ºè¿™ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨æœåŠ¡å™¨ä¸Šï¼Œä½ å¯ä»¥è½»æ¾èŠ‚çœç”¨æˆ·çš„ä¸‹è½½å¤§å°ï¼Œè€Œä¸å¿…è¯´æœä½ çš„åç«¯å·¥ç¨‹å¸ˆæ›´æ”¹ä»–ä»¬æ•´ä¸ª APIã€‚å¾ˆä¸é”™ï¼

è¿‡æ»¤æ‰ä½ ä¸æ¸²æŸ“çš„æ•°æ®ä¸ä»…ä»…æ˜¯ä¸ºäº†å‡å°‘ä¼ è¾“çš„æ•°æ®é‡ï¼Œä½ è¿˜åº”è¯¥è¿‡æ»¤æ‰ä»»ä½•ä½ ä¸å¸Œæœ›æš´éœ²ç»™å®¢æˆ·ç«¯çš„æ•æ„Ÿæ•°æ®ã€‚

<docs-error>
æ— è®ºä½ ä»åŠ è½½å™¨è¿”å›ä»€ä¹ˆï¼Œéƒ½å°†æš´éœ²ç»™å®¢æˆ·ç«¯ï¼Œå³ä½¿ç»„ä»¶æ²¡æœ‰æ¸²æŸ“å®ƒã€‚å¯¹å¾…ä½ çš„åŠ è½½å™¨è¦åƒå¯¹å¾…å…¬å…± API ç«¯ç‚¹ä¸€æ ·å°å¿ƒã€‚
</docs-error>

### ç½‘ç»œç±»å‹å®‰å…¨

åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `useLoaderData` çš„ç±»å‹æ³›å‹å¹¶ä¼ é€’äº†æˆ‘ä»¬çš„ `loader`ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥è·å¾—è‰¯å¥½çš„è‡ªåŠ¨è¡¥å…¨ï¼Œä½†è¿™å¹¶æ²¡æœ‰çœŸæ­£ä¸ºæˆ‘ä»¬æä¾›ç±»å‹å®‰å…¨ï¼Œå› ä¸º `loader` å’Œ `useLoaderData` æ­£åœ¨å®Œå…¨ä¸åŒçš„ç¯å¢ƒä¸­è¿è¡Œã€‚Remix ç¡®ä¿æˆ‘ä»¬è·å¾—æœåŠ¡å™¨å‘é€çš„å†…å®¹ï¼Œä½†è°çœŸçš„çŸ¥é“å‘¢ï¼Ÿä¹Ÿè®¸åœ¨ä¸€æ¬¡æ„¤æ€’ä¸­ï¼Œä½ çš„åŒäº‹å°†æœåŠ¡å™¨è®¾ç½®ä¸ºè‡ªåŠ¨åˆ é™¤ä¸ç‹—ç›¸å…³çš„å¼•ç”¨ï¼ˆä»–ä»¬æ›´å–œæ¬¢çŒ«ï¼‰ã€‚

å› æ­¤ï¼Œè¦çœŸæ­£ç¡®ä¿ä½ çš„æ•°æ®æ˜¯æ­£ç¡®çš„ï¼Œä½ åº”è¯¥åœ¨ä» `useLoaderData` è¿”å›çš„ `data` ä¸Šä½¿ç”¨ [assertion functions][assertion-functions]ã€‚è¿™è¶…å‡ºäº†æœ¬æ•™ç¨‹çš„èŒƒå›´ï¼Œä½†æˆ‘ä»¬æ¨è [zod][zod]ï¼Œå®ƒå¯ä»¥åœ¨è¿™æ–¹é¢æä¾›å¸®åŠ©ã€‚

### å®Œæˆæ•°æ®åº“æŸ¥è¯¢

åœ¨æˆ‘ä»¬è¿›å…¥ `/jokes/:jokeId` è·¯ç”±ä¹‹å‰ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå¿«é€Ÿç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨åŠ è½½å™¨ä¸­è®¿é—®å‚æ•°ï¼ˆå¦‚ `:jokeId`ï¼‰ã€‚

```tsx nocopy
export const loader = async ({
  params,
}: LoaderFunctionArgs) => {
  console.log(params); // <-- {jokeId: "123"}
};
```

æ¥ä¸‹æ¥æ˜¯å¦‚ä½•ä» Prisma è·å–ç¬‘è¯ï¼š

```tsx nocopy
const joke = await db.joke.findUnique({
  where: { id: jokeId },
});
```

<docs-warning>è¯·è®°ä½ï¼Œå½“æˆ‘ä»¬å¼•ç”¨ URL è·¯ç”±æ—¶ï¼Œå®ƒæ˜¯ `/jokes/:jokeId`ï¼Œè€Œå½“æˆ‘ä»¬è°ˆè®ºæ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œå®ƒæ˜¯ `/app/routes/jokes.$jokeId.tsx`ã€‚</docs-warning>

ğŸ’¿ å¤ªå¥½äº†ï¼ç°åœ¨ä½ çŸ¥é“äº†ç»§ç»­å¹¶è¿æ¥ `/jokes/:jokeId` è·¯ç”±åœ¨ `app/routes/jokes.$jokeId.tsx` ä¸­æ‰€éœ€çš„ä¸€åˆ‡ã€‚

<details>

<summary>app/routes/jokes.$jokeId.tsx</summary>

```tsx filename=app/routes/jokes.$jokeId.tsx lines=[1-3,5,7-17,20,25-26]
import type { LoaderFunctionArgs } from "@remix-run/node";
import { json } from "@remix-run/node";
import { Link, useLoaderData } from "@remix-run/react";

import { db } from "~/utils/db.server";

export const loader = async ({
  params,
}: LoaderFunctionArgs) => {
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Error("Joke not found");
  }
  return json({ joke });
};

export default function JokeRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div>
      <p>è¿™æ˜¯ä½ çš„æç¬‘ç¬‘è¯ï¼š</p>
      <p>{data.joke.content}</p>
      <Link to=".">"{data.joke.name}" æ°¸ä¹…é“¾æ¥</Link>
    </div>
  );
}
```

</details>

è¿™æ ·ä½ å°±å¯ä»¥è®¿é—® [`/jokes`][jokes] å¹¶ç‚¹å‡»é“¾æ¥è·å–ç¬‘è¯ï¼š

![Jokes page showing a unique joke][jokes-page-showing-a-unique-joke]

æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚å¤„ç†ä¸­ï¼Œå¤„ç†æœ‰äººå°è¯•è®¿é—®æ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„ç¬‘è¯çš„æƒ…å†µã€‚

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å¤„ç† `app/routes/jokes._index.tsx` ä¸­çš„ `/jokes` ç´¢å¼•è·¯ç”±ï¼Œä»¥æ˜¾ç¤ºä¸€ä¸ªéšæœºç¬‘è¯ã€‚

ä»¥ä¸‹æ˜¯å¦‚ä½•ä» Prisma è·å–éšæœºç¬‘è¯ï¼š

```tsx
const count = await db.joke.count();
const randomRowNumber = Math.floor(Math.random() * count);
const [randomJoke] = await db.joke.findMany({
  skip: randomRowNumber,
  take: 1,
});
```

ğŸ’¿ ä½ åº”è¯¥èƒ½å¤Ÿä»é‚£é‡Œè®©åŠ è½½å™¨æ­£å¸¸å·¥ä½œã€‚

<details>

<summary>app/routes/jokes._index.tsx</summary>

```tsx filename=app/routes/jokes._index.tsx lines=[1-2,4,6-14,17,22-25]
import { json } from "@remix-run/node";
import { Link, useLoaderData } from "@remix-run/react";

import { db } from "~/utils/db.server";

export const loader = async () => {
  const count = await db.joke.count();
  const randomRowNumber = Math.floor(Math.random() * count);
  const [randomJoke] = await db.joke.findMany({
    skip: randomRowNumber,
    take: 1,
  });
  return json({ randomJoke });
};

export default function JokesIndexRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div>
      <p>è¿™æ˜¯ä¸€ä¸ªéšæœºç¬‘è¯ï¼š</p>
      <p>{data.randomJoke.content}</p>
      <Link to={data.randomJoke.id}>
        "{data.randomJoke.name}" æ°¸ä¹…é“¾æ¥
      </Link>
    </div>
  );
}
```

</details>

è¿™æ ·ä½ çš„ [`/jokes`][jokes] è·¯ç”±åº”è¯¥æ˜¾ç¤ºç¬‘è¯çš„é“¾æ¥åˆ—è¡¨ä»¥åŠä¸€ä¸ªéšæœºç¬‘è¯ï¼š

![Jokes page showing a random joke][jokes-page-showing-a-random-joke]

## å˜æ›´

æˆ‘ä»¬æœ‰äº†ä¸€ä¸ª `/jokes/new` è·¯ç”±ï¼Œä½†è¿™ä¸ªè¡¨å•è¿˜æ²¡æœ‰ä»»ä½•åŠŸèƒ½ã€‚è®©æˆ‘ä»¬æ¥å®ç°å®ƒå§ï¼ä½œä¸ºæé†’ï¼Œç›®å‰ä»£ç åº”è¯¥æ˜¯è¿™æ ·çš„ï¼ˆ`method="post"` éå¸¸é‡è¦ï¼Œç¡®ä¿ä½ çš„ä»£ç ä¸­åŒ…å«å®ƒï¼‰ï¼š

```tsx filename=app/routes/jokes.new.tsx
export default function NewJokeRoute() {
  return (
    <div>
      <p>æ·»åŠ ä½ è‡ªå·±çš„æç¬‘ç¬‘è¯</p>
      <form method="post">
        <div>
          <label>
            åç§°: <input type="text" name="name" />
          </label>
        </div>
        <div>
          <label>
            å†…å®¹: <textarea name="content" />
          </label>
        </div>
        <div>
          <button type="submit" className="button">
            æ·»åŠ 
          </button>
        </div>
      </form>
    </div>
  );
}
```

æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚åªæ˜¯ä¸€ä¸ªè¡¨å•ã€‚å¦‚æœæˆ‘å‘Šè¯‰ä½ ï¼Œåªéœ€å‘è·¯ç”±æ¨¡å—å¯¼å‡ºä¸€ä¸ªå‡½æ•°ï¼Œå°±å¯ä»¥ä½¿è¿™ä¸ªè¡¨å•å·¥ä½œï¼Œä½ ä¼šè§‰å¾—æ€ä¹ˆæ ·ï¼Ÿç¡®å®å¯ä»¥ï¼è¿™å°±æ˜¯ [`action`][action] å‡½æ•°çš„å¯¼å‡ºï¼å…ˆäº†è§£ä¸€ä¸‹è¿™ä¸ªå§ã€‚

è¿™é‡Œæ˜¯ä½ éœ€è¦çš„ Prisma ä»£ç ï¼š

```tsx
const joke = await db.joke.create({
  data: { name, content },
});
```

ğŸ’¿ åœ¨ `app/routes/jokes.new.tsx` ä¸­åˆ›å»ºä¸€ä¸ª `action`ã€‚

<details>

<summary>app/routes/jokes.new.tsx</summary>

```tsx filename=app/routes/jokes.new.tsx lines=[1-2,4,6-25]
import type { ActionFunctionArgs } from "@remix-run/node";
import { redirect } from "@remix-run/node";

import { db } from "~/utils/db.server";

export const action = async ({
  request,
}: ActionFunctionArgs) => {
  const form = await request.formData();
  const content = form.get("content");
  const name = form.get("name");
  // æˆ‘ä»¬åšè¿™ä¸ªç±»å‹æ£€æŸ¥æ˜¯ä¸ºäº†æ›´åŠ ç¡®ä¿ï¼Œå¹¶è®© TypeScript æ„‰å¿«
  // æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ¢ç´¢éªŒè¯ï¼
  if (
    typeof content !== "string" ||
    typeof name !== "string"
  ) {
    throw new Error("è¡¨å•æœªæ­£ç¡®æäº¤ã€‚");
  }

  const fields = { content, name };

  const joke = await db.joke.create({ data: fields });
  return redirect(`/jokes/${joke.id}`);
};

export default function NewJokeRoute() {
  return (
    <div>
      <p>æ·»åŠ ä½ è‡ªå·±çš„æç¬‘ç¬‘è¯</p>
      <form method="post">
        <div>
          <label>
            åç§°: <input type="text" name="name" />
          </label>
        </div>
        <div>
          <label>
            å†…å®¹: <textarea name="content" />
          </label>
        </div>
        <div>
          <button type="submit" className="button">
            æ·»åŠ 
          </button>
        </div>
      </form>
    </div>
  );
}
```

</details>

å¦‚æœä½ å·²ç»å®Œæˆäº†è¿™äº›ï¼Œä½ åº”è¯¥èƒ½å¤Ÿåˆ›å»ºæ–°çš„ç¬‘è¯å¹¶è¢«é‡å®šå‘åˆ°æ–°ç¬‘è¯çš„é¡µé¢ã€‚

<docs-info>

`redirect` å·¥å…·æ˜¯ Remix ä¸­ä¸€ä¸ªç®€å•çš„å·¥å…·ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªå…·æœ‰æ­£ç¡®å¤´éƒ¨/çŠ¶æ€ç çš„ [`Response`][response] å¯¹è±¡ï¼Œä»¥é‡å®šå‘ç”¨æˆ·ã€‚

</docs-info>

![åˆ›å»ºæ–°ç¬‘è¯è¡¨å•å¡«å†™å®Œæ¯•][create-new-joke-form-filled-out]

![æ–°åˆ›å»ºçš„ç¬‘è¯æ˜¾ç¤º][newly-created-joke-displayed]

å¤ªæ£’äº†ï¼è¿™å¤šé…·å•Šï¼Ÿæ²¡æœ‰ `useEffect` æˆ– `useAnything` é’©å­ã€‚åªæœ‰ä¸€ä¸ªè¡¨å•å’Œä¸€ä¸ªå¤„ç†æäº¤çš„å¼‚æ­¥å‡½æ•°ã€‚çœŸä¸é”™ã€‚å¦‚æœä½ æƒ³çš„è¯ï¼Œä½ å½“ç„¶å¯ä»¥åšæ‰€æœ‰é‚£äº›äº‹æƒ…ï¼Œä½†ä¸ºä»€ä¹ˆè¦å‘¢ï¼Ÿè¿™çœŸçš„å¾ˆå¥½ã€‚

ä½ è¿˜ä¼šæ³¨æ„åˆ°ï¼Œå½“æˆ‘ä»¬è¢«é‡å®šå‘åˆ°ç¬‘è¯çš„æ–°é¡µé¢æ—¶ï¼Œå®ƒå°±åœ¨é‚£å„¿ï¼ä½†æˆ‘ä»¬æ ¹æœ¬ä¸éœ€è¦è€ƒè™‘æ›´æ–°ç¼“å­˜ã€‚Remix è‡ªåŠ¨å¤„ç†ç¼“å­˜å¤±æ•ˆã€‚ä½ æ— éœ€è€ƒè™‘è¿™ä¸€ç‚¹ã€‚_è¿™_ å¤ªé…·äº† ğŸ˜

æˆ‘ä»¬ä¸ºä»€ä¹ˆä¸æ·»åŠ ä¸€äº›éªŒè¯å‘¢ï¼Ÿæˆ‘ä»¬å½“ç„¶å¯ä»¥é‡‡ç”¨å…¸å‹çš„ React éªŒè¯æ–¹æ³•ã€‚å°† `useState` ä¸ `onChange` å¤„ç†ç¨‹åºè¿æ¥èµ·æ¥ã€‚æœ‰æ—¶å€™ï¼Œè¿™æ ·å¯ä»¥åœ¨ç”¨æˆ·è¾“å…¥æ—¶è·å¾—å®æ—¶éªŒè¯ã€‚ä½†å³ä½¿ä½ åšäº†æ‰€æœ‰è¿™äº›å·¥ä½œï¼Œä½ ä»ç„¶ä¼šæƒ³åœ¨æœåŠ¡å™¨ä¸Šè¿›è¡ŒéªŒè¯ã€‚

åœ¨æˆ‘è®©ä½ è¿›è¡Œè¿™ä¸ªä¹‹å‰ï¼Œè¿˜æœ‰ä¸€ä»¶äº‹ä½ éœ€è¦çŸ¥é“å…³äºè·¯ç”±æ¨¡å— `action` å‡½æ•°ã€‚è¿”å›å€¼åº”ä¸ `loader` å‡½æ•°ç›¸åŒï¼šä¸€ä¸ª `Response`ï¼Œæˆ–è€…ï¼ˆä½œä¸ºä¾¿åˆ©ï¼‰ä¸€ä¸ªå¯åºåˆ—åŒ–çš„ JavaScript å¯¹è±¡ã€‚é€šå¸¸ï¼Œå½“æ“ä½œæˆåŠŸæ—¶ï¼Œä½ å¸Œæœ›é‡å®šå‘ï¼Œä»¥é¿å…åœ¨æŸäº›ç½‘ç«™ä¸Šå¯èƒ½çœ‹åˆ°çš„ä»¤äººçƒ¦æ¼çš„â€œç¡®è®¤é‡æ–°æäº¤â€å¯¹è¯æ¡†ã€‚

<!-- TODO: æ·»åŠ ä¸€é¡µå…³äºä¸ºä»€ä¹ˆ `redirect` å¯¹æˆåŠŸæ“ä½œæ›´å¥½çš„åŸå› ï¼Œå¹¶åœ¨è¿™é‡Œé“¾æ¥ã€‚ -->

ä½†æ˜¯å¦‚æœæœ‰é”™è¯¯ï¼Œä½ å¯ä»¥è¿”å›ä¸€ä¸ªå¸¦æœ‰é”™è¯¯æ¶ˆæ¯çš„å¯¹è±¡ï¼Œç„¶åç»„ä»¶å¯ä»¥ä» [`useActionData`][use-action-data] ä¸­è·å–è¿™äº›å€¼å¹¶æ˜¾ç¤ºç»™ç”¨æˆ·ã€‚

ğŸ’¿ ç»§ç»­éªŒè¯ `name` å’Œ `content` å­—æ®µçš„é•¿åº¦ã€‚æˆ‘è®¤ä¸ºåç§°è‡³å°‘åº”è¯¥æœ‰ 3 ä¸ªå­—ç¬¦ï¼Œå†…å®¹è‡³å°‘åº”è¯¥æœ‰ 10 ä¸ªå­—ç¬¦ã€‚è¿›è¡ŒæœåŠ¡å™¨ç«¯éªŒè¯ã€‚

<details>

<summary>app/routes/jokes.new.tsx</summary>

```tsx filename=app/routes/jokes.new.tsx lines=[3,6,8-12,14-18,30-34,37-40,42-48,55,65,68-75,78-86,92,94-101,104-112,115-122]
import type { ActionFunctionArgs } from "@remix-run/node";
import { redirect } from "@remix-run/node";
import { useActionData } from "@remix-run/react";

import { db } from "~/utils/db.server";
import { badRequest } from "~/utils/request.server";

function validateJokeContent(content: string) {
  if (content.length < 10) {
    return "è¿™ä¸ªç¬‘è¯å¤ªçŸ­äº†";
  }
}

function validateJokeName(name: string) {
  if (name.length < 3) {
    return "è¿™ä¸ªç¬‘è¯çš„åç§°å¤ªçŸ­äº†";
  }
}

export const action = async ({
  request,
}: ActionFunctionArgs) => {
  const form = await request.formData();
  const content = form.get("content");
  const name = form.get("name");
  if (
    typeof content !== "string" ||
    typeof name !== "string"
  ) {
    return badRequest({
      fieldErrors: null,
      fields: null,
      formError: "è¡¨å•æœªæ­£ç¡®æäº¤ã€‚",
    });
  }

  const fieldErrors = {
    content: validateJokeContent(content),
    name: validateJokeName(name),
  };
  const fields = { content, name };
  if (Object.values(fieldErrors).some(Boolean)) {
    return badRequest({
      fieldErrors,
      fields,
      formError: null,
    });
  }

  const joke = await db.joke.create({ data: fields });
  return redirect(`/jokes/${joke.id}`);
};

export default function NewJokeRoute() {
  const actionData = useActionData<typeof action>();

  return (
    <div>
      <p>æ·»åŠ ä½ è‡ªå·±çš„æç¬‘ç¬‘è¯</p>
      <form method="post">
        <div>
          <label>
            åç§°:{" "}
            <input
              defaultValue={actionData?.fields?.name}
              name="name"
              type="text"
              aria-invalid={Boolean(
                actionData?.fieldErrors?.name
              )}
              aria-errormessage={
                actionData?.fieldErrors?.name
                  ? "name-error"
                  : undefined
              }
            />
          </label>
          {actionData?.fieldErrors?.name ? (
            <p
              className="form-validation-error"
              id="name-error"
              role="alert"
            >
              {actionData.fieldErrors.name}
            </p>
          ) : null}
        </div>
        <div>
          <label>
            å†…å®¹:{" "}
            <textarea
              defaultValue={actionData?.fields?.content}
              name="content"
              aria-invalid={Boolean(
                actionData?.fieldErrors?.content
              )}
              aria-errormessage={
                actionData?.fieldErrors?.content
                  ? "content-error"
                  : undefined
              }
            />
          </label>
          {actionData?.fieldErrors?.content ? (
            <p
              className="form-validation-error"
              id="content-error"
              role="alert"
            >
              {actionData.fieldErrors.content}
            </p>
          ) : null}
        </div>
        <div>
          {actionData?.formError ? (
            <p
              className="form-validation-error"
              role="alert"
            >
              {actionData.formError}
            </p>
          ) : null}
          <button type="submit" className="button">
            æ·»åŠ 
          </button>
        </div>
      </form>
    </div>
  );
}
```

</details>

<details>

<summary>app/utils/request.server.ts</summary>

```ts filename=app/utils/request.server.ts
import { json } from "@remix-run/node";

/**
 * è¿™ä¸ªå¸®åŠ©å‡½æ•°å¸®åŠ©æˆ‘ä»¬è¿”å›å‡†ç¡®çš„ HTTP çŠ¶æ€ï¼Œ
 * 400 Bad Requestï¼Œç»™å®¢æˆ·ç«¯ã€‚
 */
export const badRequest = <T>(data: T) =>
  json<T>(data, { status: 400 });
```

</details>

å¤ªå¥½äº†ï¼ä½ ç°åœ¨åº”è¯¥æœ‰ä¸€ä¸ªåœ¨æœåŠ¡å™¨ä¸ŠéªŒè¯å­—æ®µå¹¶åœ¨å®¢æˆ·ç«¯æ˜¾ç¤ºè¿™äº›é”™è¯¯çš„è¡¨å•ï¼š

![å¸¦æœ‰éªŒè¯é”™è¯¯çš„æ–°ç¬‘è¯è¡¨å•][new-joke-form-with-validation-errors]

ä¸ºä»€ä¹ˆä¸ç¨å¾®çœ‹çœ‹æˆ‘çš„ä»£ç ç¤ºä¾‹ï¼Ÿæˆ‘æƒ³å‘ä½ å±•ç¤ºä¸€äº›æˆ‘åšè¿™ä»¶äº‹çš„æ–¹å¼ã€‚

é¦–å…ˆï¼Œæˆ‘å¸Œæœ›ä½ æ³¨æ„åˆ°æˆ‘å°† `typeof action` ä¼ é€’ç»™ `useActionData` æ³›å‹å‡½æ•°ã€‚è¿™æ ·ï¼Œ`actionData` çš„ç±»å‹å°†è¢«æ­£ç¡®æ¨æ–­ï¼Œæˆ‘ä»¬å°†è·å¾—ä¸€äº›ç±»å‹å®‰å…¨ã€‚è¯·è®°ä½ï¼Œå¦‚æœæ“ä½œå°šæœªè¢«è°ƒç”¨ï¼Œ`useActionData` å¯èƒ½è¿”å› `undefined`ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œæœ‰ä¸€äº›é˜²å¾¡æ€§ç¼–ç¨‹ã€‚

ä½ å¯èƒ½è¿˜ä¼šæ³¨æ„åˆ°æˆ‘ä¹Ÿè¿”å›äº†å­—æ®µã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿åœ¨ JavaScript å› æŸç§åŸå› æœªèƒ½åŠ è½½çš„æƒ…å†µä¸‹ï¼Œè¡¨å•å¯ä»¥ä½¿ç”¨æœåŠ¡å™¨ä¸­çš„å€¼é‡æ–°æ¸²æŸ“ã€‚è¿™å°±æ˜¯ `defaultValue` çš„ç”¨æ„æ‰€åœ¨ã€‚

`badRequest` è¾…åŠ©å‡½æ•°å°†è‡ªåŠ¨æ¨æ–­ä¼ å…¥æ•°æ®çš„ç±»å‹ï¼ŒåŒæ—¶ä»ç„¶è¿”å›å‡†ç¡®çš„ HTTP çŠ¶æ€ [`400 Bad Request`][400-bad-request] ç»™å®¢æˆ·ç«¯ã€‚å¦‚æœæˆ‘ä»¬åªæ˜¯ä½¿ç”¨ `json()` è€Œä¸æŒ‡å®šçŠ¶æ€ï¼Œé‚£å°†å¯¼è‡´ `200 OK` å“åº”ï¼Œè¿™æ˜¯ä¸åˆé€‚çš„ï¼Œå› ä¸ºè¡¨å•æäº¤æ—¶å‡ºç°äº†é”™è¯¯ã€‚

æˆ‘è¿˜æƒ³å¼ºè°ƒçš„æ˜¯ï¼Œæ‰€æœ‰è¿™äº›éƒ½æ˜¯å¦‚æ­¤ç®€æ´æ˜äº†ã€‚ä½ æ ¹æœ¬ä¸éœ€è¦è€ƒè™‘çŠ¶æ€ã€‚ä½ çš„æ“ä½œè·å–ä¸€äº›æ•°æ®ï¼Œå¤„ç†å®ƒå¹¶è¿”å›ä¸€ä¸ªå€¼ã€‚ç»„ä»¶æ¶ˆè´¹æ“ä½œæ•°æ®å¹¶æ ¹æ®è¯¥å€¼è¿›è¡Œæ¸²æŸ“ã€‚è¿™é‡Œæ²¡æœ‰çŠ¶æ€ç®¡ç†ï¼Œæ²¡æœ‰è€ƒè™‘ç«äº‰æ¡ä»¶ã€‚ä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚

å“¦ï¼Œå¦‚æœä½ ç¡®å®æƒ³è¦è¿›è¡Œå®¢æˆ·ç«¯éªŒè¯ï¼ˆåœ¨ç”¨æˆ·è¾“å…¥æ—¶ï¼‰ï¼Œä½ å¯ä»¥ç®€å•åœ°è°ƒç”¨ `validateJokeContent` å’Œ `validateJokeName` å‡½æ•°ï¼Œè¿™äº›å‡½æ•°æ­£åœ¨è¢«è¯¥æ“ä½œä½¿ç”¨ã€‚ä½ å®é™…ä¸Šå¯ä»¥æ— ç¼åœ°åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å…±äº«ä»£ç ï¼è¿™å¯çœŸé…·ï¼

## è®¤è¯

è¿™æ˜¯æˆ‘ä»¬ä¸€ç›´åœ¨ç­‰å¾…çš„æ—¶åˆ»ï¼æˆ‘ä»¬å°†ä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ·»åŠ è®¤è¯ã€‚æˆ‘ä»¬æƒ³è¦æ·»åŠ è®¤è¯çš„åŸå› æ˜¯ä¸ºäº†å°†ç¬‘è¯ä¸åˆ›å»ºå®ƒä»¬çš„ç”¨æˆ·å…³è”èµ·æ¥ã€‚

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œäº†è§£[HTTP cookies][http-cookies]åœ¨ç½‘ç»œä¸Šçš„å·¥ä½œåŸç†æ˜¯å¾ˆé‡è¦çš„ã€‚

æˆ‘ä»¬å°†ä»å¤´å¼€å§‹æ‰‹åŠ¨å®ç°è‡ªå·±çš„è®¤è¯ã€‚åˆ«æ‹…å¿ƒï¼Œæˆ‘ä¿è¯è¿™å¹¶æ²¡æœ‰å¬èµ·æ¥é‚£ä¹ˆå¯æ€•ã€‚

### å‡†å¤‡æ•°æ®åº“

<docs-warning>è¯·è®°ä½ï¼Œå¦‚æœæ‚¨çš„æ•°æ®åº“å‡ºç°é—®é¢˜ï¼Œæ‚¨å¯ä»¥éšæ—¶åˆ é™¤ `prisma/dev.db` æ–‡ä»¶å¹¶å†æ¬¡è¿è¡Œ `npx prisma db push`ã€‚è®°å¾—ä¹Ÿè¦ä½¿ç”¨ `npm run dev` é‡æ–°å¯åŠ¨æ‚¨çš„å¼€å‘æœåŠ¡å™¨ã€‚</docs-warning>

è®©æˆ‘ä»¬é¦–å…ˆå±•ç¤ºä¸€ä¸‹æˆ‘ä»¬æ›´æ–°åçš„ `prisma/schema.prisma` æ–‡ä»¶ã€‚

ğŸ’¿ è¯·æ›´æ–°æ‚¨çš„ `prisma/schema.prisma` æ–‡ä»¶ï¼Œä½¿å…¶å¦‚ä¸‹æ‰€ç¤ºï¼š

```prisma filename=prisma/schema.prisma lines=[13-20,24-25]
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  username     String   @unique
  passwordHash String
  jokes        Joke[]
}

model Joke {
  id         String   @id @default(uuid())
  jokesterId String
  jokester   User     @relation(fields: [jokesterId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  name       String
  content    String
}
```

æ›´æ–°å®Œæˆåï¼Œè®©æˆ‘ä»¬é‡ç½®æ•°æ®åº“ä»¥åŒ¹é…æ­¤æ¨¡å¼ï¼š

ğŸ’¿ è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```shellscript nonumber
npx prisma db push
```

å®ƒä¼šæç¤ºæ‚¨é‡ç½®æ•°æ®åº“ï¼ŒæŒ‰ "y" ç¡®è®¤ã€‚

è¿™æ ·æ‚¨å°†å¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼š

```
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": SQLite database "dev.db" at "file:./dev.db"


âš ï¸ We found changes that cannot be executed:

  â€¢ Added the required column `jokesterId` to the `Joke` table without a default value. There are 9 rows in this table, it is not possible to execute this step.


âœ” To apply this change we need to reset the database, do you want to continue? All data will be lost. â€¦ yes
The SQLite database "dev.db" from "file:./dev.db" was successfully reset.

ğŸš€  Your database is now in sync with your Prisma schema. Done in 1.56s

âœ” Generated Prisma Client (4.12.0 | library) to ./node_modules/@prisma/client in 34ms
```

ç”±äºè¿™ä¸ªæ›´æ”¹ï¼Œæˆ‘ä»¬å°†åœ¨é¡¹ç›®ä¸­å¼€å§‹é‡åˆ°ä¸€äº› TypeScript é”™è¯¯ï¼Œå› ä¸ºæ‚¨ä¸èƒ½å†åˆ›å»ºæ²¡æœ‰ `jokesterId` å€¼çš„ `joke`ã€‚

ğŸ’¿ è®©æˆ‘ä»¬å¼€å§‹ä¿®å¤æˆ‘ä»¬çš„ `prisma/seed.ts` æ–‡ä»¶ã€‚

```ts filename=prisma/seed.ts lines=[5-12,15-16]
import { PrismaClient } from "@prisma/client";
const db = new PrismaClient();

async function seed() {
  const kody = await db.user.create({
    data: {
      username: "kody",
      // this is a hashed version of "twixrox"
      passwordHash:
        "$2b$10$K7L1OJ45/4Y2nIvhRVpCe.FSmhDdWoXehVzJptJ/op0lSsvqNu/1u",
    },
  });
  await Promise.all(
    getJokes().map((joke) => {
      const data = { jokesterId: kody.id, ...joke };
      return db.joke.create({ data });
    })
  );
}

seed();

function getJokes() {
  // shout-out to https://icanhazdadjoke.com/

  return [
    {
      name: "Road worker",
      content: `I never wanted to believe that my Dad was stealing from his job as a road worker. But when I got home, all the signs were there.`,
    },
    {
      name: "Frisbee",
      content: `I was wondering why the frisbee was getting bigger, then it hit me.`,
    },
    {
      name: "Trees",
      content: `Why do trees seem suspicious on sunny days? Dunno, they're just a bit shady.`,
    },
    {
      name: "Skeletons",
      content: `Why don't skeletons ride roller coasters? They don't have the stomach for it.`,
    },
    {
      name: "Hippos",
      content: `Why don't you find hippopotamuses hiding in trees? They're really good at it.`,
    },
    {
      name: "Dinner",
      content: `What did one plate say to the other plate? Dinner is on me!`,
    },
    {
      name: "Elevator",
      content: `My first time using an elevator was an uplifting experience. The second time let me down.`,
    },
  ];
}
```

ğŸ’¿ å¤ªå¥½äº†ï¼Œç°åœ¨å†æ¬¡è¿è¡Œç§å­ï¼š

```shellscript nonumber
npx prisma db seed
```

è¾“å‡ºå¦‚ä¸‹ï¼š

```
Environment variables loaded from .env
Running seed command `ts-node --require tsconfig-paths/register prisma/seed.ts` ...

ğŸŒ±  The seed command has been executed.
```

å¤ªå¥½äº†ï¼æˆ‘ä»¬çš„æ•°æ®åº“ç°åœ¨å·²ç»å‡†å¤‡å¥½äº†ã€‚

### è®¤è¯æµç¨‹æ¦‚è¿°

æˆ‘ä»¬çš„è®¤è¯å°†é‡‡ç”¨ä¼ ç»Ÿçš„ç”¨æˆ·å/å¯†ç æ–¹å¼ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ [`bcryptjs`][bcryptjs] æ¥å¯¹å¯†ç è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œä»¥ç¡®ä¿æ²¡æœ‰äººèƒ½å¤Ÿåˆç†åœ°é€šè¿‡æš´åŠ›ç ´è§£è¿›å…¥è´¦æˆ·ã€‚

ğŸ’¿ ç°åœ¨å°±å®‰è£…å®ƒï¼Œä»¥å…æˆ‘ä»¬å¿˜è®°ï¼š

```shellscript nonumber
npm install bcryptjs
```

ğŸ’¿ `bcryptjs` åº“åœ¨ DefinitelyTyped ä¸­æœ‰ TypeScript å®šä¹‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿæ¥å®‰è£…è¿™äº›ï¼š

```shellscript nonumber
npm install --save-dev @types/bcryptjs
```

è®©æˆ‘ç»™ä½ ä¸€ä¸ªæµç¨‹å›¾ï¼š

![Excalidraw è®¤è¯å›¾][excalidraw-authentication-diagram]

ä»¥ä¸‹æ˜¯æµç¨‹çš„æ–‡å­—æè¿°ï¼š

- åœ¨ `/login` è·¯ç”±ä¸Šã€‚
- ç”¨æˆ·æäº¤ç™»å½•è¡¨å•ã€‚
- è¡¨å•æ•°æ®è¿›è¡ŒéªŒè¯ã€‚
  - å¦‚æœè¡¨å•æ•°æ®æ— æ•ˆï¼Œè¿”å›å¸¦æœ‰é”™è¯¯çš„è¡¨å•ã€‚
- ç™»å½•ç±»å‹ä¸º "register"
  - æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å¯ç”¨
    - å¦‚æœç”¨æˆ·åä¸å¯ç”¨ï¼Œè¿”å›å¸¦æœ‰é”™è¯¯çš„è¡¨å•ã€‚
  - å“ˆå¸Œå¤„ç†å¯†ç 
  - åˆ›å»ºæ–°ç”¨æˆ·
- ç™»å½•ç±»å‹ä¸º "login"
  - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    - å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¿”å›å¸¦æœ‰é”™è¯¯çš„è¡¨å•ã€‚
  - æ£€æŸ¥å¯†ç å“ˆå¸Œæ˜¯å¦åŒ¹é…
    - å¦‚æœå¯†ç å“ˆå¸Œä¸åŒ¹é…ï¼Œè¿”å›å¸¦æœ‰é”™è¯¯çš„è¡¨å•ã€‚
- åˆ›å»ºæ–°ä¼šè¯
- ä½¿ç”¨ `Set-Cookie` å¤´é‡å®šå‘åˆ° `/jokes` è·¯ç”±ã€‚

### æ„å»ºç™»å½•è¡¨å•

å¥½äº†ï¼Œè¶³å¤Ÿçš„é«˜å±‚æ¬¡è®¨è®ºäº†ã€‚è®©æˆ‘ä»¬å¼€å§‹ç¼–å†™ä¸€äº› Remix ä»£ç å§ï¼

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç™»å½•é¡µé¢ï¼Œæˆ‘ä¸ºæ‚¨å‡†å¤‡äº†ä¸€äº› CSS ä¾›æ‚¨åœ¨è¯¥é¡µé¢ä¸Šä½¿ç”¨ï¼š

<details>

<summary>ğŸ’¿ å°†æ­¤ CSS å¤åˆ¶åˆ° `app/styles/login.css`</summary>

```css
/*
 * å½“ç”¨æˆ·è®¿é—®æ­¤é¡µé¢æ—¶ï¼Œæ­¤æ ·å¼å°†åº”ç”¨ï¼Œå½“ä»–ä»¬ç¦»å¼€æ—¶ï¼Œå®ƒ
 * å°†è¢«å¸è½½ï¼Œå› æ­¤ä¸å¿…å¤ªæ‹…å¿ƒé¡µé¢ä¹‹é—´çš„æ ·å¼å†²çªï¼
 */

body {
  background-image: var(--gradient-background);
}

.container {
  min-height: inherit;
}

.container,
.content {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.content {
  padding: 1rem;
  background-color: hsl(0, 0%, 100%);
  border-radius: 5px;
  box-shadow: 0 0.2rem 1rem rgba(0, 0, 0, 0.5);
  width: 400px;
  max-width: 100%;
}

@media print, (min-width: 640px) {
  .content {
    padding: 2rem;
    border-radius: 8px;
  }
}

h1 {
  margin-top: 0;
}

fieldset {
  display: flex;
  justify-content: center;
}

fieldset > :not(:last-child) {
  margin-right: 2rem;
}

.links ul {
  margin-top: 1rem;
  padding: 0;
  list-style: none;
  display: flex;
  gap: 1.5rem;
  align-items: center;
}

.links a:hover {
  text-decoration-style: wavy;
  text-decoration-thickness: 1px;
}
```

</details>

ğŸ’¿ é€šè¿‡æ·»åŠ  `app/routes/login.tsx` æ–‡ä»¶æ¥åˆ›å»º `/login` è·¯ç”±ã€‚

<details>

<summary>app/routes/login.tsx</summary>

```tsx filename=app/routes/login.tsx
import type { LinksFunction } from "@remix-run/node";
import { Link, useSearchParams } from "@remix-run/react";

import stylesUrl from "~/styles/login.css";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

export default function Login() {
  const [searchParams] = useSearchParams();
  return (
    <div className="container">
      <div className="content" data-light="">
        <h1>ç™»å½•</h1>
        <form method="post">
          <input
            type="hidden"
            name="redirectTo"
            value={
              searchParams.get("redirectTo") ?? undefined
            }
          />
          <fieldset>
            <legend className="sr-only">
              ç™»å½•æˆ–æ³¨å†Œï¼Ÿ
            </legend>
            <label>
              <input
                type="radio"
                name="loginType"
                value="login"
                defaultChecked
              />{" "}
              ç™»å½•
            </label>
            <label>
              <input
                type="radio"
                name="loginType"
                value="register"
              />{" "}
              æ³¨å†Œ
            </label>
          </fieldset>
          <div>
            <label htmlFor="username-input">ç”¨æˆ·å</label>
            <input
              type="text"
              id="username-input"
              name="username"
            />
          </div>
          <div>
            <label htmlFor="password-input">å¯†ç </label>
            <input
              id="password-input"
              name="password"
              type="password"
            />
          </div>
          <button type="submit" className="button">
            æäº¤
          </button>
        </form>
      </div>
      <div className="links">
        <ul>
          <li>
            <Link to="/">é¦–é¡µ</Link>
          </li>
          <li>
            <Link to="/jokes">ç¬‘è¯</Link>
          </li>
        </ul>
      </div>
    </div>
  );
}
```

</details>

è¿™åº”è¯¥çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

![å¸¦æœ‰ç™»å½•/æ³¨å†Œå•é€‰æŒ‰é’®å’Œç”¨æˆ·å/å¯†ç å­—æ®µåŠæäº¤æŒ‰é’®çš„ç™»å½•è¡¨å•][a-login-form-with-a-login-register-radio-button-and-username-password-fields-and-a-submit-button]

è¯·æ³¨æ„ï¼Œåœ¨æˆ‘çš„è§£å†³æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä½¿ç”¨ `useSearchParams` æ¥è·å– `redirectTo` æŸ¥è¯¢å‚æ•°å¹¶å°†å…¶æ”¾å…¥éšè—è¾“å…¥ä¸­ã€‚è¿™æ ·æˆ‘ä»¬çš„ `action` å°±å¯ä»¥çŸ¥é“å°†ç”¨æˆ·é‡å®šå‘åˆ°å“ªé‡Œã€‚è¿™åœ¨æˆ‘ä»¬ç¨åå°†ç”¨æˆ·é‡å®šå‘åˆ°ç™»å½•é¡µé¢æ—¶ä¼šå¾ˆæœ‰ç”¨ã€‚

å¾ˆå¥½ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»è®© UI çœ‹èµ·æ¥ä¸é”™äº†ï¼Œè®©æˆ‘ä»¬æ·»åŠ ä¸€äº›é€»è¾‘ã€‚è¿™å°†ä¸æˆ‘ä»¬åœ¨ `/jokes/new` è·¯ç”±ä¸­æ‰€åšçš„éå¸¸ç›¸ä¼¼ã€‚å°½å¯èƒ½å¤šåœ°å¡«å†™ï¼ˆéªŒè¯ç­‰ï¼‰ï¼Œæˆ‘ä»¬å°†åªä¸ºæˆ‘ä»¬å°šæœªå®ç°çš„é€»è¾‘éƒ¨åˆ†ï¼ˆä¾‹å¦‚ _å®é™…_ æ³¨å†Œ/ç™»å½•ï¼‰ç•™ä¸‹æ³¨é‡Šã€‚

ğŸ’¿ åœ¨ `app/routes/login.tsx` ä¸­ä½¿ç”¨ `action` å®ç°éªŒè¯

<details>

<summary>app/routes/login.tsx</summary>

```tsx filename=app/routes/login.tsx lines=[2,7,12-13,19-23,25-29,31-37,39-112,115,138-141,150-153,164-172,174-182,190-198,200-208,210-219]
import type {
  ActionFunctionArgs,
  LinksFunction,
} from "@remix-run/node";
import {
  Link,
  useActionData,
  useSearchParams,
} from "@remix-run/react";

import stylesUrl from "~/styles/login.css";
import { db } from "~/utils/db.server";
import { badRequest } from "~/utils/request.server";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

function validateUsername(username: string) {
  if (username.length < 3) {
    return "ç”¨æˆ·åå¿…é¡»è‡³å°‘ä¸º 3 ä¸ªå­—ç¬¦";
  }
}

function validatePassword(password: string) {
  if (password.length < 6) {
    return "å¯†ç å¿…é¡»è‡³å°‘ä¸º 6 ä¸ªå­—ç¬¦";
  }
}

function validateUrl(url: string) {
  const urls = ["/jokes", "/", "https://remix.run"];
  if (urls.includes(url)) {
    return url;
  }
  return "/jokes";
}

export const action = async ({
  request,
}: ActionFunctionArgs) => {
  const form = await request.formData();
  const loginType = form.get("loginType");
  const password = form.get("password");
  const username = form.get("username");
  const redirectTo = validateUrl(
    (form.get("redirectTo") as string) || "/jokes"
  );
  if (
    typeof loginType !== "string" ||
    typeof password !== "string" ||
    typeof username !== "string"
  ) {
    return badRequest({
      fieldErrors: null,
      fields: null,
      formError: "è¡¨å•æœªæ­£ç¡®æäº¤ã€‚",
    });
  }

  const fields = { loginType, password, username };
  const fieldErrors = {
    password: validatePassword(password),
    username: validateUsername(username),
  };
  if (Object.values(fieldErrors).some(Boolean)) {
    return badRequest({
      fieldErrors,
      fields,
      formError: null,
    });
  }

  switch (loginType) {
    case "login": {
      // ç™»å½•ä»¥è·å–ç”¨æˆ·
      // å¦‚æœæ²¡æœ‰ç”¨æˆ·ï¼Œè¿”å›å­—æ®µå’Œè¡¨å•é”™è¯¯
      // å¦‚æœæœ‰ç”¨æˆ·ï¼Œåˆ›å»ºä»–ä»¬çš„ä¼šè¯å¹¶é‡å®šå‘åˆ° /jokes
      return badRequest({
        fieldErrors: null,
        fields,
        formError: "æœªå®ç°",
      });
    }
    case "register": {
      const userExists = await db.user.findFirst({
        where: { username },
      });
      if (userExists) {
        return badRequest({
          fieldErrors: null,
          fields,
          formError: `ç”¨æˆ·åä¸º ${username} çš„ç”¨æˆ·å·²å­˜åœ¨`,
        });
      }
      // åˆ›å»ºç”¨æˆ·
      // åˆ›å»ºä»–ä»¬çš„ä¼šè¯å¹¶é‡å®šå‘åˆ° /jokes
      return badRequest({
        fieldErrors: null,
        fields,
        formError: "æœªå®ç°",
      });
    }
    default: {
      return badRequest({
        fieldErrors: null,
        fields,
        formError: "ç™»å½•ç±»å‹æ— æ•ˆ",
      });
    }
  }
};

export default function Login() {
  const actionData = useActionData<typeof action>();
  const [searchParams] = useSearchParams();
  return (
    <div className="container">
      <div className="content" data-light="">
        <h1>ç™»å½•</h1>
        <form method="post">
          <input
            type="hidden"
            name="redirectTo"
            value={
              searchParams.get("redirectTo") ?? undefined
            }
          />
          <fieldset>
            <legend className="sr-only">
              ç™»å½•æˆ–æ³¨å†Œï¼Ÿ
            </legend>
            <label>
              <input
                type="radio"
                name="loginType"
                value="login"
                defaultChecked={
                  !actionData?.fields?.loginType ||
                  actionData?.fields?.loginType === "login"
                }
              />{" "}
              ç™»å½•
            </label>
            <label>
              <input
                type="radio"
                name="loginType"
                value="register"
                defaultChecked={
                  actionData?.fields?.loginType ===
                  "register"
                }
              />{" "}
              æ³¨å†Œ
            </label>
          </fieldset>
          <div>
            <label htmlFor="username-input">ç”¨æˆ·å</label>
            <input
              type="text"
              id="username-input"
              name="username"
              defaultValue={actionData?.fields?.username}
              aria-invalid={Boolean(
                actionData?.fieldErrors?.username
              )}
              aria-errormessage={
                actionData?.fieldErrors?.username
                  ? "username-error"
                  : undefined
              }
            />
            {actionData?.fieldErrors?.username ? (
              <p
                className="form-validation-error"
                role="alert"
                id="username-error"
              >
                {actionData.fieldErrors.username}
              </p>
            ) : null}
          </div>
          <div>
            <label htmlFor="password-input">å¯†ç </label>
            <input
              id="password-input"
              name="password"
              type="password"
              defaultValue={actionData?.fields?.password}
              aria-invalid={Boolean(
                actionData?.fieldErrors?.password
              )}
              aria-errormessage={
                actionData?.fieldErrors?.password
                  ? "password-error"
                  : undefined
              }
            />
            {actionData?.fieldErrors?.password ? (
              <p
                className="form-validation-error"
                role="alert"
                id="password-error"
              >
                {actionData.fieldErrors.password}
              </p>
            ) : null}
          </div>
          <div id="form-error-message">
            {actionData?.formError ? (
              <p
                className="form-validation-error"
                role="alert"
              >
                {actionData.formError}
              </p>
            ) : null}
          </div>
          <button type="submit" className="button">
            æäº¤
          </button>
        </form>
      </div>
      <div className="links">
        <ul>
          <li>
            <Link to="/">é¦–é¡µ</Link>
          </li>
          <li>
            <Link to="/jokes">ç¬‘è¯</Link>
          </li>
        </ul>
      </div>
    </div>
  );
}
```

</details>

å®Œæˆåï¼Œæ‚¨çš„è¡¨å•åº”è¯¥çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

![å¸¦é”™è¯¯çš„ç™»å½•è¡¨å•][login-form-with-errors]

å¤ªå¥½äº†ï¼ç°åœ¨æ˜¯æ—¶å€™å¤„ç†ä¸€äº›æ›´é‡è¦çš„å†…å®¹äº†ã€‚è®©æˆ‘ä»¬ä» `login` çš„éƒ¨åˆ†å¼€å§‹ã€‚æˆ‘ä»¬å°†ä¸€ä¸ªç”¨æˆ·åä¸º `kody` çš„ç”¨æˆ·æ·»åŠ è¿›ç³»ç»Ÿï¼Œå¯†ç ï¼ˆç»è¿‡å“ˆå¸Œå¤„ç†ï¼‰ä¸º `twixrox`ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å®ç°è¶³å¤Ÿçš„é€»è¾‘ï¼Œä»¥ä¾¿èƒ½å¤Ÿä»¥è¯¥ç”¨æˆ·èº«ä»½ç™»å½•ã€‚æˆ‘ä»¬å°†æŠŠè¿™ä¸ªé€»è¾‘æ”¾åœ¨ä¸€ä¸ªåä¸º `app/utils/session.server.ts` çš„å•ç‹¬æ–‡ä»¶ä¸­ã€‚

åœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä»¥ä¸‹å†…å®¹æ¥å¼€å§‹ï¼š

- å¯¼å‡ºä¸€ä¸ªåä¸º `login` çš„å‡½æ•°ï¼Œæ¥å— `username` å’Œ `password`
- ä½¿ç”¨ Prisma æŸ¥è¯¢å…·æœ‰è¯¥ `username` çš„ç”¨æˆ·
- å¦‚æœæ²¡æœ‰ç”¨æˆ·ï¼Œåˆ™è¿”å› `null`
- ä½¿ç”¨ `bcrypt.compare` å°†ç»™å®šçš„ `password` ä¸ç”¨æˆ·çš„ `passwordHash` è¿›è¡Œæ¯”è¾ƒ
- å¦‚æœå¯†ç ä¸åŒ¹é…ï¼Œåˆ™è¿”å› `null`
- å¦‚æœå¯†ç åŒ¹é…ï¼Œåˆ™è¿”å›è¯¥ç”¨æˆ·

ğŸ’¿ åˆ›å»ºä¸€ä¸ªåä¸º `app/utils/session.server.ts` çš„æ–‡ä»¶ï¼Œå¹¶å®ç°ä¸Šè¿°è¦æ±‚ã€‚

<details>

<summary>app/utils/session.server.ts</summary>

```ts filename=app/utils/session.server.ts
import bcrypt from "bcryptjs";

import { db } from "./db.server";

type LoginForm = {
  password: string;
  username: string;
};

export async function login({
  password,
  username,
}: LoginForm) {
  const user = await db.user.findUnique({
    where: { username },
  });
  if (!user) {
    return null;
  }

  const isCorrectPassword = await bcrypt.compare(
    password,
    user.passwordHash
  );
  if (!isCorrectPassword) {
    return null;
  }

  return { id: user.id, username };
}
```

</details>

å¤ªå¥½äº†ï¼Œæœ‰äº†è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æ›´æ–° `app/routes/login.tsx` æ¥ä½¿ç”¨å®ƒï¼š

<details>

<summary>app/routes/login.tsx</summary>

```tsx filename=app/routes/login.tsx lines=[6,16-25] nocopy
// ...

import stylesUrl from "~/styles/login.css";
import { db } from "~/utils/db.server";
import { badRequest } from "~/utils/request.server";
import { login } from "~/utils/session.server";

// ...

export const action = async ({
  request,
}: ActionFunctionArgs) => {
  // ...
  switch (loginType) {
    case "login": {
      const user = await login({ username, password });
      console.log({ user });
      if (!user) {
        return badRequest({
          fieldErrors: null,
          fields,
          formError:
            "ç”¨æˆ·å/å¯†ç ç»„åˆä¸æ­£ç¡®",
        });
      }
      // å¦‚æœæœ‰ç”¨æˆ·ï¼Œåˆ›å»ºä»–ä»¬çš„ä¼šè¯å¹¶é‡å®šå‘åˆ° /jokes
      return badRequest({
        fieldErrors: null,
        fields,
        formError: "æœªå®ç°",
      });
    }
    // ...
  }
};

export default function Login() {
  // ...
}
```

</details>

ä¸ºäº†æ£€æŸ¥æˆ‘ä»¬çš„å·¥ä½œï¼Œæˆ‘åœ¨ `app/routes/login.tsx` ä¸­çš„ `login` è°ƒç”¨åæ·»åŠ äº†ä¸€ä¸ª `console.log`ã€‚

<docs-info>è¯·è®°ä½ï¼Œ`actions` å’Œ `loaders` åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œå› æ­¤æ‚¨åœ¨å…¶ä¸­æ”¾ç½®çš„ `console.log` è°ƒç”¨åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æ˜¯çœ‹ä¸åˆ°çš„ã€‚å®ƒä»¬ä¼šå‡ºç°åœ¨æ‚¨è¿è¡ŒæœåŠ¡å™¨çš„ç»ˆç«¯çª—å£ä¸­ã€‚</docs-info>

ğŸ’¿ æœ‰äº†è¿™ä¸€ç‚¹ï¼Œå°è¯•ä½¿ç”¨ç”¨æˆ·å `kody` å’Œå¯†ç  `twixrox` ç™»å½•ï¼Œå¹¶æ£€æŸ¥ç»ˆç«¯è¾“å‡ºã€‚ä»¥ä¸‹æ˜¯æˆ‘å¾—åˆ°çš„ç»“æœï¼š

```
{
  user: {
    id: '1dc45f54-4061-4d9e-8a6d-28d6df6a8d7f',
    username: 'kody'
  }
}
```

<docs-warning>å¦‚æœæ‚¨é‡åˆ°é—®é¢˜ï¼Œè¯·è¿è¡Œ `npx prisma studio` åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹æ•°æ®åº“ã€‚å¯èƒ½æ‚¨æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œå› ä¸ºæ‚¨å¿˜è®°è¿è¡Œ `npx prisma db seed`ï¼ˆå°±åƒæˆ‘åœ¨å†™è¿™ä¸ªçš„æ—¶å€™æ‰€åšçš„ğŸ˜…ï¼‰ã€‚</docs-warning>

å¤ªæ£’äº†ï¼æˆ‘ä»¬å¾—åˆ°äº†ç”¨æˆ·ï¼ç°åœ¨æˆ‘ä»¬éœ€è¦å°†è¯¥ç”¨æˆ·çš„ ID æ”¾å…¥ä¼šè¯ä¸­ã€‚æˆ‘ä»¬å°†åœ¨ `app/utils/session.server.ts` ä¸­å®Œæˆæ­¤æ“ä½œã€‚Remix æœ‰ä¸€ä¸ªå†…ç½®çš„æŠ½è±¡æ¥å¸®åŠ©æˆ‘ä»¬ç®¡ç†å¤šç§ç±»å‹çš„ä¼šè¯å­˜å‚¨æœºåˆ¶ï¼ˆ[è¿™é‡Œæ˜¯æ–‡æ¡£][here-are-the-docs]ï¼‰ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ [`createCookieSessionStorage`][create-cookie-session-storage]ï¼Œå› ä¸ºå®ƒæ˜¯æœ€ç®€å•çš„ï¼Œå¹¶ä¸”æ‰©å±•æ€§å¾ˆå¥½ã€‚

ğŸ’¿ åœ¨ `app/utils/session.server.ts` ä¸­ç¼–å†™ä¸€ä¸ª `createUserSession` å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ç”¨æˆ· ID å’Œé‡å®šå‘çš„è·¯ç”±ã€‚å®ƒåº”è¯¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

- åˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯ï¼ˆé€šè¿‡ cookie å­˜å‚¨çš„ `getSession` å‡½æ•°ï¼‰
- åœ¨ä¼šè¯ä¸­è®¾ç½® `userId` å­—æ®µ
- é‡å®šå‘åˆ°ç»™å®šçš„è·¯ç”±ï¼Œè®¾ç½® `Set-Cookie` å¤´ï¼ˆé€šè¿‡ cookie å­˜å‚¨çš„ `commitSession` å‡½æ•°ï¼‰

æ³¨æ„ï¼šå¦‚æœæ‚¨éœ€è¦å¸®åŠ©ï¼Œå…³äºæ•´ä¸ªåŸºæœ¬æµç¨‹çš„å°ç¤ºä¾‹å¯ä»¥åœ¨ [ä¼šè¯æ–‡æ¡£][here-are-the-docs] ä¸­æ‰¾åˆ°ã€‚ä¸€æ—¦æ‚¨æœ‰äº†å®ƒï¼Œæ‚¨å°†å¸Œæœ›åœ¨ `app/routes/login.tsx` ä¸­ä½¿ç”¨å®ƒæ¥è®¾ç½®ä¼šè¯å¹¶é‡å®šå‘åˆ° `/jokes` è·¯ç”±ã€‚

<details>

<summary>app/utils/session.server.ts</summary>

```ts filename=app/utils/session.server.ts lines=[1-4,35-38,40-53,55-66]
import {
  createCookieSessionStorage,
  redirect,
} from "@remix-run/node";
import bcrypt from "bcryptjs";

import { db } from "./db.server";

type LoginForm = {
  username: string;
  password: string;
};

export async function login({
  username,
  password,
}: LoginForm) {
  const user = await db.user.findUnique({
    where: { username },
  });
  if (!user) {
    return null;
  }
  const isCorrectPassword = await bcrypt.compare(
    password,
    user.passwordHash
  );
  if (!isCorrectPassword) {
    return null;
  }

  return { id: user.id, username };
}

const sessionSecret = process.env.SESSION_SECRET;
if (!sessionSecret) {
  throw new Error("SESSION_SECRET å¿…é¡»è®¾ç½®");
}

const storage = createCookieSessionStorage({
  cookie: {
    name: "RJ_session",
    // é€šå¸¸æ‚¨å¸Œæœ›å°†å…¶è®¾ç½®ä¸º `secure: true`
    // ä½†åœ¨ Safari çš„ localhost ä¸Šæ— æ³•æ­£å¸¸å·¥ä½œ
    // https://web.dev/when-to-use-local-https/
    secure: process.env.NODE_ENV === "production",
    secrets: [sessionSecret],
    sameSite: "lax",
    path: "/",
    maxAge: 60 * 60 * 24 * 30,
    httpOnly: true,
  },
});

export async function createUserSession(
  userId: string,
  redirectTo: string
) {
  const session = await storage.getSession();
  session.set("userId", userId);
  return redirect(redirectTo, {
    headers: {
      "Set-Cookie": await storage.commitSession(session),
    },
  });
}
```

</details>

<details>

<summary>app/routes/login.tsx</summary>

```tsx filename=app/routes/login.tsx lines=[7,29] nocopy
// ...

import stylesUrl from "~/styles/login.css";
import { db } from "~/utils/db.server";
import { badRequest } from "~/utils/request.server";
import {
  createUserSession,
  login,
} from "~/utils/session.server";

// ...

export const action = async ({
  request,
}: ActionFunctionArgs) => {
  // ...

  switch (loginType) {
    case "login": {
      const user = await login({ username, password });

      if (!user) {
        return badRequest({
          fieldErrors: null,
          fields,
          formError: `ç”¨æˆ·å/å¯†ç ç»„åˆä¸æ­£ç¡®`,
        });
      }
      return createUserSession(user.id, redirectTo);
    }

    // ...
  }
};

// ...
```

</details>

æˆ‘æƒ³å¿«é€Ÿæä¸€ä¸‹æˆ‘ä½¿ç”¨çš„ `SESSION_SECRET` ç¯å¢ƒå˜é‡ã€‚`secrets` é€‰é¡¹çš„å€¼ä¸æ˜¯æ‚¨å¸Œæœ›æ”¾åœ¨ä»£ç ä¸­çš„å†…å®¹ï¼Œå› ä¸ºåäººå¯èƒ½ä¼šåˆ©ç”¨å®ƒæ¥è¿›è¡Œæ¶æ„æ´»åŠ¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†ä»ç¯å¢ƒä¸­è¯»å–è¯¥å€¼ã€‚è¿™æ„å‘³ç€æ‚¨éœ€è¦åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ã€‚é¡ºä¾¿è¯´ä¸€ä¸‹ï¼ŒPrisma ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬åŠ è½½è¯¥æ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€ç¡®ä¿åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è®¾ç½®è¯¥å€¼å³å¯ã€‚

ğŸ’¿ æ›´æ–° `.env` æ–‡ä»¶ï¼Œæ·»åŠ  `SESSION_SECRET`ï¼ˆå¯ä»¥ä½¿ç”¨æ‚¨å–œæ¬¢çš„ä»»ä½•å€¼ï¼‰ã€‚

å®Œæˆåï¼Œæ‰“å¼€æ‚¨çš„ [ç½‘ç»œé€‰é¡¹å¡][network-tab]ï¼Œè®¿é—® [`/login`][login]ï¼Œè¾“å…¥ `kody` å’Œ `twixrox`ï¼Œå¹¶æ£€æŸ¥ç½‘ç»œé€‰é¡¹å¡ä¸­çš„å“åº”å¤´ã€‚åº”è¯¥çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

![DevTools ç½‘ç»œé€‰é¡¹å¡æ˜¾ç¤º POST å“åº”ä¸­çš„ "Set-Cookie" å¤´][dev-tools-network-tab-showing-a-set-cookie-header-on-the-post-response]

å¦‚æœæ‚¨æ£€æŸ¥ [åº”ç”¨ç¨‹åºé€‰é¡¹å¡][application-tab] çš„ Cookies éƒ¨åˆ†ï¼Œæ‚¨ä¹Ÿåº”è¯¥åœ¨é‚£é‡Œè®¾ç½®äº† Cookieã€‚

![DevTools åº”ç”¨ç¨‹åºé€‰é¡¹å¡æ˜¾ç¤º ][dev-tools-application-tab-showing]

ç°åœ¨ï¼Œæµè§ˆå™¨å‘æˆ‘ä»¬çš„æœåŠ¡å™¨å‘å‡ºçš„æ¯ä¸ªè¯·æ±‚éƒ½å°†åŒ…å«è¯¥ Cookieï¼ˆæˆ‘ä»¬ä¸éœ€è¦åœ¨å®¢æˆ·ç«¯åšä»»ä½•äº‹æƒ…ï¼Œ[è¿™å°±æ˜¯ Cookie çš„å·¥ä½œåŸç†][http-cookies]ï¼‰ï¼š

![è¯·æ±‚å¤´æ˜¾ç¤º Cookie][request-headers-showing-the-cookie]

å› æ­¤ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥é€šè¿‡è¯»å–è¯¥å¤´éƒ¨æ¥æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç»è¿‡èº«ä»½éªŒè¯ï¼Œä»¥è·å–æˆ‘ä»¬è®¾ç½®çš„ `userId`ã€‚ä¸ºäº†æµ‹è¯•è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬é€šè¿‡å°† `jokesterId` å­—æ®µæ·»åŠ åˆ° `db.joke.create` è°ƒç”¨ä¸­æ¥ä¿®å¤ `/jokes/new` è·¯ç”±ã€‚

<docs-info>è¯·è®°å¾—æŸ¥çœ‹ [æ–‡æ¡£][here-are-the-docs]ï¼Œäº†è§£å¦‚ä½•ä»è¯·æ±‚ä¸­è·å–ä¼šè¯</docs-info>

ğŸ’¿ æ›´æ–° `app/utils/session.server.ts` ä»¥ä»ä¼šè¯ä¸­è·å– `userId`ã€‚åœ¨æˆ‘çš„è§£å†³æ–¹æ¡ˆä¸­ï¼Œæˆ‘åˆ›å»ºäº†ä¸‰ä¸ªå‡½æ•°ï¼š`getUserSession(request: Request)`ã€`getUserId(request: Request)` å’Œ `requireUserId(request: Request, redirectTo: string)`ã€‚

<details>

<summary>app/utils/session.server.ts</summary>

```ts filename=app/utils/session.server.ts lines=[55-57,59-66,68-81]
import {
  createCookieSessionStorage,
  redirect,
} from "@remix-run/node";
import bcrypt from "bcryptjs";

import { db } from "./db.server";

type LoginForm = {
  username: string;
  password: string;
};

export async function login({
  username,
  password,
}: LoginForm) {
  const user = await db.user.findUnique({
    where: { username },
  });
  if (!user) {
    return null;
  }
  const isCorrectPassword = await bcrypt.compare(
    password,
    user.passwordHash
  );
  if (!isCorrectPassword) {
    return null;
  }

  return { id: user.id, username };
}

const sessionSecret = process.env.SESSION_SECRET;
if (!sessionSecret) {
  throw new Error("SESSION_SECRET å¿…é¡»è®¾ç½®");
}

const storage = createCookieSessionStorage({
  cookie: {
    name: "RJ_session",
    // é€šå¸¸æ‚¨å¸Œæœ›å°†å…¶è®¾ç½®ä¸º `secure: true`
    // ä½†åœ¨ Safari çš„ localhost ä¸Šæ— æ³•æ­£å¸¸å·¥ä½œ
    // https://web.dev/when-to-use-local-https/
    secure: process.env.NODE_ENV === "production",
    secrets: [sessionSecret],
    sameSite: "lax",
    path: "/",
    maxAge: 60 * 60 * 24 * 30,
    httpOnly: true,
  },
});

function getUserSession(request: Request) {
  return storage.getSession(request.headers.get("Cookie"));
}

export async function getUserId(request: Request) {
  const session = await getUserSession(request);
  const userId = session.get("userId");
  if (!userId || typeof userId !== "string") {
    return null;
  }
  return userId;
}

export async function requireUserId(
  request: Request,
  redirectTo: string = new URL(request.url).pathname
) {
  const session = await getUserSession(request);
  const userId = session.get("userId");
  if (!userId || typeof userId !== "string") {
    const searchParams = new URLSearchParams([
      ["redirectTo", redirectTo],
    ]);
    throw redirect(`/login?${searchParams}`);
  }
  return userId;
}

export async function createUserSession(
  userId: string,
  redirectTo: string
) {
  const session = await storage.getSession();
  session.set("userId", userId);
  return redirect(redirectTo, {
    headers: {
      "Set-Cookie": await storage.commitSession(session),
    },
  });
}
```

</details>

<docs-info>ä½ æ³¨æ„åˆ°æˆ‘çš„ä¾‹å­ä¸­æˆ‘ä»¬æ­£åœ¨ `throw` ä¸€ä¸ª `Response` å—ï¼Ÿ</docs-info>

åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ª `requireUserId`ï¼Œå®ƒä¼šæŠ›å‡ºä¸€ä¸ª `redirect`ã€‚è¯·è®°ä½ï¼Œ`redirect` æ˜¯ä¸€ä¸ªè¿”å› [`Response`][response] å¯¹è±¡çš„å·¥å…·å‡½æ•°ã€‚Remix ä¼šæ•è·è¿™ä¸ªæŠ›å‡ºçš„å“åº”å¹¶å°†å…¶å‘é€å›å®¢æˆ·ç«¯ã€‚è¿™æ˜¯ä¸€ç§åœ¨è¿™æ ·çš„æŠ½è±¡ä¸­â€œæå‰é€€å‡ºâ€çš„å¥½æ–¹æ³•ï¼Œè¿™æ ·ä½¿ç”¨æˆ‘ä»¬ `requireUserId` å‡½æ•°çš„ç”¨æˆ·å¯ä»¥å‡è®¾è¿”å›å€¼æ€»æ˜¯ä¼šç»™æˆ‘ä»¬ `userId`ï¼Œè€Œä¸éœ€è¦æ‹…å¿ƒå¦‚æœæ²¡æœ‰ `userId` ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œå› ä¸ºå“åº”æ˜¯è¢«æŠ›å‡ºçš„ï¼Œè¿™ä¼šåœæ­¢ä»–ä»¬çš„ä»£ç æ‰§è¡Œï¼

æˆ‘ä»¬å°†åœ¨åé¢çš„é”™è¯¯å¤„ç†éƒ¨åˆ†è¯¦ç»†è®¨è®ºè¿™ä¸€ç‚¹ã€‚

ä½ å¯èƒ½è¿˜ä¼šæ³¨æ„åˆ°æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆåˆ©ç”¨äº†ä¹‹å‰æåˆ°çš„ `login` è·¯ç”±çš„ `redirectTo` åŠŸèƒ½ã€‚

ğŸ’¿ ç°åœ¨æ›´æ–° `app/routes/jokes.new.tsx`ï¼Œä½¿ç”¨è¯¥å‡½æ•°è·å– `userId` å¹¶å°†å…¶ä¼ é€’ç»™ `db.joke.create` è°ƒç”¨ã€‚

<details>

<summary>app/routes/jokes.new.tsx</summary>

```tsx filename=app/routes/jokes.new.tsx lines=[7,24,53]
import type { ActionFunctionArgs } from "@remix-run/node";
import { redirect } from "@remix-run/node";
import { useActionData } from "@remix-run/react";

import { db } from "~/utils/db.server";
import { badRequest } from "~/utils/request.server";
import { requireUserId } from "~/utils/session.server";

function validateJokeContent(content: string) {
  if (content.length < 10) {
    return "è¿™ä¸ªç¬‘è¯å¤ªçŸ­äº†";
  }
}

function validateJokeName(name: string) {
  if (name.length < 3) {
    return "è¿™ä¸ªç¬‘è¯çš„åç§°å¤ªçŸ­äº†";
  }
}

export const action = async ({
  request,
}: ActionFunctionArgs) => {
  const userId = await requireUserId(request);
  const form = await request.formData();
  const content = form.get("content");
  const name = form.get("name");
  if (
    typeof content !== "string" ||
    typeof name !== "string"
  ) {
    return badRequest({
      fieldErrors: null,
      fields: null,
      formError: "è¡¨å•æœªæ­£ç¡®æäº¤ã€‚",
    });
  }

  const fieldErrors = {
    content: validateJokeContent(content),
    name: validateJokeName(name),
  };
  const fields = { content, name };
  if (Object.values(fieldErrors).some(Boolean)) {
    return badRequest({
      fieldErrors,
      fields,
      formError: null,
    });
  }

  const joke = await db.joke.create({
    data: { ...fields, jokesterId: userId },
  });
  return redirect(`/jokes/${joke.id}`);
};

export default function NewJokeRoute() {
  const actionData = useActionData<typeof action>();

  return (
    <div>
      <p>æ·»åŠ ä½ è‡ªå·±çš„æç¬‘ç¬‘è¯</p>
      <form method="post">
        <div>
          <label>
            åç§°ï¼š{" "}
            <input
              defaultValue={actionData?.fields?.name}
              name="name"
              type="text"
              aria-invalid={Boolean(
                actionData?.fieldErrors?.name
              )}
              aria-errormessage={
                actionData?.fieldErrors?.name
                  ? "name-error"
                  : undefined
              }
            />
          </label>
          {actionData?.fieldErrors?.name ? (
            <p
              className="form-validation-error"
              id="name-error"
              role="alert"
            >
              {actionData.fieldErrors.name}
            </p>
          ) : null}
        </div>
        <div>
          <label>
            å†…å®¹ï¼š{" "}
            <textarea
              defaultValue={actionData?.fields?.content}
              name="content"
              aria-invalid={Boolean(
                actionData?.fieldErrors?.content
              )}
              aria-errormessage={
                actionData?.fieldErrors?.content
                  ? "content-error"
                  : undefined
              }
            />
          </label>
          {actionData?.fieldErrors?.content ? (
            <p
              className="form-validation-error"
              id="content-error"
              role="alert"
            >
              {actionData.fieldErrors.content}
            </p>
          ) : null}
        </div>
        <div>
          {actionData?.formError ? (
            <p
              className="form-validation-error"
              role="alert"
            >
              {actionData.formError}
            </p>
          ) : null}
          <button type="submit" className="button">
            æ·»åŠ 
          </button>
        </div>
      </form>
    </div>
  );
}
```

</details>

å¤ªå¥½äº†ï¼ç°åœ¨å¦‚æœç”¨æˆ·å°è¯•åˆ›å»ºä¸€ä¸ªæ–°çš„ç¬‘è¯ï¼Œä»–ä»¬å°†è¢«é‡å®šå‘åˆ°ç™»å½•é¡µé¢ï¼Œå› ä¸ºåˆ›å»ºæ–°ç¬‘è¯éœ€è¦ `userId`ã€‚

### æ„å»ºç™»å‡ºæ“ä½œ

æˆ‘ä»¬å¯èƒ½åº”è¯¥è®©ç”¨æˆ·èƒ½å¤Ÿçœ‹åˆ°ä»–ä»¬å·²ç™»å½•ï¼Œå¹¶æä¾›ä¸€ä¸ªç™»å‡ºçš„æ–¹å¼ï¼Œå¯¹å§ï¼Ÿæ˜¯çš„ï¼Œæˆ‘è®¤ä¸ºåº”è¯¥è¿™æ ·ã€‚è®©æˆ‘ä»¬å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚

ğŸ’¿ æ›´æ–° `app/utils/session.server.ts`ï¼Œæ·»åŠ ä¸€ä¸ª `getUser` å‡½æ•°ï¼Œä» Prisma è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä»¥åŠä¸€ä¸ª `logout` å‡½æ•°ï¼Œä½¿ç”¨ [`destroySession`][destroy-session] æ¥ç™»å‡ºç”¨æˆ·ã€‚

<details>

<summary>app/utils/session.server.ts</summary>

```ts filename=app/utils/session.server.ts lines=[84-100,102-109]
import {
  createCookieSessionStorage,
  redirect,
} from "@remix-run/node";
import bcrypt from "bcryptjs";

import { db } from "./db.server";

type LoginForm = {
  password: string;
  username: string;
};

export async function login({
  password,
  username,
}: LoginForm) {
  const user = await db.user.findUnique({
    where: { username },
  });
  if (!user) {
    return null;
  }

  const isCorrectPassword = await bcrypt.compare(
    password,
    user.passwordHash
  );
  if (!isCorrectPassword) {
    return null;
  }

  return { id: user.id, username };
}

const sessionSecret = process.env.SESSION_SECRET;
if (!sessionSecret) {
  throw new Error("SESSION_SECRET must be set");
}

const storage = createCookieSessionStorage({
  cookie: {
    name: "RJ_session",
    // normally you want this to be `secure: true`
    // but that doesn't work on localhost for Safari
    // https://web.dev/when-to-use-local-https/
    secure: process.env.NODE_ENV === "production",
    secrets: [sessionSecret],
    sameSite: "lax",
    path: "/",
    maxAge: 60 * 60 * 24 * 30,
    httpOnly: true,
  },
});

function getUserSession(request: Request) {
  return storage.getSession(request.headers.get("Cookie"));
}

export async function getUserId(request: Request) {
  const session = await getUserSession(request);
  const userId = session.get("userId");
  if (!userId || typeof userId !== "string") {
    return null;
  }
  return userId;
}

export async function requireUserId(
  request: Request,
  redirectTo: string = new URL(request.url).pathname
) {
  const session = await getUserSession(request);
  const userId = session.get("userId");
  if (!userId || typeof userId !== "string") {
    const searchParams = new URLSearchParams([
      ["redirectTo", redirectTo],
    ]);
    throw redirect(`/login?${searchParams}`);
  }
  return userId;
}

export async function getUser(request: Request) {
  const userId = await getUserId(request);
  if (typeof userId !== "string") {
    return null;
  }

  const user = await db.user.findUnique({
    select: { id: true, username: true },
    where: { id: userId },
  });

  if (!user) {
    throw await logout(request);
  }

  return user;
}

export async function logout(request: Request) {
  const session = await getUserSession(request);
  return redirect("/login", {
    headers: {
      "Set-Cookie": await storage.destroySession(session),
    },
  });
}

export async function createUserSession(
  userId: string,
  redirectTo: string
) {
  const session = await storage.getSession();
  session.set("userId", userId);
  return redirect(redirectTo, {
    headers: {
      "Set-Cookie": await storage.commitSession(session),
    },
  });
}
```

</details>

ğŸ’¿ å¾ˆå¥½ï¼Œç°åœ¨æˆ‘ä»¬è¦æ›´æ–° `app/routes/jokes.tsx` è·¯ç”±ï¼Œä»¥ä¾¿åœ¨ç”¨æˆ·æœªç™»å½•æ—¶æ˜¾ç¤ºç™»å½•é“¾æ¥ã€‚å¦‚æœä»–ä»¬å·²ç™»å½•ï¼Œåˆ™æ˜¾ç¤ºä»–ä»¬çš„ç”¨æˆ·åå’Œç™»å‡ºè¡¨å•ã€‚æˆ‘è¿˜å°†ç¨å¾®æ¸…ç†ä¸€ä¸‹ UIï¼Œä»¥åŒ¹é…æˆ‘ä»¬å·²æœ‰çš„ç±»åï¼Œæ‰€ä»¥åœ¨å‡†å¤‡å¥½æ—¶å¯ä»¥è‡ªç”±å¤åˆ¶/ç²˜è´´ç¤ºä¾‹ã€‚

<details>

<summary>app/routes/jokes.tsx</summary>

```tsx filename=app/routes/jokes.tsx lines=[3,14,20-22,28,30,50-61]
import type {
  LinksFunction,
  LoaderFunctionArgs,
} from "@remix-run/node";
import { json } from "@remix-run/node";
import {
  Link,
  Outlet,
  useLoaderData,
} from "@remix-run/react";

import stylesUrl from "~/styles/jokes.css";
import { db } from "~/utils/db.server";
import { getUser } from "~/utils/session.server";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

export const loader = async ({
  request,
}: LoaderFunctionArgs) => {
  const jokeListItems = await db.joke.findMany({
    orderBy: { createdAt: "desc" },
    select: { id: true, name: true },
    take: 5,
  });
  const user = await getUser(request);

  return json({ jokeListItems, user });
};

export default function JokesRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div className="jokes-layout">
      <header className="jokes-header">
        <div className="container">
          <h1 className="home-link">
            <Link
              to="/"
              title="Remix Jokes"
              aria-label="Remix Jokes"
            >
              <span className="logo">ğŸ¤ª</span>
              <span className="logo-medium">JğŸ¤ªKES</span>
            </Link>
          </h1>
          {data.user ? (
            <div className="user-info">
              <span>{`Hi ${data.user.username}`}</span>
              <form action="/logout" method="post">
                <button type="submit" className="button">
                  Logout
                </button>
              </form>
            </div>
          ) : (
            <Link to="/login">Login</Link>
          )}
        </div>
      </header>
      <main className="jokes-main">
        <div className="container">
          <div className="jokes-list">
            <Link to=".">Get a random joke</Link>
            <p>è¿™é‡Œæœ‰å‡ ä¸ªç¬‘è¯ä¾›æ‚¨æŸ¥çœ‹ï¼š</p>
            <ul>
              {data.jokeListItems.map(({ id, name }) => (
                <li key={id}>
                  <Link to={id}>{name}</Link>
                </li>
              ))}
            </ul>
            <Link to="new" className="button">
              æ·»åŠ è‡ªå·±çš„ç¬‘è¯
            </Link>
          </div>
          <div className="jokes-outlet">
            <Outlet />
          </div>
        </div>
      </main>
    </div>
  );
}
```

</details>

<details>

<summary>app/routes/logout.tsx</summary>

```tsx filename=app/routes/logout.tsx
import type { ActionFunctionArgs } from "@remix-run/node";
import { redirect } from "@remix-run/node";

import { logout } from "~/utils/session.server";

export const action = async ({
  request,
}: ActionFunctionArgs) => logout(request);

export const loader = async () => redirect("/");
```

</details>

å¸Œæœ›åœ¨åŠ è½½å™¨ä¸­è·å–ç”¨æˆ·å¹¶åœ¨ç»„ä»¶ä¸­æ¸²æŸ“ä»–ä»¬æ˜¯ç›¸å½“ç®€å•çš„ã€‚åœ¨ç»§ç»­ä¹‹å‰ï¼Œæˆ‘æƒ³æŒ‡å‡ºæˆ‘ç‰ˆæœ¬ä»£ç çš„å…¶ä»–éƒ¨åˆ†ä¸­çš„ä¸€äº›å†…å®¹ã€‚

é¦–å…ˆï¼Œæ–°çš„ `logout` è·¯ç”±åªæ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬ç™»å‡ºã€‚æˆ‘ä»¬ä½¿ç”¨æ“ä½œï¼ˆè€Œä¸æ˜¯åŠ è½½å™¨ï¼‰çš„åŸå› æ˜¯æˆ‘ä»¬æƒ³é€šè¿‡ä½¿ç”¨ POST è¯·æ±‚è€Œä¸æ˜¯ GET è¯·æ±‚æ¥é¿å… [CSRF][csrf] é—®é¢˜ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç™»å‡ºæŒ‰é’®æ˜¯ä¸€ä¸ªè¡¨å•è€Œä¸æ˜¯é“¾æ¥ã€‚æ­¤å¤–ï¼ŒRemix åªæœ‰åœ¨æˆ‘ä»¬æ‰§è¡Œ `action` æ—¶æ‰ä¼šé‡æ–°è°ƒç”¨æˆ‘ä»¬çš„åŠ è½½å™¨ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬ä½¿ç”¨ `loader`ï¼Œç¼“å­˜å°†ä¸ä¼šå¤±æ•ˆã€‚`loader` åªæ˜¯ä¸ºäº†é˜²æ­¢æœ‰äººä»¥æŸç§æ–¹å¼è¿›å…¥è¯¥é¡µé¢ï¼Œæˆ‘ä»¬å°†æŠŠä»–ä»¬é‡å®šå‘å›ä¸»é¡µã€‚

```tsx
<Link to="new" className="button">
  æ·»åŠ è‡ªå·±çš„ç¬‘è¯
</Link>
```

è¯·æ³¨æ„ï¼Œ`to` å±æ€§è®¾ç½®ä¸º "new" è€Œæ²¡æœ‰ä»»ä½• `/`ã€‚è¿™å°±æ˜¯åµŒå¥—è·¯ç”±çš„å¥½å¤„ã€‚æ‚¨ä¸å¿…æ„é€ æ•´ä¸ª URLã€‚å®ƒå¯ä»¥æ˜¯ç›¸å¯¹çš„ã€‚è¿™å¯¹äº `<Link to=".">è·å–éšæœºç¬‘è¯</Link>` é“¾æ¥ä¹Ÿæ˜¯ä¸€æ ·ï¼Œè¿™å°†æœ‰æ•ˆåœ°å‘Šè¯‰ Remix é‡æ–°åŠ è½½å½“å‰è·¯ç”±çš„æ•°æ®ã€‚

å¤ªå¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬çš„åº”ç”¨çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

![ç¬‘è¯é¡µé¢è®¾è®¡å¾—å¾ˆå¥½][jokes-page-nice-and-designed]

![æ–°ç¬‘è¯è¡¨å•è®¾è®¡][new-joke-form-designed]

### ç”¨æˆ·æ³¨å†Œ

æˆ‘æƒ³ç°åœ¨æ˜¯æ—¶å€™æ·»åŠ ç”¨æˆ·æ³¨å†Œæ”¯æŒäº†ï¼ä½ å’Œæˆ‘ä¸€æ ·å¿˜äº†å—ï¼ŸğŸ˜… å¥½å§ï¼Œåœ¨ç»§ç»­ä¹‹å‰è®©æˆ‘ä»¬å…ˆæ·»åŠ è¿™ä¸€éƒ¨åˆ†ã€‚

å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬æ‰€éœ€è¦åšçš„å°±æ˜¯æ›´æ–° `app/utils/session.server.ts`ï¼Œæ·»åŠ ä¸€ä¸ªä¸æˆ‘ä»¬çš„ `login` å‡½æ•°éå¸¸ç›¸ä¼¼çš„ `register` å‡½æ•°ã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ `bcrypt.hash` æ¥å¯¹å¯†ç è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œç„¶åå†å°†å…¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚æ¥ç€æ›´æ–°æˆ‘ä»¬çš„ `app/routes/login.tsx` è·¯ç”±ä¸­çš„ `register` æ¡ˆä¾‹ä»¥å¤„ç†æ³¨å†Œã€‚

ğŸ’¿ æ›´æ–° `app/utils/session.server.ts` å’Œ `app/routes/login.tsx` ä»¥å¤„ç†ç”¨æˆ·æ³¨å†Œã€‚

<details>

<summary>app/utils/session.server.ts</summary>

```tsx filename=app/utils/session.server.ts lines=[14-23]
import {
  createCookieSessionStorage,
  redirect,
} from "@remix-run/node";
import bcrypt from "bcryptjs";

import { db } from "./db.server";

type LoginForm = {
  password: string;
  username: string;
};

export async function register({
  password,
  username,
}: LoginForm) {
  const passwordHash = await bcrypt.hash(password, 10);
  const user = await db.user.create({
    data: { passwordHash, username },
  });
  return { id: user.id, username };
}

export async function login({
  password,
  username,
}: LoginForm) {
  const user = await db.user.findUnique({
    where: { username },
  });
  if (!user) {
    return null;
  }

  const isCorrectPassword = await bcrypt.compare(
    password,
    user.passwordHash
  );
  if (!isCorrectPassword) {
    return null;
  }

  return { id: user.id, username };
}

const sessionSecret = process.env.SESSION_SECRET;
if (!sessionSecret) {
  throw new Error("SESSION_SECRET must be set");
}

const storage = createCookieSessionStorage({
  cookie: {
    name: "RJ_session",
    // normally you want this to be `secure: true`
    // but that doesn't work on localhost for Safari
    // https://web.dev/when-to-use-local-https/
    secure: process.env.NODE_ENV === "production",
    secrets: [sessionSecret],
    sameSite: "lax",
    path: "/",
    maxAge: 60 * 60 * 24 * 30,
    httpOnly: true,
  },
});

function getUserSession(request: Request) {
  return storage.getSession(request.headers.get("Cookie"));
}

export async function getUserId(request: Request) {
  const session = await getUserSession(request);
  const userId = session.get("userId");
  if (!userId || typeof userId !== "string") {
    return null;
  }
  return userId;
}

export async function requireUserId(
  request: Request,
  redirectTo: string = new URL(request.url).pathname
) {
  const session = await getUserSession(request);
  const userId = session.get("userId");
  if (!userId || typeof userId !== "string") {
    const searchParams = new URLSearchParams([
      ["redirectTo", redirectTo],
    ]);
    throw redirect(`/login?${searchParams}`);
  }
  return userId;
}

export async function getUser(request: Request) {
  const userId = await getUserId(request);
  if (typeof userId !== "string") {
    return null;
  }

  const user = await db.user.findUnique({
    select: { id: true, username: true },
    where: { id: userId },
  });

  if (!user) {
    throw await logout(request);
  }

  return user;
}

export async function logout(request: Request) {
  const session = await getUserSession(request);
  return redirect("/login", {
    headers: {
      "Set-Cookie": await storage.destroySession(session),
    },
  });
}

export async function createUserSession(
  userId: string,
  redirectTo: string
) {
  const session = await storage.getSession();
  session.set("userId", userId);
  return redirect(redirectTo, {
    headers: {
      "Set-Cookie": await storage.commitSession(session),
    },
  });
}
```

</details>

<details>

<summary>app/routes/login.tsx</summary>

```tsx filename=app/routes/login.tsx lines=[17,104-112]
import type {
  ActionFunctionArgs,
  LinksFunction,
} from "@remix-run/node";
import {
  Link,
  useActionData,
  useSearchParams,
} from "@remix-run/react";

import stylesUrl from "~/styles/login.css";
import { db } from "~/utils/db.server";
import { badRequest } from "~/utils/request.server";
import {
  createUserSession,
  login,
  register,
} from "~/utils/session.server";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

function validateUsername(username: string) {
  if (username.length < 3) {
    return "ç”¨æˆ·åå¿…é¡»è‡³å°‘ä¸º 3 ä¸ªå­—ç¬¦é•¿";
  }
}

function validatePassword(password: string) {
  if (password.length < 6) {
    return "å¯†ç å¿…é¡»è‡³å°‘ä¸º 6 ä¸ªå­—ç¬¦é•¿";
  }
}

function validateUrl(url: string) {
  const urls = ["/jokes", "/", "https://remix.run"];
  if (urls.includes(url)) {
    return url;
  }
  return "/jokes";
}

export const action = async ({
  request,
}: ActionFunctionArgs) => {
  const form = await request.formData();
  const loginType = form.get("loginType");
  const password = form.get("password");
  const username = form.get("username");
  const redirectTo = validateUrl(
    (form.get("redirectTo") as string) || "/jokes"
  );
  if (
    typeof loginType !== "string" ||
    typeof password !== "string" ||
    typeof username !== "string"
  ) {
    return badRequest({
      fieldErrors: null,
      fields: null,
      formError: "è¡¨å•æœªæ­£ç¡®æäº¤ã€‚",
    });
  }

  const fields = { loginType, password, username };
  const fieldErrors = {
    password: validatePassword(password),
    username: validateUsername(username),
  };
  if (Object.values(fieldErrors).some(Boolean)) {
    return badRequest({
      fieldErrors,
      fields,
      formError: null,
    });
  }

  switch (loginType) {
    case "login": {
      const user = await login({ username, password });
      console.log({ user });
      if (!user) {
        return badRequest({
          fieldErrors: null,
          fields,
          formError:
            "ç”¨æˆ·å/å¯†ç ç»„åˆä¸æ­£ç¡®",
        });
      }
      return createUserSession(user.id, redirectTo);
    }
    case "register": {
      const userExists = await db.user.findFirst({
        where: { username },
      });
      if (userExists) {
        return badRequest({
          fieldErrors: null,
          fields,
          formError: `ç”¨æˆ·å ${username} å·²ç»å­˜åœ¨`,
        });
      }
      const user = await register({ username, password });
      if (!user) {
        return badRequest({
          fieldErrors: null,
          fields,
          formError:
            "åˆ›å»ºæ–°ç”¨æˆ·æ—¶å‘ç”Ÿé”™è¯¯ã€‚",
        });
      }
      return createUserSession(user.id, redirectTo);
    }
    default: {
      return badRequest({
        fieldErrors: null,
        fields,
        formError: "ç™»å½•ç±»å‹æ— æ•ˆ",
      });
    }
  }
};

export default function Login() {
  const actionData = useActionData<typeof action>();
  const [searchParams] = useSearchParams();
  return (
    <div className="container">
      <div className="content" data-light="">
        <h1>ç™»å½•</h1>
        <form method="post">
          <input
            type="hidden"
            name="redirectTo"
            value={
              searchParams.get("redirectTo") ?? undefined
            }
          />
          <fieldset>
            <legend className="sr-only">
              ç™»å½•æˆ–æ³¨å†Œï¼Ÿ
            </legend>
            <label>
              <input
                type="radio"
                name="loginType"
                value="login"
                defaultChecked={
                  !actionData?.fields?.loginType ||
                  actionData?.fields?.loginType === "login"
                }
              />{" "}
              ç™»å½•
            </label>
            <label>
              <input
                type="radio"
                name="loginType"
                value="register"
                defaultChecked={
                  actionData?.fields?.loginType ===
                  "register"
                }
              />{" "}
              æ³¨å†Œ
            </label>
          </fieldset>
          <div>
            <label htmlFor="username-input">ç”¨æˆ·å</label>
            <input
              type="text"
              id="username-input"
              name="username"
              defaultValue={actionData?.fields?.username}
              aria-invalid={Boolean(
                actionData?.fieldErrors?.username
              )}
              aria-errormessage={
                actionData?.fieldErrors?.username
                  ? "username-error"
                  : undefined
              }
            />
            {actionData?.fieldErrors?.username ? (
              <p
                className="form-validation-error"
                role="alert"
                id="username-error"
              >
                {actionData.fieldErrors.username}
              </p>
            ) : null}
          </div>
          <div>
            <label htmlFor="password-input">å¯†ç </label>
            <input
              id="password-input"
              name="password"
              type="password"
              defaultValue={actionData?.fields?.password}
              aria-invalid={Boolean(
                actionData?.fieldErrors?.password
              )}
              aria-errormessage={
                actionData?.fieldErrors?.password
                  ? "password-error"
                  : undefined
              }
            />
            {actionData?.fieldErrors?.password ? (
              <p
                className="form-validation-error"
                role="alert"
                id="password-error"
              >
                {actionData.fieldErrors.password}
              </p>
            ) : null}
          </div>
          <div id="form-error-message">
            {actionData?.formError ? (
              <p
                className="form-validation-error"
                role="alert"
              >
                {actionData.formError}
              </p>
            ) : null}
          </div>
          <button type="submit" className="button">
            æäº¤
          </button>
        </form>
      </div>
      <div className="links">
        <ul>
          <li>
            <Link to="/">ä¸»é¡µ</Link>
          </li>
          <li>
            <Link to="/jokes">ç¬‘è¯</Link>
          </li>
        </ul>
      </div>
    </div>
  );
}
```

</details>

å‘¼ï¼Œå®Œæˆäº†ã€‚ç°åœ¨ç”¨æˆ·å¯ä»¥æ³¨å†Œæ–°è´¦æˆ·äº†ï¼

## æ„å¤–é”™è¯¯

æŠ±æ­‰ï¼Œä½†åœ¨æŸäº›æ—¶å€™ä½ æ— æ³•é¿å…é”™è¯¯ã€‚æœåŠ¡å™¨å´©æºƒï¼ŒåŒäº‹ä½¿ç”¨ `// @ts-ignore`ï¼Œç­‰ç­‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ¥å—æ„å¤–é”™è¯¯çš„å¯èƒ½æ€§å¹¶å¤„ç†å®ƒä»¬ã€‚

å¹¸è¿çš„æ˜¯ï¼ŒRemix çš„é”™è¯¯å¤„ç†éå¸¸å‡ºè‰²ã€‚ä½ å¯èƒ½ä½¿ç”¨è¿‡ React çš„ [é”™è¯¯è¾¹ç•Œç‰¹æ€§][error-boundary-feature]ã€‚åœ¨ Remix ä¸­ï¼Œä½ çš„è·¯ç”±æ¨¡å—å¯ä»¥å¯¼å‡ºä¸€ä¸ª [`ErrorBoundary` ç»„ä»¶][error-boundary-component]ï¼Œå®ƒä¼šè¢«ä½¿ç”¨ã€‚ä½†æ›´é…·çš„æ˜¯ï¼Œå®ƒä¹Ÿåœ¨æœåŠ¡å™¨ä¸Šå·¥ä½œï¼ä¸ä»…å¦‚æ­¤ï¼Œå®ƒè¿˜ä¼šå¤„ç† `loader` å’Œ `action` ä¸­çš„é”™è¯¯ï¼å“‡ï¼é‚£ä¹ˆè®©æˆ‘ä»¬å¼€å§‹å§ï¼

å°±åƒ `useLoaderData` é’©å­ä» `loader` è·å–æ•°æ®ï¼Œ`useActionData` é’©å­ä» `action` è·å–æ•°æ®ä¸€æ ·ï¼Œ`ErrorBoundary` ä» `useRouteError` é’©å­è·å–æŠ›å‡ºçš„å®ä¾‹ã€‚

æˆ‘ä»¬å°†åœ¨åº”ç”¨ä¸­æ·»åŠ å››ä¸ª `ErrorBoundary`ã€‚åœ¨ `app/routes/jokes.*` ä¸­çš„æ¯ä¸ªå­è·¯ç”±ä¸­æ·»åŠ ä¸€ä¸ªï¼Œä»¥é˜²åœ¨è¯»å–æˆ–å¤„ç†ç¬‘è¯æ—¶å‡ºç°é”™è¯¯ï¼Œå¹¶åœ¨ `app/root.tsx` ä¸­æ·»åŠ ä¸€ä¸ªï¼Œä»¥å¤„ç†å…¶ä»–æ‰€æœ‰å†…å®¹çš„é”™è¯¯ã€‚

<docs-info> `app/root.tsx` çš„ `ErrorBoundary` æœ‰ç‚¹å¤æ‚ </docs-info>

è¯·è®°ä½ï¼Œ`app/root.tsx` æ¨¡å—è´Ÿè´£æ¸²æŸ“æˆ‘ä»¬çš„ `<html>` å…ƒç´ ã€‚å½“æ¸²æŸ“ `ErrorBoundary` æ—¶ï¼Œå®ƒä¼šæ›¿ä»£é»˜è®¤å¯¼å‡ºè¿›è¡Œæ¸²æŸ“ã€‚è¿™æ„å‘³ç€ `app/root.tsx` æ¨¡å—åº”è¯¥æ¸²æŸ“ `<html>` å…ƒç´ ä»¥åŠ `<Link />` å…ƒç´ ç­‰ã€‚

ğŸ’¿ åœ¨æ¯ä¸ªæ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªç®€å•çš„ `ErrorBoundary`ã€‚

<details>

<summary>app/root.tsx</summary>

```tsx filename=app/root.tsx lines=[6,8,28-49,51-57,59-74]
import type { LinksFunction } from "@remix-run/node";
import {
  Links,
  LiveReload,
  Outlet,
  useRouteError,
} from "@remix-run/react";
import type { PropsWithChildren } from "react";

import globalLargeStylesUrl from "~/styles/global-large.css";
import globalMediumStylesUrl from "~/styles/global-medium.css";
import globalStylesUrl from "~/styles/global.css";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: globalStylesUrl },
  {
    rel: "stylesheet",
    href: globalMediumStylesUrl,
    media: "print, (min-width: 640px)",
  },
  {
    rel: "stylesheet",
    href: globalLargeStylesUrl,
    media: "screen and (min-width: 1024px)",
  },
];

function Document({
  children,
  title = "Remix: So great, it's funny!",
}: PropsWithChildren<{ title?: string }>) {
  return (
    <html lang="en">
      <head>
        <meta charSet="utf-8" />
        <meta
          name="viewport"
          content="width=device-width, initial-scale=1"
        />
        <title>{title}</title>
        <Links />
      </head>
      <body>
        {children}
        <LiveReload />
      </body>
    </html>
  );
}

export default function App() {
  return (
    <Document>
      <Outlet />
    </Document>
  );
}

export function ErrorBoundary() {
  const error = useRouteError();

  const errorMessage =
    error instanceof Error
      ? error.message
      : "æœªçŸ¥é”™è¯¯";
  return (
    <Document title="ç³Ÿç³•ï¼">
      <div className="error-container">
        <h1>åº”ç”¨é”™è¯¯</h1>
        <pre>{errorMessage}</pre>
      </div>
    </Document>
  );
}
```

</details>

<details>

<summary>app/routes/jokes.$jokeId.tsx</summary>

```tsx filename=app/routes/jokes.$jokeId.tsx lines=[6,11-19] nocopy
// ...

import {
  Link,
  useLoaderData,
  useParams,
} from "@remix-run/react";

// ...

export function ErrorBoundary() {
  const { jokeId } = useParams();
  return (
    <div className="error-container">
      åŠ è½½ ID ä¸º "${jokeId}" çš„ç¬‘è¯æ—¶å‡ºé”™ã€‚
      æŠ±æ­‰ã€‚
    </div>
  );
}
```

</details>

<details>

<summary>app/routes/jokes.new.tsx</summary>

```tsx filename=app/routes/jokes.new.tsx nocopy
// ...

export function ErrorBoundary() {
  return (
    <div className="error-container">
      å‘ç”Ÿäº†æ„å¤–é”™è¯¯ã€‚å¯¹æ­¤æ„Ÿåˆ°æŠ±æ­‰ã€‚
    </div>
  );
}
```

</details>

<details>

<summary>app/routes/jokes._index.tsx</summary>

```tsx filename=app/routes/jokes._index.tsx nocopy
// ...

export function ErrorBoundary() {
  return (
    <div className="error-container">
      æˆ‘æç ¸äº†ã€‚
    </div>
  );
}
```

</details>

å¥½çš„ï¼Œè®¾ç½®å¥½è¿™äº›åï¼Œè®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹å½“å‘ç”Ÿé”™è¯¯æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚è¯·åœ¨æ¯ä¸ªè·¯ç”±çš„é»˜è®¤ç»„ä»¶ã€loader æˆ– action ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ã€‚

```ts
throw new Error("æµ‹è¯•é”™è¯¯è¾¹ç•Œ");
```

è¿™æ˜¯æˆ‘å¾—åˆ°çš„ç»“æœï¼š

![åº”ç”¨é”™è¯¯][app-error]

![ç¬‘è¯é¡µé¢é”™è¯¯][joke-page-error]

![ç¬‘è¯ç´¢å¼•é¡µé¢é”™è¯¯][joke-index-page-error]

![æ–°ç¬‘è¯é¡µé¢é”™è¯¯][new-joke-page-error]

æˆ‘å–œæ¬¢è¿™ä¸€ç‚¹ï¼Œå› ä¸ºåœ¨å­è·¯ç”±çš„æƒ…å†µä¸‹ï¼Œåº”ç”¨ä¸­å”¯ä¸€ä¸å¯ç”¨çš„éƒ¨åˆ†æ˜¯å®é™…å´©æºƒçš„éƒ¨åˆ†ã€‚åº”ç”¨çš„å…¶ä½™éƒ¨åˆ†å®Œå…¨å¯ä»¥äº¤äº’ã€‚è¿™å¯¹ç”¨æˆ·ä½“éªŒåˆæ˜¯ä¸€ä¸ªåŠ åˆ†é¡¹ï¼

## é¢„æœŸé”™è¯¯

æœ‰æ—¶å€™ç”¨æˆ·ä¼šåšä¸€äº›æˆ‘ä»¬å¯ä»¥é¢„è§çš„äº‹æƒ…ã€‚æˆ‘å¹¶ä¸æ˜¯åœ¨è°ˆè®ºéªŒè¯ï¼Œè€Œæ˜¯åƒç”¨æˆ·æ˜¯å¦ç»è¿‡èº«ä»½éªŒè¯ï¼ˆçŠ¶æ€ `401`ï¼‰æˆ–æ˜¯å¦æœ‰æƒé™ï¼ˆçŠ¶æ€ `403`ï¼‰å»åšä»–ä»¬æƒ³åšçš„äº‹æƒ…ã€‚æˆ–è€…ä»–ä»¬å¯èƒ½åœ¨å¯»æ‰¾ä¸€äº›ä¸å­˜åœ¨çš„ä¸œè¥¿ï¼ˆçŠ¶æ€ `404`ï¼‰ã€‚

å¯ä»¥å°†æ„å¤–é”™è¯¯è§†ä¸º 500 çº§é”™è¯¯ï¼ˆ[æœåŠ¡å™¨é”™è¯¯][server-errors]ï¼‰ï¼Œè€Œå°†é¢„æœŸé”™è¯¯è§†ä¸º 400 çº§é”™è¯¯ï¼ˆ[å®¢æˆ·ç«¯é”™è¯¯][client-errors]ï¼‰ã€‚

ä¸ºäº†æ£€æŸ¥å®¢æˆ·ç«¯é”™è¯¯å“åº”ï¼ŒRemix æä¾›äº† [`isRouteErrorResponse`][is-route-error-response] è¾…åŠ©å‡½æ•°ã€‚å¦‚æœæ‚¨çš„æœåŠ¡å™¨ä»£ç æ£€æµ‹åˆ°é—®é¢˜ï¼Œå®ƒå°†æŠ›å‡ºä¸€ä¸ª [`Response`][response] å¯¹è±¡ã€‚Remix ç„¶åæ•è·è¯¥æŠ›å‡ºçš„ `Response` å¹¶æ¸²æŸ“æ‚¨çš„ `ErrorBoundary`ã€‚ç”±äºæ‚¨å¯ä»¥æŠ›å‡ºä»»ä½•å†…å®¹ï¼Œ`isRouteErrorResponse` è¾…åŠ©å‡½æ•°æ˜¯ä¸€ç§æ£€æŸ¥æŠ›å‡ºçš„å®ä¾‹æ˜¯å¦ä¸º `Response` å¯¹è±¡çš„æ–¹æ³•ã€‚

æœ€åä¸€ç‚¹ï¼Œè¿™ä¸æ˜¯ç”¨äºè¡¨å•éªŒè¯ç­‰çš„ã€‚æˆ‘ä»¬ä¹‹å‰å·²ç»é€šè¿‡ `useActionData` è®¨è®ºè¿‡è¿™ä¸ªã€‚è¿™ä»…é€‚ç”¨äºç”¨æˆ·åšäº†ä¸€äº›äº‹æƒ…ï¼Œå¯¼è‡´æˆ‘ä»¬æ— æ³•åˆç†æ¸²æŸ“é»˜è®¤ç»„ä»¶çš„æƒ…å†µï¼Œå› æ­¤æˆ‘ä»¬æƒ³æ¸²æŸ“å…¶ä»–å†…å®¹ã€‚

<docs-info>`ErrorBoundary` å…è®¸æˆ‘ä»¬çš„é»˜è®¤å¯¼å‡ºè¡¨ç¤ºâ€œå¿«ä¹è·¯å¾„â€ï¼Œè€Œä¸å¿…æ‹…å¿ƒé”™è¯¯ã€‚å¦‚æœæ¸²æŸ“äº†é»˜è®¤ç»„ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å‡è®¾ä¸€åˆ‡éƒ½å¾ˆå¥½ã€‚</docs-info>

åœ¨ç†è§£äº†è¿™ä¸€ç‚¹åï¼Œæˆ‘ä»¬å°†å‘ä»¥ä¸‹è·¯ç”±æ·»åŠ  `isRouteErrorResponse` æ£€æŸ¥ï¼š

- `app/root.tsx` - ä½œä¸ºæœ€åçš„åå¤‡ã€‚
- `app/routes/jokes.$jokeId.tsx` - å½“ç”¨æˆ·å°è¯•è®¿é—®ä¸å­˜åœ¨çš„ç¬‘è¯æ—¶ï¼ˆ404ï¼‰ã€‚
- `app/routes/jokes.new.tsx` - å½“ç”¨æˆ·å°è¯•åœ¨æœªç»è¿‡èº«ä»½éªŒè¯çš„æƒ…å†µä¸‹è®¿é—®æ­¤é¡µé¢æ—¶ï¼ˆ401ï¼‰ã€‚ç°åœ¨ï¼Œå¦‚æœä»–ä»¬å°è¯•åœ¨æœªç»è¿‡èº«ä»½éªŒè¯çš„æƒ…å†µä¸‹æäº¤ï¼Œå°†è¢«é‡å®šå‘åˆ°ç™»å½•é¡µé¢ã€‚èŠ±æ—¶é—´å†™ç¬‘è¯å´è¢«é‡å®šå‘æ˜¯éå¸¸çƒ¦äººçš„ã€‚ä¸å…¶æ¯«æ— è§£é‡Šåœ°é‡å®šå‘ä»–ä»¬ï¼Œæˆ‘ä»¬å¯ä»¥æ¸²æŸ“ä¸€æ¡æ¶ˆæ¯ï¼Œè¯´æ˜ä»–ä»¬éœ€è¦å…ˆè¿›è¡Œèº«ä»½éªŒè¯ã€‚
- `app/routes/jokes._index.tsx` - å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰ç¬‘è¯ï¼Œåˆ™éšæœºç¬‘è¯ä¸º 404-æœªæ‰¾åˆ°ã€‚ï¼ˆé€šè¿‡åˆ é™¤ `prisma/dev.db` å¹¶è¿è¡Œ `npx prisma db push` æ¥æ¨¡æ‹Ÿæ­¤æ“ä½œã€‚ä¸è¦å¿˜è®°åœ¨ä¹‹åè¿è¡Œ `npx prisma db seed` ä»¥æ¢å¤ç§å­æ•°æ®ã€‚ï¼‰

ğŸ’¿ è®©æˆ‘ä»¬å°†è¿™äº› `isRouteErrorResponse` æ£€æŸ¥æ·»åŠ åˆ°è·¯ç”±ä¸­ã€‚

<details>

<summary>app/root.tsx</summary>

```tsx filename=app/root.tsx lines=[3,63-75]
import type { LinksFunction } from "@remix-run/node";
import {
  isRouteErrorResponse,
  Links,
  LiveReload,
  Outlet,
  useRouteError,
} from "@remix-run/react";
import type { PropsWithChildren } from "react";

import globalLargeStylesUrl from "~/styles/global-large.css";
import globalMediumStylesUrl from "~/styles/global-medium.css";
import globalStylesUrl from "~/styles/global.css";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: globalStylesUrl },
  {
    rel: "stylesheet",
    href: globalMediumStylesUrl,
    media: "print, (min-width: 640px)",
  },
  {
    rel: "stylesheet",
    href: globalLargeStylesUrl,
    media: "screen and (min-width: 1024px)",
  },
];

function Document({
  children,
  title = "Remix: So great, it's funny!",
}: PropsWithChildren<{ title?: string }>) {
  return (
    <html lang="en">
      <head>
        <meta charSet="utf-8" />
        <meta
          name="viewport"
          content="width=device-width, initial-scale=1"
        />
        <title>{title}</title>
        <Links />
      </head>
      <body>
        {children}
        <LiveReload />
      </body>
    </html>
  );
}

export default function App() {
  return (
    <Document>
      <Outlet />
    </Document>
  );
}

export function ErrorBoundary() {
  const error = useRouteError();

  if (isRouteErrorResponse(error)) {
    return (
      <Document
        title={`${error.status} ${error.statusText}`}
      >
        <div className="error-container">
          <h1>
            {error.status} {error.statusText}
          </h1>
        </div>
      </Document>
    );
  }

  const errorMessage =
    error instanceof Error
      ? error.message
      : "æœªçŸ¥é”™è¯¯";
  return (
    <Document title="å“å‘€ï¼">
      <div className="error-container">
        <h1>åº”ç”¨é”™è¯¯</h1>
        <pre>{errorMessage}</pre>
      </div>
    </Document>
  );
}
```

</details>

<details>

<summary>app/routes/jokes.$jokeId.tsx</summary>

```tsx filename=app/routes/jokes.$jokeId.tsx lines=[4,8,20-22,41,43-49]
import type { LoaderFunctionArgs } from "@remix-run/node";
import { json } from "@remix-run/node";
import {
  isRouteErrorResponse,
  Link,
  useLoaderData,
  useParams,
  useRouteError,
} from "@remix-run/react";

import { db } from "~/utils/db.server";

export const loader = async ({
  params,
}: LoaderFunctionArgs) => {
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Response("è¿™æ˜¯ä»€ä¹ˆç¬‘è¯ï¼æœªæ‰¾åˆ°ã€‚", {
      status: 404,
    });
  }
  return json({ joke });
};

export default function JokeRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div>
      <p>è¿™æ˜¯ä½ çš„æç¬‘ç¬‘è¯ï¼š</p>
      <p>{data.joke.content}</p>
      <Link to=".">"{data.joke.name}" æ°¸ä¹…é“¾æ¥</Link>
    </div>
  );
}

export function ErrorBoundary() {
  const { jokeId } = useParams();
  const error = useRouteError();

  if (isRouteErrorResponse(error) && error.status === 404) {
    return (
      <div className="error-container">
        å—¯ï¼Ÿ"{jokeId}" åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ
      </div>
    );
  }

  return (
    <div className="error-container">
      åŠ è½½ ID ä¸º "${jokeId}" çš„ç¬‘è¯æ—¶å‡ºé”™ã€‚
      æŠ±æ­‰ã€‚
    </div>
  );
}
```

</details>

<details>

<summary>app/routes/jokes._index.tsx</summary>

```tsx filename=app/routes/jokes._index.tsx lines=[3,6,18-22,41,43-50]
import { json } from "@remix-run/node";
import {
  isRouteErrorResponse,
  Link,
  useLoaderData,
  useRouteError,
} from "@remix-run/react";

import { db } from "~/utils/db.server";

export const loader = async () => {
  const count = await db.joke.count();
  const randomRowNumber = Math.floor(Math.random() * count);
  const [randomJoke] = await db.joke.findMany({
    skip: randomRowNumber,
    take: 1,
  });
  if (!randomJoke) {
    throw new Response("æ²¡æœ‰æ‰¾åˆ°éšæœºç¬‘è¯", {
      status: 404,
    });
  }
  return json({ randomJoke });
};

export default function JokesIndexRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div>
      <p>è¿™æ˜¯ä¸€ä¸ªéšæœºç¬‘è¯ï¼š</p>
      <p>{data.randomJoke.content}</p>
      <Link to={data.randomJoke.id}>
        "{data.randomJoke.name}" æ°¸ä¹…é“¾æ¥
      </Link>
    </div>
  );
}

export function ErrorBoundary() {
  const error = useRouteError();

  if (isRouteErrorResponse(error) && error.status === 404) {
    return (
      <div className="error-container">
        <p>æ²¡æœ‰ç¬‘è¯å¯ä»¥æ˜¾ç¤ºã€‚</p>
        <Link to="new">æ·»åŠ ä½ è‡ªå·±çš„</Link>
      </div>
    );
  }

  return (
    <div className="error-container">
      æˆ‘çŠ¯äº†ä¸ªé”™è¯¯ã€‚
    </div>
  );
}
```

</details>

<details>

<summary>app/routes/jokes.new.tsx</summary>

```tsx filename=app/routes/jokes.new.tsx lines=[3,5,7,10,16,20-30,162,164-171]
import type {
  ActionFunctionArgs,
  LoaderFunctionArgs,
} from "@remix-run/node";
import { json, redirect } from "@remix-run/node";
import {
  isRouteErrorResponse,
  Link,
  useActionData,
  useRouteError,
} from "@remix-run/react";

import { db } from "~/utils/db.server";
import { badRequest } from "~/utils/request.server";
import {
  getUserId,
  requireUserId,
} from "~/utils/session.server";

export const loader = async ({
  request,
}: LoaderFunctionArgs) => {
  const userId = await getUserId(request);
  if (!userId) {
    throw new Response("æœªç»æˆæƒ", { status: 401 });
  }
  return json({});
};

function validateJokeContent(content: string) {
  if (content.length < 10) {
    return "è¿™ä¸ªç¬‘è¯å¤ªçŸ­äº†";
  }
}

function validateJokeName(name: string) {
  if (name.length < 3) {
    return "è¿™ä¸ªç¬‘è¯çš„åå­—å¤ªçŸ­äº†";
  }
}

export const action = async ({
  request,
}: ActionFunctionArgs) => {
  const userId = await requireUserId(request);
  const form = await request.formData();
  const content = form.get("content");
  const name = form.get("name");
  if (
    typeof content !== "string" ||
    typeof name !== "string"
  ) {
    return badRequest({
      fieldErrors: null,
      fields: null,
      formError: "è¡¨å•æœªæ­£ç¡®æäº¤ã€‚",
    });
  }

  const fieldErrors = {
    content: validateJokeContent(content),
    name: validateJokeName(name),
  };
  const fields = { content, name };
  if (Object.values(fieldErrors).some(Boolean)) {
    return badRequest({
      fieldErrors,
      fields,
      formError: null,
    });
  }

  const joke = await db.joke.create({
    data: { ...fields, jokesterId: userId },
  });
  return redirect(`/jokes/${joke.id}`);
};

export default function NewJokeRoute() {
  const actionData = useActionData<typeof action>();

  return (
    <div>
      <p>æ·»åŠ ä½ è‡ªå·±çš„æç¬‘ç¬‘è¯</p>
      <form method="post">
        <div>
          <label>
            åç§°ï¼š{" "}
            <input
              defaultValue={actionData?.fields?.name}
              name="name"
              type="text"
              aria-invalid={Boolean(
                actionData?.fieldErrors?.name
              )}
              aria-errormessage={
                actionData?.fieldErrors?.name
                  ? "name-error"
                  : undefined
              }
            />
          </label>
          {actionData?.fieldErrors?.name ? (
            <p
              className="form-validation-error"
              id="name-error"
              role="alert"
            >
              {actionData.fieldErrors.name}
            </p>
          ) : null}
        </div>
        <div>
          <label>
            å†…å®¹ï¼š{" "}
            <textarea
              defaultValue={actionData?.fields?.content}
              name="content"
              aria-invalid={Boolean(
                actionData?.fieldErrors?.content
              )}
              aria-errormessage={
                actionData?.fieldErrors?.content
                  ? "content-error"
                  : undefined
              }
            />
          </label>
          {actionData?.fieldErrors?.content ? (
            <p
              className="form-validation-error"
              id="content-error"
              role="alert"
            >
              {actionData.fieldErrors.content}
            </p>
          ) : null}
        </div>
        <div>
          {actionData?.formError ? (
            <p
              className="form-validation-error"
              role="alert"
            >
              {actionData.formError}
            </p>
          ) : null}
          <button type="submit" className="button">
            æ·»åŠ 
          </button>
        </div>
      </form>
    </div>
  );
}

export function ErrorBoundary() {
  const error = useRouteError();

  if (isRouteErrorResponse(error) && error.status === 401) {
    return (
      <div className="error-container">
        <p>æ‚¨å¿…é¡»å…ˆç™»å½•æ‰èƒ½åˆ›å»ºç¬‘è¯ã€‚</p>
        <Link to="/login">ç™»å½•</Link>
      </div>
    );
  }

  return (
    <div className="error-container">
      å‡ºç°æ„å¤–é”™è¯¯ã€‚å¯¹æ­¤è¡¨ç¤ºæ­‰æ„ã€‚
    </div>
  );
}
```

</details>

è¿™æ˜¯æˆ‘å¾—åˆ°çš„ç»“æœï¼š

![App 400 Bad Request][app-400-bad-request]

![A 404 on the joke page][a-404-on-the-joke-page]

![A 404 on the random joke page][a-404-on-the-random-joke-page]

![A 401 on the new joke page][a-401-on-the-new-joke-page]

å¤ªæ£’äº†ï¼æˆ‘ä»¬å‡†å¤‡å¥½å¤„ç†é”™è¯¯äº†ï¼Œè¿™å¹¶æ²¡æœ‰è®©æˆ‘ä»¬çš„å¿«ä¹è·¯å¾„å˜å¾—å¤æ‚ï¼ ğŸ‰

å“¦ï¼Œä½ ä¸è§‰å¾—è¿™éƒ½æ˜¯ä¸Šä¸‹æ–‡ç›¸å…³çš„å—ï¼Ÿæ‰€ä»¥åº”ç”¨çš„å…¶ä½™éƒ¨åˆ†ç»§ç»­æ­£å¸¸è¿è¡Œã€‚ç”¨æˆ·ä½“éªŒåˆå¾—ä¸€åˆ† ğŸ’ª

ä½ çŸ¥é“å—ï¼Œåœ¨æˆ‘ä»¬æ·»åŠ  `ErrorBoundary` çš„åŒæ—¶ï¼Œä¸ºä»€ä¹ˆä¸ç¨å¾®æ”¹è¿›ä¸€ä¸‹ `app/routes/jokes.$jokeId.tsx` è·¯ç”±ï¼Œè®©ç”¨æˆ·å¯ä»¥åˆ é™¤ä»–ä»¬æ‹¥æœ‰çš„ç¬‘è¯å‘¢ã€‚å¦‚æœä»–ä»¬æ²¡æœ‰æ‹¥æœ‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `ErrorBoundary` ä¸­ç»™ä»–ä»¬ä¸€ä¸ª403é”™è¯¯ã€‚

éœ€è¦è®°ä½çš„ä¸€ç‚¹æ˜¯ï¼Œ`delete` çš„ HTML è¡¨å•åªæ”¯æŒ `method="get"` å’Œ `method="post"`ã€‚å®ƒä»¬ä¸æ”¯æŒ `method="delete"`ã€‚å› æ­¤ï¼Œä¸ºäº†ç¡®ä¿æˆ‘ä»¬çš„è¡¨å•åœ¨æœ‰å’Œæ²¡æœ‰ JavaScript çš„æƒ…å†µä¸‹éƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Œæœ€å¥½åšä»¥ä¸‹æ“ä½œï¼š

```tsx
<form method="post">
  <button name="intent" type="submit" value="delete">
    Delete
  </button>
</form>
```

ç„¶å `action` å¯ä»¥æ ¹æ® `request.formData().get('intent')` æ¥åˆ¤æ–­æ„å›¾æ˜¯å¦ä¸ºåˆ é™¤ã€‚

ğŸ’¿ ä¸º `app/routes/jokes.$jokeId.tsx` è·¯ç”±æ·»åŠ åˆ é™¤åŠŸèƒ½ã€‚

<details>

<summary>app/routes/jokes.$jokeId.tsx</summary>

```tsx filename=app/routes/jokes.$jokeId.tsx lines=[2,5,7,11,15,31-59,69-78,88-101]
import type {
  ActionFunctionArgs,
  LoaderFunctionArgs,
} from "@remix-run/node";
import { json, redirect } from "@remix-run/node";
import {
  isRouteErrorResponse,
  Link,
  useLoaderData,
  useParams,
  useRouteError,
} from "@remix-run/react";

import { db } from "~/utils/db.server";
import { requireUserId } from "~/utils/session.server";

export const loader = async ({
  params,
}: LoaderFunctionArgs) => {
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Response("è¿™ä¸ªç¬‘è¯ï¼æœªæ‰¾åˆ°ã€‚", {
      status: 404,
    });
  }
  return json({ joke });
};

export const action = async ({
  params,
  request,
}: ActionFunctionArgs) => {
  const form = await request.formData();
  if (form.get("intent") !== "delete") {
    throw new Response(
      `æ„å›¾ ${form.get("intent")} ä¸è¢«æ”¯æŒ`,
      { status: 400 }
    );
  }
  const userId = await requireUserId(request);
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Response("æ— æ³•åˆ é™¤ä¸å­˜åœ¨çš„å†…å®¹", {
      status: 404,
    });
  }
  if (joke.jokesterId !== userId) {
    throw new Response(
      "å˜˜ï¼Œè¯•å¾—ä¸é”™ã€‚ä½†é‚£ä¸æ˜¯ä½ çš„ç¬‘è¯",
      { status: 403 }
    );
  }
  await db.joke.delete({ where: { id: params.jokeId } });
  return redirect("/jokes");
};

export default function JokeRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div>
      <p>è¿™æ˜¯ä½ çš„æç¬‘ç¬‘è¯ï¼š</p>
      <p>{data.joke.content}</p>
      <Link to=".">"{data.joke.name}" æ°¸ä¹…é“¾æ¥</Link>
      <form method="post">
        <button
          className="button"
          name="intent"
          type="submit"
          value="delete"
        >
          åˆ é™¤
        </button>
      </form>
    </div>
  );
}

export function ErrorBoundary() {
  const { jokeId } = useParams();
  const error = useRouteError();

  if (isRouteErrorResponse(error)) {
    if (error.status === 400) {
      return (
        <div className="error-container">
          ä½ å°è¯•åšçš„äº‹æƒ…æ˜¯ä¸è¢«å…è®¸çš„ã€‚
        </div>
      );
    }
    if (error.status === 403) {
      return (
        <div className="error-container">
          å¯¹ä¸èµ·ï¼Œä½† "{jokeId}" ä¸æ˜¯ä½ çš„ç¬‘è¯ã€‚
        </div>
      );
    }
    if (error.status === 404) {
      return (
        <div className="error-container">
          å—¯ï¼Ÿ"{jokeId}" æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ
        </div>
      );
    }
  }

  return (
    <div className="error-container">
      åŠ è½½ id ä¸º "${jokeId}" çš„ç¬‘è¯æ—¶å‡ºé”™ã€‚
      å¯¹ä¸èµ·ã€‚
    </div>
  );
}
```

</details>

ç°åœ¨å¦‚æœç”¨æˆ·å°è¯•åˆ é™¤ä¸å±äºä»–ä»¬çš„ç¬‘è¯ï¼Œå°±ä¼šå¾—åˆ°é€‚å½“çš„é”™è¯¯æ¶ˆæ¯ï¼Œä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥ç®€å•åœ°éšè—åˆ é™¤æŒ‰é’®ï¼Œå¦‚æœç”¨æˆ·ä¸æ‹¥æœ‰è¿™ä¸ªç¬‘è¯çš„è¯ã€‚

<details>

<summary>app/routes/jokes.$jokeId.tsx</summary>

```tsx filename=app/routes/jokes.$jokeId.tsx lines=[16,22,24,34,77,88]
import type {
  ActionFunctionArgs,
  LoaderFunctionArgs,
} from "@remix-run/node";
import { json, redirect } from "@remix-run/node";
import {
  isRouteErrorResponse,
  Link,
  useLoaderData,
  useParams,
  useRouteError,
} from "@remix-run/react";

import { db } from "~/utils/db.server";
import {
  getUserId,
  requireUserId,
} from "~/utils/session.server";

export const loader = async ({
  params,
  request,
}: LoaderFunctionArgs) => {
  const userId = await getUserId(request);
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Response("è¿™ä¸ªç¬‘è¯ï¼æœªæ‰¾åˆ°ã€‚", {
      status: 404,
    });
  }
  return json({
    isOwner: userId === joke.jokesterId,
    joke,
  });
};

export const action = async ({
  params,
  request,
}: ActionFunctionArgs) => {
  const form = await request.formData();
  if (form.get("intent") !== "delete") {
    throw new Response(
      `æ„å›¾ ${form.get("intent")} ä¸è¢«æ”¯æŒ`,
      { status: 400 }
    );
  }
  const userId = await requireUserId(request);
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Response("æ— æ³•åˆ é™¤ä¸å­˜åœ¨çš„å†…å®¹", {
      status: 404,
    });
  }
  if (joke.jokesterId !== userId) {
    throw new Response(
      "å˜˜ï¼Œè¯•å¾—ä¸é”™ã€‚ä½†é‚£ä¸æ˜¯ä½ çš„ç¬‘è¯",
      { status: 403 }
    );
  }
  await db.joke.delete({ where: { id: params.jokeId } });
  return redirect("/jokes");
};

export default function JokeRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div>
      <p>è¿™æ˜¯ä½ çš„æç¬‘ç¬‘è¯ï¼š</p>
      <p>{data.joke.content}</p>
      <Link to=".">"{data.joke.name}" æ°¸ä¹…é“¾æ¥</Link>
      {data.isOwner ? (
        <form method="post">
          <button
            className="button"
            name="intent"
            type="submit"
            value="delete"
          >
            åˆ é™¤
          </button>
        </form>
      ) : null}
    </div>
  );
}

export function ErrorBoundary() {
  const { jokeId } = useParams();
  const error = useRouteError();

  if (isRouteErrorResponse(error)) {
    if (error.status === 400) {
      return (
        <div className="error-container">
          ä½ å°è¯•åšçš„äº‹æƒ…æ˜¯ä¸è¢«å…è®¸çš„ã€‚
        </div>
      );
    }
    if (error.status === 403) {
      return (
        <div className="error-container">
          å¯¹ä¸èµ·ï¼Œä½† "{jokeId}" ä¸æ˜¯ä½ çš„ç¬‘è¯ã€‚
        </div>
      );
    }
    if (error.status === 404) {
      return (
        <div className="error-container">
          å—¯ï¼Ÿ"{jokeId}" æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ
        </div>
      );
    }
  }

  return (
    <div className="error-container">
      åŠ è½½ id ä¸º "${jokeId}" çš„ç¬‘è¯æ—¶å‡ºé”™ã€‚
      å¯¹ä¸èµ·ã€‚
    </div>
  );
}
```

</details>

## SEOä¸Metaæ ‡ç­¾

Metaæ ‡ç­¾å¯¹äºSEOå’Œç¤¾äº¤åª’ä½“éå¸¸æœ‰ç”¨ã€‚æ£˜æ‰‹çš„éƒ¨åˆ†åœ¨äºï¼Œé€šå¸¸è®¿é—®æ‰€éœ€æ•°æ®çš„ä»£ç éƒ¨åˆ†åœ¨è¯·æ±‚/ä½¿ç”¨æ•°æ®çš„ç»„ä»¶ä¸­ã€‚

è¿™å°±æ˜¯Remixæä¾›[`meta`][meta]å¯¼å‡ºçš„åŸå› ã€‚ä¸ºä»€ä¹ˆä¸æ¥ç»™ä»¥ä¸‹è·¯ç”±æ·»åŠ ä¸€äº›æœ‰ç”¨çš„metaæ ‡ç­¾å‘¢ï¼š

- `app/routes/login.tsx`
- `app/routes/jokes.$jokeId.tsx` - ï¼ˆè¿™ä¸ªä½ å¯ä»¥åœ¨æ ‡é¢˜ä¸­å¼•ç”¨ç¬‘è¯çš„åç§°ï¼Œè¿™å¾ˆæœ‰è¶£ï¼‰

ä½†åœ¨ä½ å¼€å§‹ä¹‹å‰ï¼Œè¯·è®°ä½ï¼Œæˆ‘ä»¬è´Ÿè´£ä»`<html>`åˆ°`</html>`çš„æ‰€æœ‰æ¸²æŸ“ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦ç¡®ä¿è¿™äº›`meta`æ ‡ç­¾åœ¨`<html>`çš„`<head>`ä¸­æ¸²æŸ“ã€‚è¿™å°±æ˜¯Remixç»™æˆ‘ä»¬æä¾›[`Meta`ç»„ä»¶][meta-component]çš„åŸå› ã€‚

ğŸ’¿ å°†`Meta`ç»„ä»¶æ·»åŠ åˆ°`app/root.tsx`ï¼Œå¹¶å°†`meta`å¯¼å‡ºæ·»åŠ åˆ°ä¸Šè¿°æåˆ°çš„è·¯ç”±ä¸­ã€‚`Meta`ç»„ä»¶éœ€è¦æ”¾åœ¨ç°æœ‰çš„`<title>`æ ‡ç­¾ä¹‹ä¸Šï¼Œä»¥ä¾¿åœ¨æä¾›æ—¶èƒ½å¤Ÿè¦†ç›–å®ƒã€‚

<details>

<summary>app/root.tsx</summary>

```tsx filename=app/root.tsx lines=[3,9,33-42,46,56-69]
import type {
  LinksFunction,
  MetaFunction,
} from "@remix-run/node";
import {
  isRouteErrorResponse,
  Links,
  LiveReload,
  Meta,
  Outlet,
  useRouteError,
} from "@remix-run/react";
import type { PropsWithChildren } from "react";

import globalLargeStylesUrl from "~/styles/global-large.css";
import globalMediumStylesUrl from "~/styles/global-medium.css";
import globalStylesUrl from "~/styles/global.css";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: globalStylesUrl },
  {
    rel: "stylesheet",
    href: globalMediumStylesUrl,
    media: "print, (min-width: 640px)",
  },
  {
    rel: "stylesheet",
    href: globalLargeStylesUrl,
    media: "screen and (min-width: 1024px)",
  },
];

export const meta: MetaFunction = () => {
  const description =
    "å­¦ä¹ Remixï¼ŒåŒæ—¶äº«å—ä¹è¶£ï¼";

  return [
    { name: "description", content: description },
    { name: "twitter:description", content: description },
    { title: "Remix: å¤ªæ£’äº†ï¼ŒçœŸæœ‰è¶£ï¼" },
  ];
};

function Document({
  children,
  title,
}: PropsWithChildren<{ title?: string }>) {
  return (
    <html lang="en">
      <head>
        <meta charSet="utf-8" />
        <meta
          name="viewport"
          content="width=device-width, initial-scale=1"
        />
        <meta name="keywords" content="Remix,jokes" />
        <meta
          name="twitter:image"
          content="https://remix-jokes.lol/social.png"
        />
        <meta
          name="twitter:card"
          content="summary_large_image"
        />
        <meta name="twitter:creator" content="@remix_run" />
        <meta name="twitter:site" content="@remix_run" />
        <meta name="twitter:title" content="Remix Jokes" />
        <Meta />
        {title ? <title>{title}</title> : null}
        <Links />
      </head>
      <body>
        {children}
        <LiveReload />
      </body>
    </html>
  );
}

export default function App() {
  return (
    <Document>
      <Outlet />
    </Document>
  );
}

export function ErrorBoundary() {
  const error = useRouteError();

  if (isRouteErrorResponse(error)) {
    return (
      <Document
        title={`${error.status} ${error.statusText}`}
      >
        <div className="error-container">
          <h1>
            {error.status} {error.statusText}
          </h1>
        </div>
      </Document>
    );
  }

  const errorMessage =
    error instanceof Error
      ? error.message
      : "æœªçŸ¥é”™è¯¯";
  return (
    <Document title="å“å‘€ï¼">
      <div className="error-container">
        <h1>åº”ç”¨é”™è¯¯</h1>
        <pre>{errorMessage}</pre>
      </div>
    </Document>
  );
}
```

</details>

<details>

<summary>app/routes/login.tsx</summary>

```tsx filename=app/routes/login.tsx lines=[4,25-34]
import type {
  ActionFunctionArgs,
  LinksFunction,
  MetaFunction,
} from "@remix-run/node";
import {
  Link,
  useActionData,
  useSearchParams,
} from "@remix-run/react";

import stylesUrl from "~/styles/login.css";
import { db } from "~/utils/db.server";
import { badRequest } from "~/utils/request.server";
import {
  createUserSession,
  login,
  register,
} from "~/utils/session.server";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

export const meta: MetaFunction = () => {
  const description =
    "ç™»å½•ä»¥æäº¤æ‚¨è‡ªå·±çš„ç¬‘è¯åˆ°Remix Jokesï¼";

  return [
    { name: "description", content: description },
    { name: "twitter:description", content: description },
    { title: "Remix Jokes | ç™»å½•" },
  ];
};

function validateUsername(username: string) {
  if (username.length < 3) {
    return "ç”¨æˆ·åå¿…é¡»è‡³å°‘ä¸º3ä¸ªå­—ç¬¦";
  }
}

function validatePassword(password: string) {
  if (password.length < 6) {
    return "å¯†ç å¿…é¡»è‡³å°‘ä¸º6ä¸ªå­—ç¬¦";
  }
}

function validateUrl(url: string) {
  const urls = ["/jokes", "/", "https://remix.run"];
  if (urls.includes(url)) {
    return url;
  }
  return "/jokes";
}

export const action = async ({
  request,
}: ActionFunctionArgs) => {
  const form = await request.formData();
  const loginType = form.get("loginType");
  const password = form.get("password");
  const username = form.get("username");
  const redirectTo = validateUrl(
    (form.get("redirectTo") as string) || "/jokes"
  );
  if (
    typeof loginType !== "string" ||
    typeof password !== "string" ||
    typeof username !== "string"
  ) {
    return badRequest({
      fieldErrors: null,
      fields: null,
      formError: "è¡¨å•æœªæ­£ç¡®æäº¤ã€‚",
    });
  }

  const fields = { loginType, password, username };
  const fieldErrors = {
    password: validatePassword(password),
    username: validateUsername(username),
  };
  if (Object.values(fieldErrors).some(Boolean)) {
    return badRequest({
      fieldErrors,
      fields,
      formError: null,
    });
  }

  switch (loginType) {
    case "login": {
      const user = await login({ username, password });
      console.log({ user });
      if (!user) {
        return badRequest({
          fieldErrors: null,
          fields,
          formError:
            "ç”¨æˆ·å/å¯†ç ç»„åˆä¸æ­£ç¡®",
        });
      }
      return createUserSession(user.id, redirectTo);
    }
    case "register": {
      const userExists = await db.user.findFirst({
        where: { username },
      });
      if (userExists) {
        return badRequest({
          fieldErrors: null,
          fields,
          formError: `ç”¨æˆ·åä¸º ${username} çš„ç”¨æˆ·å·²å­˜åœ¨`,
        });
      }
      const user = await register({ username, password });
      if (!user) {
        return badRequest({
          fieldErrors: null,
          fields,
          formError:
            "åˆ›å»ºæ–°ç”¨æˆ·æ—¶å‡ºç°é—®é¢˜ã€‚",
        });
      }
      return createUserSession(user.id, redirectTo);
    }
    default: {
      return badRequest({
        fieldErrors: null,
        fields,
        formError: "ç™»å½•ç±»å‹æ— æ•ˆ",
      });
    }
  }
};

export default function Login() {
  const actionData = useActionData<typeof action>();
  const [searchParams] = useSearchParams();
  return (
    <div className="container">
      <div className="content" data-light="">
        <h1>ç™»å½•</h1>
        <form method="post">
          <input
            type="hidden"
            name="redirectTo"
            value={
              searchParams.get("redirectTo") ?? undefined
            }
          />
          <fieldset>
            <legend className="sr-only">
              ç™»å½•æˆ–æ³¨å†Œï¼Ÿ
            </legend>
            <label>
              <input
                type="radio"
                name="loginType"
                value="login"
                defaultChecked={
                  !actionData?.fields?.loginType ||
                  actionData?.fields?.loginType === "login"
                }
              />{" "}
              ç™»å½•
            </label>
            <label>
              <input
                type="radio"
                name="loginType"
                value="register"
                defaultChecked={
                  actionData?.fields?.loginType ===
                  "register"
                }
              />{" "}
              æ³¨å†Œ
            </label>
          </fieldset>
          <div>
            <label htmlFor="username-input">ç”¨æˆ·å</label>
            <input
              type="text"
              id="username-input"
              name="username"
              defaultValue={actionData?.fields?.username}
              aria-invalid={Boolean(
                actionData?.fieldErrors?.username
              )}
              aria-errormessage={
                actionData?.fieldErrors?.username
                  ? "username-error"
                  : undefined
              }
            />
            {actionData?.fieldErrors?.username ? (
              <p
                className="form-validation-error"
                role="alert"
                id="username-error"
              >
                {actionData.fieldErrors.username}
              </p>
            ) : null}
          </div>
          <div>
            <label htmlFor="password-input">å¯†ç </label>
            <input
              id="password-input"
              name="password"
              type="password"
              defaultValue={actionData?.fields?.password}
              aria-invalid={Boolean(
                actionData?.fieldErrors?.password
              )}
              aria-errormessage={
                actionData?.fieldErrors?.password
                  ? "password-error"
                  : undefined
              }
            />
            {actionData?.fieldErrors?.password ? (
              <p
                className="form-validation-error"
                role="alert"
                id="password-error"
              >
                {actionData.fieldErrors.password}
              </p>
            ) : null}
          </div>
          <div id="form-error-message">
            {actionData?.formError ? (
              <p
                className="form-validation-error"
                role="alert"
              >
                {actionData.formError}
              </p>
            ) : null}
          </div>
          <button type="submit" className="button">
            æäº¤
          </button>
        </form>
      </div>
      <div className="links">
        <ul>
          <li>
            <Link to="/">é¦–é¡µ</Link>
          </li>
          <li>
            <Link to="/jokes">ç¬‘è¯</Link>
          </li>
        </ul>
      </div>
    </div>
  );
}
```

</details>

<details>

<summary>app/routes/jokes.$jokeId.tsx</summary>

```tsx filename=app/routes/jokes.$jokeId.tsx lines=[4,21-36]
import type {
  ActionFunctionArgs,
  LoaderFunctionArgs,
  MetaFunction,
} from "@remix-run/node";
import { json, redirect } from "@remix-run/node";
import {
  isRouteErrorResponse,
  Link,
  useLoaderData,
  useParams,
  useRouteError,
} from "@remix-run/react";

import { db } from "~/utils/db.server";
import {
  getUserId,
  requireUserId,
} from "~/utils/session.server";

export const meta: MetaFunction<typeof loader> = ({
  data,
}) => {
  const { description, title } = data
    ? {
        description: `äº«å— "${data.joke.name}" ç¬‘è¯ä»¥åŠæ›´å¤šå†…å®¹`,
        title: `"${data.joke.name}" ç¬‘è¯`,
      }
    : { description: "æœªæ‰¾åˆ°ç¬‘è¯", title: "æ²¡æœ‰ç¬‘è¯" };

  return [
    { name: "description", content: description },
    { name: "twitter:description", content: description },
    { title },
  ];
};

export const loader = async ({
  params,
  request,
}: LoaderFunctionArgs) => {
  const userId = await getUserId(request);
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Response("ä»€ä¹ˆç¬‘è¯ï¼æœªæ‰¾åˆ°ã€‚", {
      status: 404,
    });
  }
  return json({
    isOwner: userId === joke.jokesterId,
    joke,
  });
};

export const action = async ({
  params,
  request,
}: ActionFunctionArgs) => {
  const form = await request.formData();
  if (form.get("intent") !== "delete") {
    throw new Response(
      `æ„å›¾ ${form.get("intent")} ä¸è¢«æ”¯æŒ`,
      { status: 400 }
    );
  }
  const userId = await requireUserId(request);
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Response("æ— æ³•åˆ é™¤ä¸å­˜åœ¨çš„å†…å®¹", {
      status: 404,
    });
  }
  if (joke.jokesterId !== userId) {
    throw new Response(
      "å˜˜ï¼Œå¥½çš„å°è¯•ã€‚é‚£ä¸æ˜¯ä½ çš„ç¬‘è¯",
      { status: 403 }
    );
  }
  await db.joke.delete({ where: { id: params.jokeId } });
  return redirect("/jokes");
};

export default function JokeRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div>
      <p>è¿™æ˜¯ä½ çš„æç¬‘ç¬‘è¯ï¼š</p>
      <p>{data.joke.content}</p>
      <Link to=".">"{data.joke.name}" æ°¸ä¹…é“¾æ¥</Link>
      {data.isOwner ? (
        <form method="post">
          <button
            className="button"
            name="intent"
            type="submit"
            value="delete"
          >
            åˆ é™¤
          </button>
        </form>
      ) : null}
    </div>
  );
}

export function ErrorBoundary() {
  const { jokeId } = useParams();
  const error = useRouteError();

  if (isRouteErrorResponse(error)) {
    if (error.status === 400) {
      return (
        <div className="error-container">
          ä½ æ­£åœ¨å°è¯•çš„æ“ä½œæ˜¯ä¸å…è®¸çš„ã€‚
        </div>
      );
    }
    if (error.status === 403) {
      return (
        <div className="error-container">
          æŠ±æ­‰ï¼Œ"{jokeId}" ä¸æ˜¯ä½ çš„ç¬‘è¯ã€‚
        </div>
      );
    }
    if (error.status === 404) {
      return (
        <div className="error-container">
          å—¯ï¼Ÿ"{jokeId}" æ˜¯ä»€ä¹ˆï¼Ÿ
        </div>
      );
    }
  }

  return (
    <div className="error-container">
      åŠ è½½ ID ä¸º "${jokeId}" çš„ç¬‘è¯æ—¶å‡ºé”™ã€‚
      æŠ±æ­‰ã€‚
    </div>
  );
}
```

</details>

å¤ªå¥½äº†ï¼ç°åœ¨æœç´¢å¼•æ“å’Œç¤¾äº¤åª’ä½“å¹³å°ä¼šæ›´å–œæ¬¢æˆ‘ä»¬çš„ç½‘ç«™ã€‚

## èµ„æºè·¯ç”±

æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„è·¯ç”±æ¸²æŸ“ä¸€äº›å…¶ä»–çš„å†…å®¹ï¼Œè€Œä¸æ˜¯ HTML æ–‡æ¡£ã€‚ä¾‹å¦‚ï¼Œä¹Ÿè®¸ä½ æœ‰ä¸€ä¸ªç«¯ç‚¹ï¼Œç”¨äºç”Ÿæˆåšå®¢æ–‡ç« çš„ç¤¾äº¤å›¾ç‰‡ï¼Œæˆ–è€…äº§å“çš„å›¾ç‰‡ï¼Œæˆ–è€…æŠ¥å‘Šçš„ CSV æ•°æ®ï¼Œæˆ–è€… RSS æºï¼Œæˆ–è€…ç½‘ç«™åœ°å›¾ï¼Œæˆ–è€…ä½ å¯èƒ½æƒ³ä¸ºä½ çš„ç§»åŠ¨åº”ç”¨ç¨‹åºå®ç° API è·¯ç”±ï¼Œæˆ–è€…å…¶ä»–ä»»ä½•ä¸œè¥¿ã€‚

è¿™å°±æ˜¯ [èµ„æºè·¯ç”±][resource-routes] çš„ç”¨é€”ã€‚æˆ‘è®¤ä¸ºæ‹¥æœ‰ä¸€ä¸ªåŒ…å«æˆ‘ä»¬æ‰€æœ‰ç¬‘è¯çš„ RSS æºä¼šå¾ˆé…·ã€‚æˆ‘è§‰å¾—å®ƒåº”è¯¥ä½äº URL `/jokes.rss`ã€‚ä¸ºäº†ä½¿å…¶å·¥ä½œï¼Œä½ éœ€è¦è½¬ä¹‰ `.`ï¼Œå› ä¸ºè¯¥å­—ç¬¦åœ¨ Remix è·¯ç”±æ–‡ä»¶åä¸­å…·æœ‰ç‰¹æ®Šå«ä¹‰ã€‚äº†è§£æ›´å¤šå…³äº [è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦çš„ä¿¡æ¯][escaping-special-characters-here]ã€‚

<docs-info>ä¿¡ä¸ä¿¡ç”±ä½ ï¼Œä½ å®é™…ä¸Šå·²ç»åˆ›å»ºäº†å…¶ä¸­ä¸€ä¸ªã€‚æŸ¥çœ‹ä½ çš„æ³¨é”€è·¯ç”±ï¼ä¸éœ€è¦ UIï¼Œå› ä¸ºå®ƒåªæ˜¯ç”¨æ¥å¤„ç†å˜æ›´å¹¶é‡å®šå‘è¿·å¤±çš„çµé­‚ã€‚</docs-info>

å¯¹äºè¿™ä¸ªï¼Œä½ å¯èƒ½è‡³å°‘æƒ³çœ‹çœ‹ç¤ºä¾‹ï¼Œé™¤éä½ æƒ³å»é˜…è¯» RSS è§„èŒƒ ğŸ˜…ã€‚

ğŸ’¿ åˆ›å»ºä¸€ä¸ª `/jokes.rss` è·¯ç”±ã€‚

<details>

<summary>app/routes/jokes[.]rss.tsx</summary>

```tsx filename=app/routes/jokes[.]rss.tsx
import type { LoaderFunctionArgs } from "@remix-run/node";

import { db } from "~/utils/db.server";

function escapeCdata(s: string) {
  return s.replace(/\]\]>/g, "]]]]><![CDATA[>");
}

function escapeHtml(s: string) {
  return s
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

export const loader = async ({
  request,
}: LoaderFunctionArgs) => {
  const jokes = await db.joke.findMany({
    include: { jokester: { select: { username: true } } },
    orderBy: { createdAt: "desc" },
    take: 100,
  });

  const host =
    request.headers.get("X-Forwarded-Host") ??
    request.headers.get("host");
  if (!host) {
    throw new Error("Could not determine domain URL.");
  }
  const protocol = host.includes("localhost")
    ? "http"
    : "https";
  const domain = `${protocol}://${host}`;
  const jokesUrl = `${domain}/jokes`;

  const rssString = `
    <rss xmlns:blogChannel="${jokesUrl}" version="2.0">
      <channel>
        <title>Remix Jokes</title>
        <link>${jokesUrl}</link>
        <description>ä¸€äº›æœ‰è¶£çš„ç¬‘è¯</description>
        <language>zh-cn</language>
        <generator>Kody the Koala</generator>
        <ttl>40</ttl>
        ${jokes
          .map((joke) =>
            `
            <item>
              <title><![CDATA[${escapeCdata(
                joke.name
              )}]]></title>
              <description><![CDATA[ä¸€ä¸ªå«åš ${escapeHtml(
                joke.name
              )} çš„æœ‰è¶£ç¬‘è¯]]></description>
              <author><![CDATA[${escapeCdata(
                joke.jokester.username
              )}]]></author>
              <pubDate>${joke.createdAt.toUTCString()}</pubDate>
              <link>${jokesUrl}/${joke.id}</link>
              <guid>${jokesUrl}/${joke.id}</guid>
            </item>
          `.trim()
          )
          .join("\n")}
      </channel>
    </rss>
  `.trim();

  return new Response(rssString, {
    headers: {
      "Cache-Control": `public, max-age=${
        60 * 10
      }, s-maxage=${60 * 60 * 24}`,
      "Content-Type": "application/xml",
      "Content-Length": String(
        Buffer.byteLength(rssString)
      ),
    },
  });
};
```

</details>

![XML æ–‡æ¡£çš„ RSS æº][xml-document-for-rss-feed]

å¤ªå¥½äº†ï¼ä½ å¯ä»¥ç”¨è¿™ä¸ª API åšä»»ä½•ä½ èƒ½æƒ³è±¡çš„äº‹æƒ…ã€‚å¦‚æœä½ æƒ³çš„è¯ï¼Œç”šè‡³å¯ä»¥ä¸ºä½ åº”ç”¨çš„åŸç”Ÿç‰ˆæœ¬åˆ¶ä½œä¸€ä¸ª JSON APIã€‚è¿™é‡Œæœ‰å¾ˆå¤šåŠŸèƒ½ã€‚

ğŸ’¿ éšæ„åœ¨ `app/routes/_index.tsx` å’Œ `app/routes/jokes.tsx` é¡µé¢ä¸Šæ·»åŠ è¯¥ RSS æºçš„é“¾æ¥ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœä½ ä½¿ç”¨ `<Link />`ï¼Œä½ éœ€è¦ä½¿ç”¨ `reloadDocument` å±æ€§ï¼Œå› ä¸ºä½ ä¸èƒ½è¿›è¡Œå®¢æˆ·ç«¯è¿‡æ¸¡åˆ°ä¸€ä¸ªæŠ€æœ¯ä¸Šä¸å±äº React åº”ç”¨ç¨‹åºçš„ URLã€‚

<details>

<summary>app/routes/_index.tsx</summary>

```tsx filename=app/routes/_index.tsx lines=[22-26]
import type { LinksFunction } from "@remix-run/node";
import { Link } from "@remix-run/react";

import stylesUrl from "~/styles/index.css";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

export default function IndexRoute() {
  return (
    <div className="container">
      <div className="content">
        <h1>
          Remix <span>ç¬‘è¯!</span>
        </h1>
        <nav>
          <ul>
            <li>
              <Link to="jokes">é˜…è¯»ç¬‘è¯</Link>
            </li>
            <li>
              <Link reloadDocument to="/jokes.rss">
                RSS
              </Link>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  );
}
```

</details>

<details>

<summary>app/routes/jokes.tsx</summary>

```tsx filename=app/routes/jokes.tsx lines=[85-91]
import type {
  LinksFunction,
  LoaderFunctionArgs,
} from "@remix-run/node";
import { json } from "@remix-run/node";
import {
  Link,
  Outlet,
  useLoaderData,
} from "@remix-run/react";

import stylesUrl from "~/styles/jokes.css";
import { db } from "~/utils/db.server";
import { getUser } from "~/utils/session.server";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

export const loader = async ({
  request,
}: LoaderFunctionArgs) => {
  const jokeListItems = await db.joke.findMany({
    orderBy: { createdAt: "desc" },
    select: { id: true, name: true },
    take: 5,
  });
  const user = await getUser(request);

  return json({ jokeListItems, user });
};

export default function JokesRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div className="jokes-layout">
      <header className="jokes-header">
        <div className="container">
          <h1 className="home-link">
            <Link
              to="/"
              title="Remix Jokes"
              aria-label="Remix Jokes"
            >
              <span className="logo">ğŸ¤ª</span>
              <span className="logo-medium">ç¬‘ğŸ˜‚è¯</span>
            </Link>
          </h1>
          {data.user ? (
            <div className="user-info">
              <span>{`å—¨ ${data.user.username}`}</span>
              <form action="/logout" method="post">
                <button type="submit" className="button">
                  æ³¨é”€
                </button>
              </form>
            </div>
          ) : (
            <Link to="/login">ç™»å½•</Link>
          )}
        </div>
      </header>
      <main className="jokes-main">
        <div className="container">
          <div className="jokes-list">
            <Link to=".">è·å–ä¸€ä¸ªéšæœºç¬‘è¯</Link>
            <p>è¿™é‡Œæœ‰æ›´å¤šç¬‘è¯å¯ä»¥æŸ¥çœ‹ï¼š</p>
            <ul>
              {data.jokeListItems.map(({ id, name }) => (
                <li key={id}>
                  <Link to={id}>{name}</Link>
                </li>
              ))}
            </ul>
            <Link to="new" className="button">
              æ·»åŠ ä½ è‡ªå·±çš„
            </Link>
          </div>
          <div className="jokes-outlet">
            <Outlet />
          </div>
        </div>
      </main>
      <footer className="jokes-footer">
        <div className="container">
          <Link reloadDocument to="/jokes.rss">
            RSS
          </Link>
        </div>
      </footer>
    </div>
  );
}
```

</details>

## JavaScript...

ä¹Ÿè®¸æˆ‘ä»¬åº”è¯¥åœ¨æˆ‘ä»¬çš„ JavaScript åº”ç”¨ä¸­å®é™…åŒ…å« JavaScriptã€‚ ğŸ˜‚

è¯´çœŸçš„ï¼Œæ‰“å¼€ä½ çš„ç½‘ç»œæ ‡ç­¾ï¼Œå¯¼èˆªåˆ°æˆ‘ä»¬çš„åº”ç”¨ã€‚

![ç½‘ç»œæ ‡ç­¾æ˜¾ç¤ºæ²¡æœ‰åŠ è½½ JavaScript][network-tab-indicating-no-java-script-is-loaded]

ä½ æ³¨æ„åˆ°æˆ‘ä»¬çš„åº”ç”¨åœ¨æ­¤ä¹‹å‰æ²¡æœ‰åŠ è½½ä»»ä½• JavaScript å—ï¼Ÿ ğŸ˜† è¿™å®é™…ä¸Šæ˜¯ç›¸å½“é‡è¦çš„ã€‚æˆ‘ä»¬çš„æ•´ä¸ªåº”ç”¨å¯ä»¥åœ¨é¡µé¢ä¸Šå®Œå…¨ä¸ä½¿ç”¨ JavaScript çš„æƒ…å†µä¸‹è¿è¡Œã€‚è¿™æ˜¯å› ä¸º Remix ä¸ºæˆ‘ä»¬å……åˆ†åˆ©ç”¨äº†å¹³å°ã€‚

æˆ‘ä»¬çš„åº”ç”¨èƒ½åœ¨æ²¡æœ‰ JavaScript çš„æƒ…å†µä¸‹è¿è¡Œæœ‰ä»€ä¹ˆé‡è¦æ€§ï¼Ÿæ˜¯å› ä¸ºæˆ‘ä»¬æ‹…å¿ƒé‚£ 0.002% çš„ç”¨æˆ·ç¦ç”¨äº† JS å—ï¼Ÿå…¶å®ä¸æ˜¯ã€‚å› ä¸ºå¹¶ä¸æ˜¯æ¯ä¸ªäººéƒ½åœ¨ä»¥è¶…å¿«çš„è¿æ¥ä½¿ç”¨ä½ çš„åº”ç”¨ï¼Œæœ‰æ—¶ JavaScript éœ€è¦ä¸€äº›æ—¶é—´åŠ è½½ï¼Œæˆ–è€…æ ¹æœ¬æ— æ³•åŠ è½½ã€‚åœ¨æ²¡æœ‰ JavaScript çš„æƒ…å†µä¸‹è®©ä½ çš„åº”ç”¨æ­£å¸¸è¿è¡Œæ„å‘³ç€å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œä½ çš„åº”ç”¨ _ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œ_ï¼Œå³ä½¿åœ¨ JavaScript å®ŒæˆåŠ è½½ä¹‹å‰ã€‚

åˆä¸€ä¸ªç”¨æˆ·ä½“éªŒçš„åŠ åˆ†ç‚¹ï¼

åœ¨é¡µé¢ä¸ŠåŒ…å« JavaScript æ˜¯æœ‰åŸå› çš„ã€‚ä¾‹å¦‚ï¼Œä¸€äº›å¸¸è§çš„ UI ä½“éªŒåœ¨æ²¡æœ‰ JavaScript çš„æƒ…å†µä¸‹æ— æ³•è®¿é—®ï¼ˆç‰¹åˆ«æ˜¯å½“ä½ åˆ°å¤„éƒ½æœ‰å…¨é¡µé¢é‡æ–°åŠ è½½æ—¶ï¼Œç„¦ç‚¹ç®¡ç†å¹¶ä¸å¥½ï¼‰ã€‚è€Œä¸”å½“æˆ‘ä»¬åœ¨é¡µé¢ä¸Šæœ‰ JavaScript æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¹è§‚ UIï¼ˆå³å°†æ¨å‡ºï¼‰æ¥æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚ä½†æˆ‘ä»¬è®¤ä¸ºå±•ç¤ºåœ¨ç½‘ç»œè¿æ¥ä¸ä½³çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Remix å¯ä»¥åšåˆ°çš„äº‹æƒ…æ˜¯å¾ˆé…·çš„ã€‚ ğŸ’ª

å¥½çš„ï¼Œç°åœ¨è®©æˆ‘ä»¬åœ¨è¿™ä¸ªé¡µé¢ä¸ŠåŠ è½½ JavaScript ğŸ˜†

ğŸ’¿ ä½¿ç”¨ Remix çš„ [`<Scripts />` ç»„ä»¶][scripts-component] åœ¨ `app/root.tsx` ä¸­åŠ è½½æ‰€æœ‰ JavaScript æ–‡ä»¶ã€‚

<details>

<summary>app/root.tsx</summary>

```tsx filename=app/root.tsx lines=[11,75]
import type {
  LinksFunction,
  MetaFunction,
} from "@remix-run/node";
import {
  isRouteErrorResponse,
  Links,
  LiveReload,
  Meta,
  Outlet,
  Scripts,
  useRouteError,
} from "@remix-run/react";
import type { PropsWithChildren } from "react";

import globalLargeStylesUrl from "~/styles/global-large.css";
import globalMediumStylesUrl from "~/styles/global-medium.css";
import globalStylesUrl from "~/styles/global.css";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: globalStylesUrl },
  {
    rel: "stylesheet",
    href: globalMediumStylesUrl,
    media: "print, (min-width: 640px)",
  },
  {
    rel: "stylesheet",
    href: globalLargeStylesUrl,
    media: "screen and (min-width: 1024px)",
  },
];

export const meta: MetaFunction = () => {
  const description =
    "å­¦ä¹  Remixï¼ŒåŒæ—¶äº«å—ä¹è¶£ï¼";

  return [
    { name: "description", content: description },
    { name: "twitter:description", content: description },
    { title: "Remix: å¤ªæ£’äº†ï¼ŒçœŸæœ‰è¶£ï¼" },
  ];
};

function Document({
  children,
  title,
}: PropsWithChildren<{ title?: string }>) {
  return (
    <html lang="en">
      <head>
        <meta charSet="utf-8" />
        <meta
          name="viewport"
          content="width=device-width, initial-scale=1"
        />
        <meta name="keywords" content="Remix,jokes" />
        <meta
          name="twitter:image"
          content="https://remix-jokes.lol/social.png"
        />
        <meta
          name="twitter:card"
          content="summary_large_image"
        />
        <meta name="twitter:creator" content="@remix_run" />
        <meta name="twitter:site" content="@remix_run" />
        <meta name="twitter:title" content="Remix Jokes" />
        <Meta />
        {title ? <title>{title}</title> : null}
        <Links />
      </head>
      <body>
        {children}
        <Scripts />
        <LiveReload />
      </body>
    </html>
  );
}

export default function App() {
  return (
    <Document>
      <Outlet />
    </Document>
  );
}

export function ErrorBoundary() {
  const error = useRouteError();

  if (isRouteErrorResponse(error)) {
    return (
      <Document
        title={`${error.status} ${error.statusText}`}
      >
        <div className="error-container">
          <h1>
            {error.status} {error.statusText}
          </h1>
        </div>
      </Document>
    );
  }

  const errorMessage =
    error instanceof Error
      ? error.message
      : "æœªçŸ¥é”™è¯¯";
  return (
    <Document title="å“å‘€ï¼">
      <div className="error-container">
        <h1>åº”ç”¨é”™è¯¯</h1>
        <pre>{errorMessage}</pre>
      </div>
    </Document>
  );
}
```

</details>

![ç½‘ç»œæ ‡ç­¾æ˜¾ç¤º JavaScript å·²åŠ è½½][network-tab-showing-java-script-loaded]

ğŸ’¿ ç°åœ¨æˆ‘ä»¬å¯ä»¥åšçš„å¦ä¸€ä»¶äº‹æ˜¯ï¼Œä½ å¯ä»¥åœ¨æ‰€æœ‰çš„ `ErrorBoundary` ç»„ä»¶ä¸­ä½¿ç”¨ `console.error(error);`ï¼Œè¿™æ ·ä½ å°±èƒ½åœ¨æµè§ˆå™¨çš„æ§åˆ¶å°ä¸­è®°å½•æœåŠ¡å™¨ç«¯é”™è¯¯ã€‚ ğŸ¤¯

<details>

<summary>app/root.tsx</summary>

```tsx filename=app/root.tsx lines=[92]
import type {
  LinksFunction,
  MetaFunction,
} from "@remix-run/node";
import {
  isRouteErrorResponse,
  Links,
  LiveReload,
  Meta,
  Outlet,
  Scripts,
  useRouteError,
} from "@remix-run/react";
import type { PropsWithChildren } from "react";

import globalLargeStylesUrl from "~/styles/global-large.css";
import globalMediumStylesUrl from "~/styles/global-medium.css";
import globalStylesUrl from "~/styles/global.css";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: globalStylesUrl },
  {
    rel: "stylesheet",
    href: globalMediumStylesUrl,
    media: "print, (min-width: 640px)",
  },
  {
    rel: "stylesheet",
    href: globalLargeStylesUrl,
    media: "screen and (min-width: 1024px)",
  },
];

export const meta: MetaFunction = () => {
  const description =
    "å­¦ä¹  Remixï¼ŒåŒæ—¶äº«å—ä¹è¶£ï¼";

  return [
    { name: "description", content: description },
    { name: "twitter:description", content: description },
    { title: "Remix: å¤ªæ£’äº†ï¼ŒçœŸæœ‰è¶£ï¼" },
  ];
};

function Document({
  children,
  title,
}: PropsWithChildren<{ title?: string }>) {
  return (
    <html lang="en">
      <head>
        <meta charSet="utf-8" />
        <meta
          name="viewport"
          content="width=device-width, initial-scale=1"
        />
        <meta name="keywords" content="Remix,jokes" />
        <meta
          name="twitter:image"
          content="https://remix-jokes.lol/social.png"
        />
        <meta
          name="twitter:card"
          content="summary_large_image"
        />
        <meta name="twitter:creator" content="@remix_run" />
        <meta name="twitter:site" content="@remix_run" />
        <meta name="twitter:title" content="Remix Jokes" />
        <Meta />
        {title ? <title>{title}</title> : null}
        <Links />
      </head>
      <body>
        {children}
        <Scripts />
        <LiveReload />
      </body>
    </html>
  );
}

export default function App() {
  return (
    <Document>
      <Outlet />
    </Document>
  );
}

export function ErrorBoundary() {
  const error = useRouteError();
  console.error(error);

  if (isRouteErrorResponse(error)) {
    return (
      <Document
        title={`${error.status} ${error.statusText}`}
      >
        <div className="error-container">
          <h1>
            {error.status} {error.statusText}
          </h1>
        </div>
      </Document>
    );
  }

  const errorMessage =
    error instanceof Error
      ? error.message
      : "æœªçŸ¥é”™è¯¯";
  return (
    <Document title="å“å‘€ï¼">
      <div className="error-container">
        <h1>åº”ç”¨é”™è¯¯</h1>
        <pre>{errorMessage}</pre>
      </div>
    </Document>
  );
}
```

</details>

<details>

<summary>app/routes/jokes.$jokeId.tsx</summary>

```tsx filename=app/routes/jokes.$jokeId.tsx lines=[114]
import type {
  ActionFunctionArgs,
  LoaderFunctionArgs,
  MetaFunction,
} from "@remix-run/node";
import { json, redirect } from "@remix-run/node";
import {
  isRouteErrorResponse,
  Link,
  useLoaderData,
  useParams,
  useRouteError,
} from "@remix-run/react";

import { db } from "~/utils/db.server";
import {
  getUserId,
  requireUserId,
} from "~/utils/session.server";

export const meta: MetaFunction<typeof loader> = ({
  data,
}) => {
  const { description, title } = data
    ? {
        description: `äº«å— "${data.joke.name}" ç¬‘è¯å’Œæ›´å¤šå†…å®¹`,
        title: `"${data.joke.name}" ç¬‘è¯`,
      }
    : { description: "æœªæ‰¾åˆ°ç¬‘è¯", title: "æ²¡æœ‰ç¬‘è¯" };

  return [
    { name: "description", content: description },
    { name: "twitter:description", content: description },
    { title },
  ];
};

export const loader = async ({
  params,
  request,
}: LoaderFunctionArgs) => {
  const userId = await getUserId(request);
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Response("çœŸæ˜¯ä¸ªç¬‘è¯ï¼æœªæ‰¾åˆ°ã€‚", {
      status: 404,
    });
  }
  return json({
    isOwner: userId === joke.jokesterId,
    joke,
  });
};

export const action = async ({
  params,
  request,
}: ActionFunctionArgs) => {
  const form = await request.formData();
  if (form.get("intent") !== "delete") {
    throw new Response(
      `æ„å›¾ ${form.get("intent")} ä¸è¢«æ”¯æŒ`,
      { status: 400 }
    );
  }
  const userId = await requireUserId(request);
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Response("æ— æ³•åˆ é™¤ä¸å­˜åœ¨çš„å†…å®¹", {
      status: 404,
    });
  }
  if (joke.jokesterId !== userId) {
    throw new Response(
      "å˜˜ï¼Œåˆ«æƒ³äº†ã€‚è¿™ä¸æ˜¯ä½ çš„ç¬‘è¯",
      { status: 403 }
    );
  }
  await db.joke.delete({ where: { id: params.jokeId } });
  return redirect("/jokes");
};

export default function JokeRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div>
      <p>è¿™æ˜¯ä½ çš„æç¬‘ç¬‘è¯ï¼š</p>
      <p>{data.joke.content}</p>
      <Link to=".">"{data.joke.name}" æ°¸ä¹…é“¾æ¥</Link>
      {data.isOwner ? (
        <form method="post">
          <button
            className="button"
            name="intent"
            type="submit"
            value="delete"
          >
            åˆ é™¤
          </button>
        </form>
      ) : null}
    </div>
  );
}

export function ErrorBoundary() {
  const { jokeId } = useParams();
  const error = useRouteError();
  console.error(error);

  if (isRouteErrorResponse(error)) {
    if (error.status === 400) {
      return (
        <div className="error-container">
          ä½ å°è¯•åšçš„äº‹æƒ…æ˜¯ä¸å…è®¸çš„ã€‚
        </div>
      );
    }
    if (error.status === 403) {
      return (
        <div className="error-container">
          æŠ±æ­‰ï¼Œä½† "{jokeId}" ä¸æ˜¯ä½ çš„ç¬‘è¯ã€‚
        </div>
      );
    }
    if (error.status === 404) {
      return (
        <div className="error-container">
          å—¯ï¼Ÿ"{jokeId}" æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ
        </div>
      );
    }
  }

  return (
    <div className="error-container">
      åŠ è½½ id ä¸º "${jokeId}" çš„ç¬‘è¯æ—¶å‘ç”Ÿé”™è¯¯ã€‚
      æŠ±æ­‰ã€‚
    </div>
  );
}
```

</details>

<details>

<summary>app/routes/jokes._index.tsx</summary>

```tsx filename=app/routes/jokes._index.tsx lines=[42]
import { json } from "@remix-run/node";
import {
  isRouteErrorResponse,
  Link,
  useLoaderData,
  useRouteError,
} from "@remix-run/react";

import { db } from "~/utils/db.server";

export const loader = async () => {
  const count = await db.joke.count();
  const randomRowNumber = Math.floor(Math.random() * count);
  const [randomJoke] = await db.joke.findMany({
    skip: randomRowNumber,
    take: 1,
  });
  if (!randomJoke) {
    throw new Response("æœªæ‰¾åˆ°éšæœºç¬‘è¯", {
      status: 404,
    });
  }
  return json({ randomJoke });
};

export default function JokesIndexRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div>
      <p>è¿™æ˜¯ä¸€ä¸ªéšæœºç¬‘è¯ï¼š</p>
      <p>{data.randomJoke.content}</p>
      <Link to={data.randomJoke.id}>
        "{data.randomJoke.name}" æ°¸ä¹…é“¾æ¥
      </Link>
    </div>
  );
}

export function ErrorBoundary() {
  const error = useRouteError();
  console.error(error);

  if (isRouteErrorResponse(error) && error.status === 404) {
    return (
      <div className="error-container">
        <p>æ²¡æœ‰å¯æ˜¾ç¤ºçš„ç¬‘è¯ã€‚</p>
        <Link to="new">æ·»åŠ ä½ è‡ªå·±çš„ç¬‘è¯</Link>
      </div>
    );
  }

  return (
    <div className="error-container">
      æˆ‘çŠ¯äº†ä¸€ä¸ªé”™è¯¯ã€‚
    </div>
  );
}
```

</details>

<details>

<summary>app/routes/jokes.new.tsx</summary>

```tsx filename=app/routes/jokes.new.tsx lines=[159]
import type {
  ActionFunctionArgs,
  LoaderFunctionArgs,
} from "@remix-run/node";
import { json, redirect } from "@remix-run/node";
import {
  isRouteErrorResponse,
  Link,
  useActionData,
  useRouteError,
} from "@remix-run/react";

import { db } from "~/utils/db.server";
import { badRequest } from "~/utils/request.server";
import {
  getUserId,
  requireUserId,
} from "~/utils/session.server";

export const loader = async ({
  request,
}: LoaderFunctionArgs) => {
  const userId = await getUserId(request);
  if (!userId) {
    throw new Response("æœªæˆæƒ", { status: 401 });
  }
  return json({});
};

function validateJokeContent(content: string) {
  if (content.length < 10) {
    return "è¿™ä¸ªç¬‘è¯å¤ªçŸ­äº†";
  }
}

function validateJokeName(name: string) {
  if (name.length < 3) {
    return "è¿™ä¸ªç¬‘è¯çš„åå­—å¤ªçŸ­äº†";
  }
}

export const action = async ({
  request,
}: ActionFunctionArgs) => {
  const userId = await requireUserId(request);
  const form = await request.formData();
  const content = form.get("content");
  const name = form.get("name");
  if (
    typeof content !== "string" ||
    typeof name !== "string"
  ) {
    return badRequest({
      fieldErrors: null,
      fields: null,
      formError: "è¡¨å•æœªæ­£ç¡®æäº¤ã€‚",
    });
  }

  const fieldErrors = {
    content: validateJokeContent(content),
    name: validateJokeName(name),
  };
  const fields = { content, name };
  if (Object.values(fieldErrors).some(Boolean)) {
    return badRequest({
      fieldErrors,
      fields,
      formError: null,
    });
  }

  const joke = await db.joke.create({
    data: { ...fields, jokesterId: userId },
  });
  return redirect(`/jokes/${joke.id}`);
};

export default function NewJokeRoute() {
  const actionData = useActionData<typeof action>();

  return (
    <div>
      <p>æ·»åŠ ä½ è‡ªå·±çš„æç¬‘ç¬‘è¯</p>
      <form method="post">
        <div>
          <label>
            åå­—ï¼š{" "}
            <input
              defaultValue={actionData?.fields?.name}
              name="name"
              type="text"
              aria-invalid={Boolean(
                actionData?.fieldErrors?.name
              )}
              aria-errormessage={
                actionData?.fieldErrors?.name
                  ? "name-error"
                  : undefined
              }
            />
          </label>
          {actionData?.fieldErrors?.name ? (
            <p
              className="form-validation-error"
              id="name-error"
              role="alert"
            >
              {actionData.fieldErrors.name}
            </p>
          ) : null}
        </div>
        <div>
          <label>
            å†…å®¹ï¼š{" "}
            <textarea
              defaultValue={actionData?.fields?.content}
              name="content"
              aria-invalid={Boolean(
                actionData?.fieldErrors?.content
              )}
              aria-errormessage={
                actionData?.fieldErrors?.content
                  ? "content-error"
                  : undefined
              }
            />
          </label>
          {actionData?.fieldErrors?.content ? (
            <p
              className="form-validation-error"
              id="content-error"
              role="alert"
            >
              {actionData.fieldErrors.content}
            </p>
          ) : null}
        </div>
        <div>
          {actionData?.formError ? (
            <p
              className="form-validation-error"
              role="alert"
            >
              {actionData.formError}
            </p>
          ) : null}
          <button type="submit" className="button">
            æ·»åŠ 
          </button>
        </div>
      </form>
    </div>
  );
}

export function ErrorBoundary() {
  const error = useRouteError();
  console.error(error);

  if (isRouteErrorResponse(error) && error.status === 401) {
    return (
      <div className="error-container">
        <p>ä½ å¿…é¡»ç™»å½•æ‰èƒ½åˆ›å»ºç¬‘è¯ã€‚</p>
        <Link to="/login">ç™»å½•</Link>
      </div>
    );
  }

  return (
    <div className="error-container">
      å‘ç”Ÿäº†æ„å¤–é”™è¯¯ã€‚å¯¹æ­¤æˆ‘ä»¬æ·±æ„ŸæŠ±æ­‰ã€‚
    </div>
  );
}
```

</details>

![Browser console showing the log of a server-side error][browser-console-showing-the-log-of-a-server-side-error]

### è¡¨å•

Remix æœ‰å…¶è‡ªå·±çš„ [`<Form />`][form-component] ç»„ä»¶ã€‚å½“ JavaScript å°šæœªåŠ è½½æ—¶ï¼Œå®ƒçš„å·¥ä½œæ–¹å¼ä¸å¸¸è§„è¡¨å•ç›¸åŒï¼Œä½†å½“ JavaScript å¯ç”¨æ—¶ï¼Œå®ƒä¼šâ€œæ¸è¿›å¢å¼ºâ€ï¼Œæ”¹ä¸ºå‘å‡º `fetch` è¯·æ±‚ï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦è¿›è¡Œå®Œæ•´é¡µé¢é‡è½½ã€‚

ğŸ’¿ æ‰¾åˆ°æ‰€æœ‰ `<form />` å…ƒç´ å¹¶å°†å…¶æ›´æ”¹ä¸º Remix çš„ `<Form />` ç»„ä»¶ã€‚

<details>

<summary>app/routes/login.tsx</summary>

```tsx filename=app/routes/login.tsx lines=[7,145,247]
import type {
  ActionFunctionArgs,
  LinksFunction,
  MetaFunction,
} from "@remix-run/node";
import {
  Form,
  Link,
  useActionData,
  useSearchParams,
} from "@remix-run/react";

import stylesUrl from "~/styles/login.css";
import { db } from "~/utils/db.server";
import { badRequest } from "~/utils/request.server";
import {
  createUserSession,
  login,
  register,
} from "~/utils/session.server";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

export const meta: MetaFunction = () => {
  const description =
    "ç™»å½•ä»¥æäº¤æ‚¨è‡ªå·±çš„ç¬‘è¯åˆ° Remix Jokesï¼";

  return [
    { name: "description", content: description },
    { name: "twitter:description", content: description },
    { title: "Remix Jokes | ç™»å½•" },
  ];
};

function validateUsername(username: string) {
  if (username.length < 3) {
    return "ç”¨æˆ·åå¿…é¡»è‡³å°‘ 3 ä¸ªå­—ç¬¦é•¿";
  }
}

function validatePassword(password: string) {
  if (password.length < 6) {
    return "å¯†ç å¿…é¡»è‡³å°‘ 6 ä¸ªå­—ç¬¦é•¿";
  }
}

function validateUrl(url: string) {
  const urls = ["/jokes", "/", "https://remix.run"];
  if (urls.includes(url)) {
    return url;
  }
  return "/jokes";
}

export const action = async ({
  request,
}: ActionFunctionArgs) => {
  const form = await request.formData();
  const loginType = form.get("loginType");
  const password = form.get("password");
  const username = form.get("username");
  const redirectTo = validateUrl(
    (form.get("redirectTo") as string) || "/jokes"
  );
  if (
    typeof loginType !== "string" ||
    typeof password !== "string" ||
    typeof username !== "string"
  ) {
    return badRequest({
      fieldErrors: null,
      fields: null,
      formError: "è¡¨å•æœªæ­£ç¡®æäº¤ã€‚",
    });
  }

  const fields = { loginType, password, username };
  const fieldErrors = {
    password: validatePassword(password),
    username: validateUsername(username),
  };
  if (Object.values(fieldErrors).some(Boolean)) {
    return badRequest({
      fieldErrors,
      fields,
      formError: null,
    });
  }

  switch (loginType) {
    case "login": {
      const user = await login({ username, password });
      console.log({ user });
      if (!user) {
        return badRequest({
          fieldErrors: null,
          fields,
          formError:
            "ç”¨æˆ·å/å¯†ç ç»„åˆä¸æ­£ç¡®",
        });
      }
      return createUserSession(user.id, redirectTo);
    }
    case "register": {
      const userExists = await db.user.findFirst({
        where: { username },
      });
      if (userExists) {
        return badRequest({
          fieldErrors: null,
          fields,
          formError: `ç”¨æˆ·åä¸º ${username} çš„ç”¨æˆ·å·²å­˜åœ¨`,
        });
      }
      const user = await register({ username, password });
      if (!user) {
        return badRequest({
          fieldErrors: null,
          fields,
          formError:
            "åˆ›å»ºæ–°ç”¨æˆ·æ—¶å‘ç”Ÿé”™è¯¯ã€‚",
        });
      }
      return createUserSession(user.id, redirectTo);
    }
    default: {
      return badRequest({
        fieldErrors: null,
        fields,
        formError: "ç™»å½•ç±»å‹æ— æ•ˆ",
      });
    }
  }
};

export default function Login() {
  const actionData = useActionData<typeof action>();
  const [searchParams] = useSearchParams();
  return (
    <div className="container">
      <div className="content" data-light="">
        <h1>ç™»å½•</h1>
        <Form method="post">
          <input
            type="hidden"
            name="redirectTo"
            value={
              searchParams.get("redirectTo") ?? undefined
            }
          />
          <fieldset>
            <legend className="sr-only">
              ç™»å½•æˆ–æ³¨å†Œï¼Ÿ
            </legend>
            <label>
              <input
                type="radio"
                name="loginType"
                value="login"
                defaultChecked={
                  !actionData?.fields?.loginType ||
                  actionData?.fields?.loginType === "login"
                }
              />{" "}
              ç™»å½•
            </label>
            <label>
              <input
                type="radio"
                name="loginType"
                value="register"
                defaultChecked={
                  actionData?.fields?.loginType ===
                  "register"
                }
              />{" "}
              æ³¨å†Œ
            </label>
          </fieldset>
          <div>
            <label htmlFor="username-input">ç”¨æˆ·å</label>
            <input
              type="text"
              id="username-input"
              name="username"
              defaultValue={actionData?.fields?.username}
              aria-invalid={Boolean(
                actionData?.fieldErrors?.username
              )}
              aria-errormessage={
                actionData?.fieldErrors?.username
                  ? "username-error"
                  : undefined
              }
            />
            {actionData?.fieldErrors?.username ? (
              <p
                className="form-validation-error"
                role="alert"
                id="username-error"
              >
                {actionData.fieldErrors.username}
              </p>
            ) : null}
          </div>
          <div>
            <label htmlFor="password-input">å¯†ç </label>
            <input
              id="password-input"
              name="password"
              type="password"
              defaultValue={actionData?.fields?.password}
              aria-invalid={Boolean(
                actionData?.fieldErrors?.password
              )}
              aria-errormessage={
                actionData?.fieldErrors?.password
                  ? "password-error"
                  : undefined
              }
            />
            {actionData?.fieldErrors?.password ? (
              <p
                className="form-validation-error"
                role="alert"
                id="password-error"
              >
                {actionData.fieldErrors.password}
              </p>
            ) : null}
          </div>
          <div id="form-error-message">
            {actionData?.formError ? (
              <p
                className="form-validation-error"
                role="alert"
              >
                {actionData.formError}
              </p>
            ) : null}
          </div>
          <button type="submit" className="button">
            æäº¤
          </button>
        </Form>
      </div>
      <div className="links">
        <ul>
          <li>
            <Link to="/">é¦–é¡µ</Link>
          </li>
          <li>
            <Link to="/jokes">ç¬‘è¯</Link>
          </li>
        </ul>
      </div>
    </div>
  );
}
```

</details>

<details>

<summary>app/routes/jokes.tsx</summary>

```tsx filename=app/routes/jokes.tsx lines=[7,54,58]
import type {
  LinksFunction,
  LoaderFunctionArgs,
} from "@remix-run/node";
import { json } from "@remix-run/node";
import {
  Form,
  Link,
  Outlet,
  useLoaderData,
} from "@remix-run/react";

import stylesUrl from "~/styles/jokes.css";
import { db } from "~/utils/db.server";
import { getUser } from "~/utils/session.server";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

export const loader = async ({
  request,
}: LoaderFunctionArgs) => {
  const jokeListItems = await db.joke.findMany({
    orderBy: { createdAt: "desc" },
    select: { id: true, name: true },
    take: 5,
  });
  const user = await getUser(request);

  return json({ jokeListItems, user });
};

export default function JokesRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div className="jokes-layout">
      <header className="jokes-header">
        <div className="container">
          <h1 className="home-link">
            <Link
              to="/"
              title="Remix Jokes"
              aria-label="Remix Jokes"
            >
              <span className="logo">ğŸ¤ª</span>
              <span className="logo-medium">JğŸ¤ªKES</span>
            </Link>
          </h1>
          {data.user ? (
            <div className="user-info">
              <span>{`å—¨ ${data.user.username}`}</span>
              <Form action="/logout" method="post">
                <button type="submit" className="button">
                  ç™»å‡º
                </button>
              </Form>
            </div>
          ) : (
            <Link to="/login">ç™»å½•</Link>
          )}
        </div>
      </header>
      <main className="jokes-main">
        <div className="container">
          <div className="jokes-list">
            <Link to=".">è·å–ä¸€ä¸ªéšæœºç¬‘è¯</Link>
            <p>è¿™é‡Œæœ‰æ›´å¤šç¬‘è¯ä¾›æ‚¨æŸ¥çœ‹ï¼š</p>
            <ul>
              {data.jokeListItems.map(({ id, name }) => (
                <li key={id}>
                  <Link to={id}>{name}</Link>
                </li>
              ))}
            </ul>
            <Link to="new" className="button">
              æ·»åŠ æ‚¨è‡ªå·±çš„
            </Link>
          </div>
          <div className="jokes-outlet">
            <Outlet />
          </div>
        </div>
      </main>
      <footer className="jokes-footer">
        <div className="container">
          <Link reloadDocument to="/jokes.rss">
            RSS
          </Link>
        </div>
      </footer>
    </div>
  );
}
```

</details>

<details>

<summary>app/routes/jokes.$jokeId.tsx</summary>

```tsx filename=app/routes/jokes.$jokeId.tsx lines=[8,97,106]
import type {
  ActionFunctionArgs,
  LoaderFunctionArgs,
  MetaFunction,
} from "@remix-run/node";
import { json, redirect } from "@remix-run/node";
import {
  Form,
  isRouteErrorResponse,
  Link,
  useLoaderData,
  useParams,
  useRouteError,
} from "@remix-run/react";

import { db } from "~/utils/db.server";
import {
  getUserId,
  requireUserId,
} from "~/utils/session.server";

export const meta: MetaFunction<typeof loader> = ({
  data,
}) => {
  const { description, title } = data
    ? {
        description: `äº«å—è¿™ä¸ªåä¸º "${data.joke.name}" çš„ç¬‘è¯ä»¥åŠæ›´å¤šå†…å®¹`,
        title: `"${data.joke.name}" ç¬‘è¯`,
      }
    : { description: "æœªæ‰¾åˆ°ç¬‘è¯", title: "æ²¡æœ‰ç¬‘è¯" };

  return [
    { name: "description", content: description },
    { name: "twitter:description", content: description },
    { title },
  ];
};

export const loader = async ({
  params,
  request,
}: LoaderFunctionArgs) => {
  const userId = await getUserId(request);
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Response("çœŸæ˜¯ä¸ªç¬‘è¯ï¼æœªæ‰¾åˆ°ã€‚", {
      status: 404,
    });
  }
  return json({
    isOwner: userId === joke.jokesterId,
    joke,
  });
};

export const action = async ({
  params,
  request,
}: ActionFunctionArgs) => {
  const form = await request.formData();
  if (form.get("intent") !== "delete") {
    throw new Response(
      `æ„å›¾ ${form.get("intent")} ä¸è¢«æ”¯æŒ`,
      { status: 400 }
    );
  }
  const userId = await requireUserId(request);
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Response("æ— æ³•åˆ é™¤ä¸å­˜åœ¨çš„å†…å®¹", {
      status: 404,
    });
  }
  if (joke.jokesterId !== userId) {
    throw new Response(
      "å“å‘€ï¼ŒçœŸä¸é”™çš„å°è¯•ã€‚è¿™ä¸æ˜¯ä½ çš„ç¬‘è¯",
      { status: 403 }
    );
  }
  await db.joke.delete({ where: { id: params.jokeId } });
  return redirect("/jokes");
};

export default function JokeRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div>
      <p>è¿™æ˜¯ä½ çš„æç¬‘ç¬‘è¯ï¼š</p>
      <p>{data.joke.content}</p>
      <Link to=".">"{data.joke.name}" æ°¸ä¹…é“¾æ¥</Link>
      {data.isOwner ? (
        <Form method="post">
          <button
            className="button"
            name="intent"
            type="submit"
            value="delete"
          >
            åˆ é™¤
          </button>
        </Form>
      ) : null}
    </div>
  );
}

export function ErrorBoundary() {
  const { jokeId } = useParams();
  const error = useRouteError();
  console.error(error);

  if (isRouteErrorResponse(error)) {
    if (error.status === 400) {
      return (
        <div className="error-container">
          ä½ å°è¯•åšçš„äº‹æƒ…æ˜¯ä¸å…è®¸çš„ã€‚
        </div>
      );
    }
    if (error.status === 403) {
      return (
        <div className="error-container">
          æŠ±æ­‰ï¼Œ"{jokeId}" ä¸æ˜¯ä½ çš„ç¬‘è¯ã€‚
        </div>
      );
    }
    if (error.status === 404) {
      return (
        <div className="error-container">
          å—¯ï¼Ÿ"{jokeId}" æ˜¯ä»€ä¹ˆï¼Ÿ
        </div>
      );
    }
  }

  return (
    <div className="error-container">
      åŠ è½½ ID ä¸º "${jokeId}" çš„ç¬‘è¯æ—¶å‡ºé”™ã€‚
      æŠ±æ­‰ã€‚
    </div>
  );
}
```

```tsx filename=app/routes/jokes.new.tsx lines=[7,86,153]
import type {
  ActionFunctionArgs,
  LoaderFunctionArgs,
} from "@remix-run/node";
import { json, redirect } from "@remix-run/node";
import {
  Form,
  isRouteErrorResponse,
  Link,
  useActionData,
  useRouteError,
} from "@remix-run/react";

import { db } from "~/utils/db.server";
import { badRequest } from "~/utils/request.server";
import {
  getUserId,
  requireUserId,
} from "~/utils/session.server";

export const loader = async ({
  request,
}: LoaderFunctionArgs) => {
  const userId = await getUserId(request);
  if (!userId) {
    throw new Response("æœªç»æˆæƒ", { status: 401 });
  }
  return json({});
};

function validateJokeContent(content: string) {
  if (content.length < 10) {
    return "è¿™ä¸ªç¬‘è¯å¤ªçŸ­äº†";
  }
}

function validateJokeName(name: string) {
  if (name.length < 3) {
    return "è¿™ä¸ªç¬‘è¯çš„åç§°å¤ªçŸ­äº†";
  }
}

export const action = async ({
  request,
}: ActionFunctionArgs) => {
  const userId = await requireUserId(request);
  const form = await request.formData();
  const content = form.get("content");
  const name = form.get("name");
  if (
    typeof content !== "string" ||
    typeof name !== "string"
  ) {
    return badRequest({
      fieldErrors: null,
      fields: null,
      formError: "è¡¨å•æœªæ­£ç¡®æäº¤ã€‚",
    });
  }

  const fieldErrors = {
    content: validateJokeContent(content),
    name: validateJokeName(name),
  };
  const fields = { content, name };
  if (Object.values(fieldErrors).some(Boolean)) {
    return badRequest({
      fieldErrors,
      fields,
      formError: null,
    });
  }

  const joke = await db.joke.create({
    data: { ...fields, jokesterId: userId },
  });
  return redirect(`/jokes/${joke.id}`);
};

export default function NewJokeRoute() {
  const actionData = useActionData<typeof action>();

  return (
    <div>
      <p>æ·»åŠ ä½ è‡ªå·±çš„æç¬‘ç¬‘è¯</p>
      <Form method="post">
        <div>
          <label>
            åç§°ï¼š{" "}
            <input
              defaultValue={actionData?.fields?.name}
              name="name"
              type="text"
              aria-invalid={Boolean(
                actionData?.fieldErrors?.name
              )}
              aria-errormessage={
                actionData?.fieldErrors?.name
                  ? "name-error"
                  : undefined
              }
            />
          </label>
          {actionData?.fieldErrors?.name ? (
            <p
              className="form-validation-error"
              id="name-error"
              role="alert"
            >
              {actionData.fieldErrors.name}
            </p>
          ) : null}
        </div>
        <div>
          <label>
            å†…å®¹ï¼š{" "}
            <textarea
              defaultValue={actionData?.fields?.content}
              name="content"
              aria-invalid={Boolean(
                actionData?.fieldErrors?.content
              )}
              aria-errormessage={
                actionData?.fieldErrors?.content
                  ? "content-error"
                  : undefined
              }
            />
          </label>
          {actionData?.fieldErrors?.content ? (
            <p
              className="form-validation-error"
              id="content-error"
              role="alert"
            >
              {actionData.fieldErrors.content}
            </p>
          ) : null}
        </div>
        <div>
          {actionData?.formError ? (
            <p
              className="form-validation-error"
              role="alert"
            >
              {actionData.formError}
            </p>
          ) : null}
          <button type="submit" className="button">
            æ·»åŠ 
          </button>
        </div>
      </Form>
    </div>
  );
}

export function ErrorBoundary() {
  const error = useRouteError();
  console.error(error);

  if (isRouteErrorResponse(error) && error.status === 401) {
    return (
      <div className="error-container">
        <p>ä½ å¿…é¡»ç™»å½•æ‰èƒ½åˆ›å»ºç¬‘è¯ã€‚</p>
        <Link to="/login">ç™»å½•</Link>
      </div>
    );
  }

  return (
    <div className="error-container">
      å‡ºç°æ„å¤–é”™è¯¯ã€‚å¯¹æ­¤æ„Ÿåˆ°æŠ±æ­‰ã€‚
    </div>
  );
}
```

### é¢„å–

å¦‚æœç”¨æˆ·èšç„¦æˆ–é¼ æ ‡æ‚¬åœåœ¨é“¾æ¥ä¸Šï¼Œä»–ä»¬å¾ˆå¯èƒ½æƒ³è¦è®¿é—®è¯¥é“¾æ¥ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é¢„å–ä»–ä»¬å³å°†è®¿é—®çš„é¡µé¢ã€‚è¦ä¸ºç‰¹å®šé“¾æ¥å¯ç”¨æ­¤åŠŸèƒ½ï¼Œåªéœ€è¿™æ ·åšï¼š

```
<Link prefetch="intent" to="somewhere/neat">Somewhere Neat</Link>
```

ğŸ’¿ åœ¨ `app/routes/jokes.tsx` ä¸­çš„ç¬‘è¯é“¾æ¥åˆ—è¡¨ä¸­æ·»åŠ  `prefetch="intent"`ã€‚
</details>
<details>

<summary>app/routes/jokes.tsx</summary>

```tsx filename=app/routes/jokes.tsx lines=[73]
import type {
  LinksFunction,
  LoaderFunctionArgs,
} from "@remix-run/node";
import { json } from "@remix-run/node";
import {
  Form,
  Link,
  Outlet,
  useLoaderData,
} from "@remix-run/react";

import stylesUrl from "~/styles/jokes.css";
import { db } from "~/utils/db.server";
import { getUser } from "~/utils/session.server";

export const links: LinksFunction = () => [
  { rel: "stylesheet", href: stylesUrl },
];

export const loader = async ({
  request,
}: LoaderFunctionArgs) => {
  const jokeListItems = await db.joke.findMany({
    orderBy: { createdAt: "desc" },
    select: { id: true, name: true },
    take: 5,
  });
  const user = await getUser(request);

  return json({ jokeListItems, user });
};

export default function JokesRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <div className="jokes-layout">
      <header className="jokes-header">
        <div className="container">
          <h1 className="home-link">
            <Link
              to="/"
              title="Remix Jokes"
              aria-label="Remix Jokes"
            >
              <span className="logo">ğŸ¤ª</span>
              <span className="logo-medium">JğŸ¤ªKES</span>
            </Link>
          </h1>
          {data.user ? (
            <div className="user-info">
              <span>{`Hi ${data.user.username}`}</span>
              <Form action="/logout" method="post">
                <button type="submit" className="button">
                  Logout
                </button>
              </Form>
            </div>
          ) : (
            <Link to="/login">Login</Link>
          )}
        </div>
      </header>
      <main className="jokes-main">
        <div className="container">
          <div className="jokes-list">
            <Link to=".">è·å–ä¸€ä¸ªéšæœºç¬‘è¯</Link>
            <p>è¿™é‡Œè¿˜æœ‰ä¸€äº›ç¬‘è¯å¯ä»¥æŸ¥çœ‹ï¼š</p>
            <ul>
              {data.jokeListItems.map(({ id, name }) => (
                <li key={id}>
                  <Link prefetch="intent" to={id}>
                    {name}
                  </Link>
                </li>
              ))}
            </ul>
            <Link to="new" className="button">
              æ·»åŠ ä½ è‡ªå·±çš„
            </Link>
          </div>
          <div className="jokes-outlet">
            <Outlet />
          </div>
        </div>
      </main>
      <footer className="jokes-footer">
        <div className="container">
          <Link reloadDocument to="/jokes.rss">
            RSS
          </Link>
        </div>
      </footer>
    </div>
  );
}
```

</details>

## ä¹è§‚ UI

ç°åœ¨æˆ‘ä»¬åœ¨é¡µé¢ä¸Šä½¿ç”¨äº† JavaScriptï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ _æ¸è¿›å¢å¼º_ å¹¶é€šè¿‡ä¸ºæˆ‘ä»¬çš„åº”ç”¨æ·»åŠ ä¸€äº› _ä¹è§‚ UI_ æ¥ä½¿æˆ‘ä»¬çš„ç½‘ç«™ _æ›´å¥½_ã€‚

å°½ç®¡æˆ‘ä»¬çš„åº”ç”¨ç›¸å½“å¿«é€Ÿï¼ˆå°¤å…¶æ˜¯åœ¨æœ¬åœ° ğŸ˜…ï¼‰ï¼Œä½†ä¸€äº›ç”¨æˆ·å¯èƒ½ä¸æˆ‘ä»¬çš„åº”ç”¨è¿æ¥ä¸ä½³ã€‚è¿™æ„å‘³ç€ä»–ä»¬å°†æäº¤ä»–ä»¬çš„ç¬‘è¯ï¼Œä½†åœ¨çœ‹åˆ°ä»»ä½•å†…å®¹ä¹‹å‰ï¼Œä»–ä»¬éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æŸä¸ªåœ°æ–¹æ·»åŠ ä¸€ä¸ªåŠ è½½æ—‹è½¬å™¨ï¼Œä½†ä¹è§‚åœ°å¯¹è¯·æ±‚çš„æˆåŠŸè¿›è¡Œé¢„æœŸå¹¶æ¸²æŸ“ç”¨æˆ·å°†çœ‹åˆ°çš„å†…å®¹ä¼šæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

æˆ‘ä»¬æœ‰ä¸€ä»½ç›¸å½“æ·±å…¥çš„ [ä¹è§‚ UI æŒ‡å—][guide-on-optimistic-ui]ï¼Œå¯ä»¥å»çœ‹çœ‹ã€‚

ğŸ’¿ å°†ä¹è§‚ UI æ·»åŠ åˆ° `app/routes/jokes.new.tsx` è·¯ç”±ä¸­ã€‚

æ³¨æ„ï¼Œä½ å¯èƒ½æƒ³åœ¨ `app/components/` ä¸­åˆ›å»ºä¸€ä¸ªåä¸º `joke.tsx` çš„æ–°æ–‡ä»¶ï¼Œä»¥ä¾¿åœ¨ `app/routes/jokes.$jokeId.tsx` å’Œ `app/routes/jokes.new.tsx` ä¸­é‡ç”¨è¯¥ UIã€‚

<details>

<summary>app/components/joke.tsx</summary>

```tsx filename=app/components/joke.tsx lines=[5,9,16-18,22]
import type { Joke } from "@prisma/client";
import { Form, Link } from "@remix-run/react";

export function JokeDisplay({
  canDelete = true,
  isOwner,
  joke,
}: {
  canDelete?: boolean;
  isOwner: boolean;
  joke: Pick<Joke, "content" | "name">;
}) {
  return (
    <div>
      <p>è¿™æ˜¯ä½ çš„æç¬‘ç¬‘è¯ï¼š</p>
      <p>{joke.content}</p>
      <Link to=".">"{joke.name}" çš„æ°¸ä¹…é“¾æ¥</Link>
      {isOwner ? (
        <Form method="post">
          <button
            className="button"
            disabled={!canDelete}
            name="intent"
            type="submit"
            value="delete"
          >
            åˆ é™¤
          </button>
        </Form>
      ) : null}
    </div>
  );
}
```

</details>

<details>

<summary>app/routes/jokes.$jokeId.tsx</summary>

```tsx filename=app/routes/jokes.$jokeId.tsx lines=[14,91]
import type {
  ActionFunctionArgs,
  LoaderFunctionArgs,
  MetaFunction,
} from "@remix-run/node";
import { json, redirect } from "@remix-run/node";
import {
  isRouteErrorResponse,
  useLoaderData,
  useParams,
  useRouteError,
} from "@remix-run/react";

import { JokeDisplay } from "~/components/joke";
import { db } from "~/utils/db.server";
import {
  getUserId,
  requireUserId,
} from "~/utils/session.server";

export const meta: MetaFunction<typeof loader> = ({
  data,
}) => {
  const { description, title } = data
    ? {
        description: `äº«å— "${data.joke.name}" ç¬‘è¯ä»¥åŠæ›´å¤šå†…å®¹`,
        title: `"${data.joke.name}" ç¬‘è¯`,
      }
    : { description: "æœªæ‰¾åˆ°ç¬‘è¯", title: "æ²¡æœ‰ç¬‘è¯" };

  return [
    { name: "description", content: description },
    { name: "twitter:description", content: description },
    { title },
  ];
};

export const loader = async ({
  params,
  request,
}: LoaderFunctionArgs) => {
  const userId = await getUserId(request);
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Response("ä»€ä¹ˆç¬‘è¯ï¼æœªæ‰¾åˆ°ã€‚", {
      status: 404,
    });
  }
  return json({
    isOwner: userId === joke.jokesterId,
    joke,
  });
};

export const action = async ({
  params,
  request,
}: ActionFunctionArgs) => {
  const form = await request.formData();
  if (form.get("intent") !== "delete") {
    throw new Response(
      `æ„å›¾ ${form.get("intent")} ä¸è¢«æ”¯æŒ`,
      { status: 400 }
    );
  }
  const userId = await requireUserId(request);
  const joke = await db.joke.findUnique({
    where: { id: params.jokeId },
  });
  if (!joke) {
    throw new Response("æ— æ³•åˆ é™¤ä¸å­˜åœ¨çš„å†…å®¹", {
      status: 404,
    });
  }
  if (joke.jokesterId !== userId) {
    throw new Response(
      "å˜˜ï¼Œè¯•å¾—ä¸é”™ã€‚ä½†é‚£ä¸æ˜¯ä½ çš„ç¬‘è¯",
      { status: 403 }
    );
  }
  await db.joke.delete({ where: { id: params.jokeId } });
  return redirect("/jokes");
};

export default function JokeRoute() {
  const data = useLoaderData<typeof loader>();

  return (
    <JokeDisplay isOwner={data.isOwner} joke={data.joke} />
  );
}

export function ErrorBoundary() {
  const { jokeId } = useParams();
  const error = useRouteError();
  console.error(error);

  if (isRouteErrorResponse(error)) {
    if (error.status === 400) {
      return (
        <div className="error-container">
          ä½ æ‰€å°è¯•çš„æ“ä½œæ˜¯ä¸å…è®¸çš„ã€‚
        </div>
      );
    }
    if (error.status === 403) {
      return (
        <div className="error-container">
          å¯¹ä¸èµ·ï¼Œ"{jokeId}" ä¸æ˜¯ä½ çš„ç¬‘è¯ã€‚
        </div>
      );
    }
    if (error.status === 404) {
      return (
        <div className="error-container">
          å—¯ï¼Ÿ"{jokeId}" åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ
        </div>
      );
    }
  }

  return (
    <div className="error-container">
      åŠ è½½ ID ä¸º "${jokeId}" çš„ç¬‘è¯æ—¶å‡ºé”™ã€‚
      å¯¹ä¸èµ·ã€‚
    </div>
  );
}
```

</details>

<details>

<summary>app/routes/jokes.new.tsx</summary>

```tsx filename=app/routes/jokes.new.tsx lines=[11,15,84,86-103]
import type {
  ActionFunctionArgs,
  LoaderFunctionArgs,
} from "@remix-run/node";
import { json, redirect } from "@remix-run/node";
import {
  Form,
  isRouteErrorResponse,
  Link,
  useActionData,
  useNavigation,
  useRouteError,
} from "@remix-run/react";

import { JokeDisplay } from "~/components/joke";
import { db } from "~/utils/db.server";
import { badRequest } from "~/utils/request.server";
import {
  getUserId,
  requireUserId,
} from "~/utils/session.server";

export const loader = async ({
  request,
}: LoaderFunctionArgs) => {
  const userId = await getUserId(request);
  if (!userId) {
    throw new Response("æœªç»æˆæƒ", { status: 401 });
  }
  return json({});
};

function validateJokeContent(content: string) {
  if (content.length < 10) {
    return "è¿™ä¸ªç¬‘è¯å¤ªçŸ­äº†";
  }
}

function validateJokeName(name: string) {
  if (name.length < 3) {
    return "è¿™ä¸ªç¬‘è¯çš„åç§°å¤ªçŸ­äº†";
  }
}

export const action = async ({
  request,
}: ActionFunctionArgs) => {
  const userId = await requireUserId(request);
  const form = await request.formData();
  const content = form.get("content");
  const name = form.get("name");
  if (
    typeof content !== "string" ||
    typeof name !== "string"
  ) {
    return badRequest({
      fieldErrors: null,
      fields: null,
      formError: "è¡¨å•æœªæ­£ç¡®æäº¤ã€‚",
    });
  }

  const fieldErrors = {
    content: validateJokeContent(content),
    name: validateJokeName(name),
  };
  const fields = { content, name };
  if (Object.values(fieldErrors).some(Boolean)) {
    return badRequest({
      fieldErrors,
      fields,
      formError: null,
    });
  }

  const joke = await db.joke.create({
    data: { ...fields, jokesterId: userId },
  });
  return redirect(`/jokes/${joke.id}`);
};

export default function NewJokeRoute() {
  const actionData = useActionData<typeof action>();
  const navigation = useNavigation();

  if (navigation.formData) {
    const content = navigation.formData.get("content");
    const name = navigation.formData.get("name");
    if (
      typeof content === "string" &&
      typeof name === "string" &&
      !validateJokeContent(content) &&
      !validateJokeName(name)
    ) {
      return (
        <JokeDisplay
          canDelete={false}
          isOwner={true}
          joke={{ name, content }}
        />
      );
    }
  }

  return (
    <div>
      <p>æ·»åŠ ä½ è‡ªå·±çš„æç¬‘ç¬‘è¯</p>
      <Form method="post">
        <div>
          <label>
            åç§°ï¼š{" "}
            <input
              defaultValue={actionData?.fields?.name}
              name="name"
              type="text"
              aria-invalid={Boolean(
                actionData?.fieldErrors?.name
              )}
              aria-errormessage={
                actionData?.fieldErrors?.name
                  ? "name-error"
                  : undefined
              }
            />
          </label>
          {actionData?.fieldErrors?.name ? (
            <p
              className="form-validation-error"
              id="name-error"
              role="alert"
            >
              {actionData.fieldErrors.name}
            </p>
          ) : null}
        </div>
        <div>
          <label>
            å†…å®¹ï¼š{" "}
            <textarea
              defaultValue={actionData?.fields?.content}
              name="content"
              aria-invalid={Boolean(
                actionData?.fieldErrors?.content
              )}
              aria-errormessage={
                actionData?.fieldErrors?.content
                  ? "content-error"
                  : undefined
              }
            />
          </label>
          {actionData?.fieldErrors?.content ? (
            <p
              className="form-validation-error"
              id="content-error"
              role="alert"
            >
              {actionData.fieldErrors.content}
            </p>
          ) : null}
        </div>
        <div>
          {actionData?.formError ? (
            <p
              className="form-validation-error"
              role="alert"
            >
              {actionData.formError}
            </p>
          ) : null}
          <button type="submit" className="button">
            æ·»åŠ 
          </button>
        </div>
      </Form>
    </div>
  );
}

export function ErrorBoundary() {
  const error = useRouteError();
  console.error(error);

  if (isRouteErrorResponse(error) && error.status === 401) {
    return (
      <div className="error-container">
        <p>ä½ å¿…é¡»ç™»å½•æ‰èƒ½åˆ›å»ºç¬‘è¯ã€‚</p>
        <Link to="/login">ç™»å½•</Link>
      </div>
    );
  }

  return (
    <div className="error-container">
      å‡ºç°æ„å¤–é”™è¯¯ã€‚å¯¹æ­¤æˆ‘ä»¬æ„Ÿåˆ°æŠ±æ­‰ã€‚
    </div>
  );
}
```

</details>

æˆ‘å–œæ¬¢æˆ‘çš„ä¾‹å­çš„ä¸€ç‚¹æ˜¯ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ä¸æœåŠ¡å™¨ä½¿ç”¨çš„ _å®Œå…¨ç›¸åŒ_ çš„éªŒè¯å‡½æ•°ï¼å› æ­¤ï¼Œå¦‚æœä»–ä»¬æäº¤çš„å†…å®¹å°†å¤±è´¥æœåŠ¡å™¨ç«¯éªŒè¯ï¼Œæˆ‘ä»¬ç”šè‡³ä¸éœ€è¦æ¸²æŸ“ä¹è§‚ UIï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“å®ƒä¼šå¤±è´¥ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ç§å£°æ˜å¼ä¹è§‚ UI æ–¹æ³•éå¸¸æ£’ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¿…æ‹…å¿ƒé”™è¯¯æ¢å¤ã€‚å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œæˆ‘ä»¬çš„ç»„ä»¶å°†é‡æ–°æ¸²æŸ“ï¼Œå®ƒå°†ä¸å†æ˜¯æäº¤ï¼Œä¸€åˆ‡å°†åƒä¹‹å‰ä¸€æ ·æ­£å¸¸å·¥ä½œã€‚å¤ªå¥½äº†ï¼

ä»¥ä¸‹æ˜¯è¯¥ä½“éªŒçš„æ¼”ç¤ºï¼š 

<video src="/jokes-tutorial/img/optimistic-ui.mp4" controls muted loop autoplay></video>

## éƒ¨ç½²

æˆ‘å¯¹æˆ‘ä»¬åœ¨è¿™é‡Œåˆ›å»ºçš„ç”¨æˆ·ä½“éªŒæ„Ÿåˆ°éå¸¸æ»¡æ„ã€‚é‚£ä¹ˆè®©æˆ‘ä»¬å¼€å§‹éƒ¨ç½²å§ï¼ä½¿ç”¨ Remixï¼Œæ‚¨æœ‰å¾ˆå¤šéƒ¨ç½²é€‰é¡¹ã€‚å½“æ‚¨åœ¨æœ¬æ•™ç¨‹å¼€å§‹æ—¶è¿è¡Œ `npx create-remix@latest` æ—¶ï¼Œä¼šç»™æ‚¨å‡ ä¸ªé€‰é¡¹ã€‚ç”±äºæˆ‘ä»¬æ„å»ºçš„æ•™ç¨‹ä¾èµ–äº Node.js (`prisma`)ï¼Œæˆ‘ä»¬å°†éƒ¨ç½²åˆ°æˆ‘ä»¬æœ€å–œæ¬¢çš„æ‰˜ç®¡æä¾›å•†ä¹‹ä¸€ï¼š[Fly.io][fly-io]ã€‚

ğŸ’¿ åœ¨ç»§ç»­ä¹‹å‰ï¼Œæ‚¨éœ€è¦ [å®‰è£… fly][install-fly] å¹¶ [æ³¨å†Œä¸€ä¸ªå¸æˆ·][sign-up-for-an-account]ã€‚

<docs-info>Fly.io åœ¨åˆ›å»ºå¸æˆ·æ—¶ä¼šè¯¢é—®æ‚¨çš„ä¿¡ç”¨å¡å·ç ï¼ˆè¯·å‚è§ [ä»–ä»¬çš„åšå®¢æ–‡ç« ][their-blog-article] äº†è§£åŸå› ï¼‰ï¼Œä½†æœ‰å…è´¹çš„å¥—é¤å¯ä»¥æ»¡è¶³ä½œä¸ºç®€å•ä¾§é¡¹ç›®æ‰˜ç®¡çš„æ­¤åº”ç”¨çš„éœ€æ±‚ã€‚</docs-info>

ğŸ’¿ å®Œæˆåï¼Œä»æ‚¨çš„é¡¹ç›®ç›®å½•ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```shellscript nonumber
fly launch
```

Fly çš„å›¢é˜Ÿéå¸¸å‹å¥½ï¼Œæä¾›äº†å¾ˆæ£’çš„è®¾ç½®ä½“éªŒã€‚ä»–ä»¬ä¼šæ£€æµ‹åˆ°æ‚¨çš„ Remix é¡¹ç›®ï¼Œå¹¶é—®æ‚¨å‡ ä¸ªé—®é¢˜ä»¥å¸®åŠ©æ‚¨å¼€å§‹ã€‚ä»¥ä¸‹æ˜¯æˆ‘çš„è¾“å‡º/é€‰æ‹©ï¼š

```
Creating app in /Users/kentcdodds/Desktop/remix-jokes
Scanning source code
Detected a Remix app
? Choose an app name (leave blank to generate one): remix-jokes
automatically selected personal organization: Kent C. Dodds
Some regions require a paid plan (fra, maa).
See https://fly.io/plans to set up a plan.

? Choose a region for deployment: Dallas, Texas (US) (dfw)
Created app 'remix-jokes' in organization 'personal'
Admin URL: https://fly.io/apps/remix-jokes
Hostname: remix-jokes.fly.dev
Created a 1GB volume vol_18l524yj27947zmp in the dfw region
Wrote config file fly.toml

This launch configuration uses SQLite on a single, dedicated volume. It will not scale beyond a single VM. Look into 'fly postgres' for a more robust production database.

? Would you like to deploy now? No
Your app is ready! Deploy with `flyctl deploy`
```

æ‚¨éœ€è¦é€‰æ‹©ä¸€ä¸ªä¸åŒçš„åº”ç”¨åç§°ï¼Œå› ä¸ºæˆ‘å·²ç»ä½¿ç”¨äº† `remix-jokes`ï¼ˆæŠ±æ­‰ ğŸ™ƒï¼‰ã€‚

å®ƒè¿˜å…è®¸æ‚¨é€‰æ‹©ä¸€ä¸ªåŒºåŸŸï¼Œæˆ‘å»ºè®®é€‰æ‹©ä¸€ä¸ªç¦»æ‚¨è¾ƒè¿‘çš„åŒºåŸŸã€‚å¦‚æœæ‚¨å†³å®šå°†æ¥åœ¨ Fly ä¸Šéƒ¨ç½²ä¸€ä¸ªçœŸå®çš„åº”ç”¨ï¼Œæ‚¨å¯èƒ½ä¼šé€‰æ‹©å°† Fly æ‰©å±•åˆ°å¤šä¸ªåŒºåŸŸã€‚

Fly è¿˜æ£€æµ‹åˆ°è¯¥é¡¹ç›®æ­£åœ¨ä½¿ç”¨ SQLite å’Œ Prismaï¼Œå¹¶ä¸ºæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæŒä¹…æ€§å·ã€‚

æˆ‘ä»¬ç°åœ¨ä¸æƒ³éƒ¨ç½²ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼æ‰€ä»¥é€‰æ‹©â€œå¦â€ã€‚

Fly ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†ä¸€äº›æ–‡ä»¶ï¼š

- `fly.toml` - Fly ç‰¹å®šé…ç½®
- `Dockerfile` - è¯¥åº”ç”¨çš„ Remix ç‰¹å®š Dockerfile
- `.dockerignore` - å®ƒåªä¼šå¿½ç•¥ `node_modules`ï¼Œå› ä¸ºæˆ‘ä»¬å°†åœ¨æ„å»ºé•œåƒæ—¶è¿è¡Œå®‰è£…ã€‚

ğŸ’¿ ç°åœ¨é€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤è®¾ç½® `SESSION_SECRET` ç¯å¢ƒå˜é‡ï¼š

```shellscript nonumber
fly secrets set SESSION_SECRET=your-secret-here
```

`your-secret-here` å¯ä»¥æ˜¯æ‚¨æƒ³è¦çš„ä»»ä½•å†…å®¹ã€‚å®ƒåªæ˜¯ä¸€ä¸ªç”¨äºç­¾ç½²ä¼šè¯ cookie çš„å­—ç¬¦ä¸²ã€‚å¦‚æœæ‚¨æ„¿æ„ï¼Œå¯ä»¥ä½¿ç”¨å¯†ç ç”Ÿæˆå™¨ã€‚

æˆ‘ä»¬è¿˜éœ€è¦åšçš„å¦ä¸€ä»¶äº‹æ˜¯å‡†å¤‡ Prisma ä»¥é¦–æ¬¡è®¾ç½®æˆ‘ä»¬çš„æ•°æ®åº“ã€‚ç°åœ¨æˆ‘ä»¬å¯¹æˆ‘ä»¬çš„æ¨¡å¼æ„Ÿåˆ°æ»¡æ„ï¼Œå¯ä»¥åˆ›å»ºæˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡è¿ç§»ã€‚

ğŸ’¿ è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```shellscript nonumber
npx prisma migrate dev
```

è¿™å°†åœ¨ `migrations` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªè¿ç§»æ–‡ä»¶ã€‚å½“å®ƒå°è¯•è¿è¡Œç§å­æ–‡ä»¶æ—¶ï¼Œæ‚¨å¯èƒ½ä¼šæ”¶åˆ°é”™è¯¯ã€‚æ‚¨å¯ä»¥å®‰å…¨åœ°å¿½ç•¥å®ƒã€‚å®ƒä¼šè¯¢é—®æ‚¨å¸Œæœ›å°†è¿ç§»å‘½åä¸ºä»€ä¹ˆï¼š

```
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": SQLite database "dev.db" at "file:./dev.db"

SQLite database dev.db created at file:./dev.db

âœ” Enter a name for the new migration: â€¦ init
```

ğŸ’¿ æˆ‘å°†æˆ‘çš„å‘½åä¸ºâ€œinitâ€ã€‚ç„¶åæ‚¨å°†è·å¾—å…¶ä½™çš„è¾“å‡ºï¼š

```
Applying migration `20211121111251_init`

The following migration(s) have been created and applied from new schema changes:

migrations/
  â””â”€ 20211121111251_init/
    â””â”€ migration.sql

Your database is now in sync with your schema.

âœ” Generated Prisma Client (4.12.0 | library) to ./node_modules/@prisma/client in 52ms


Running seed command `ts-node --require tsconfig-paths/register prisma/seed.ts` ...

ğŸŒ±  The seed command has been executed.
```

ğŸ’¿ å¦‚æœæ‚¨åœ¨è¿è¡Œç§å­æ—¶ç¡®å®é‡åˆ°äº†é”™è¯¯ï¼Œæ‚¨ç°åœ¨å¯ä»¥æ‰‹åŠ¨è¿è¡Œå®ƒï¼š

```shellscript nonumber
npx prisma db seed
```

å®Œæˆåï¼Œæ‚¨å°±å‡†å¤‡å¥½éƒ¨ç½²äº†ã€‚

ğŸ’¿ è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```shellscript nonumber
fly deploy
```

è¿™å°†æ„å»º Docker é•œåƒå¹¶åœ¨æ‚¨é€‰æ‹©çš„åŒºåŸŸå°†å…¶éƒ¨ç½²åˆ° Flyã€‚å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´ã€‚åœ¨ç­‰å¾…æœŸé—´ï¼Œæ‚¨å¯ä»¥æƒ³æƒ³æŸä¸ªæ‚¨å¾ˆä¹…æ²¡è”ç³»çš„äººï¼Œç»™ä»–ä»¬å‘ä¸ªæ¶ˆæ¯ï¼Œå‘Šè¯‰ä»–ä»¬æ‚¨ä¸ºä»€ä¹ˆæ¬£èµä»–ä»¬ã€‚

å¤ªå¥½äº†ï¼æˆ‘ä»¬å®Œæˆäº†ï¼Œæ‚¨è®©æŸäººçš„ä¸€å¤©å˜å¾—æ›´ç¾å¥½ï¼æˆåŠŸï¼

æ‚¨çš„åº”ç”¨ç°åœ¨å¯ä»¥åœ¨ `https://<your-app-name>.fly.dev` ä¸Šè®¿é—®ï¼æ‚¨ä¹Ÿå¯ä»¥åœ¨æ‚¨çš„ Fly å¸æˆ·åœ¨çº¿æ‰¾åˆ°è¯¥ URLï¼š[fly.io/apps][fly-io-apps]ã€‚

æ¯æ¬¡æ‚¨è¿›è¡Œæ›´æ”¹æ—¶ï¼Œåªéœ€å†æ¬¡è¿è¡Œ `fly deploy` è¿›è¡Œé‡æ–°éƒ¨ç½²ã€‚

## ç»“è®º

å‘¼ï¼æˆ‘ä»¬åˆ°æ­¤ä¸ºæ­¢ã€‚å¦‚æœä½ èƒ½å®Œæˆæ•´ä¸ªè¿‡ç¨‹ï¼Œæˆ‘çœŸçš„å¾ˆä½©æœä½ ï¼ˆ[åˆ†äº«ä½ çš„æˆåŠŸ][tweet-your-success]ï¼‰ï¼Remix æœ‰å¾ˆå¤šå†…å®¹ï¼Œè€Œæˆ‘ä»¬åªæ˜¯è®©ä½ å…¥é—¨ã€‚ç¥ä½ åœ¨æ¥ä¸‹æ¥çš„ Remix æ—…ç¨‹ä¸­å¥½è¿ï¼