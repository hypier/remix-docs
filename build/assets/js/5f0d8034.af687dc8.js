"use strict";(self.webpackChunkremix_docs=self.webpackChunkremix_docs||[]).push([[9755],{5362:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>d,metadata:()=>l,toc:()=>i});var t=r(4848),a=r(8453);const d={title:"\u6587\u4ef6\u4e0a\u4f20"},o=void 0,l={id:"guides/file-uploads",title:"\u6587\u4ef6\u4e0a\u4f20",description:"\u6b64\u6587\u6863\u6b63\u5728\u8fdb\u884c\u4e2d\uff1a\u5b83\u662f\u4ece\u6587\u4ef6\u4e0a\u4f20\u7684API\u6587\u6863\u4e2d\u63d0\u53d6\u7684\uff0c\u56e0\u6b64\u6709\u4e9b\u4e0d\u592a\u76f8\u5173\u3002\u6211\u4eec\u6253\u7b97\u5c06\u5176\u91cd\u5199\u4e3a\u6587\u4ef6\u4e0a\u4f20\u7684\u4e00\u822c\u6307\u5357\u3002",source:"@site/docs/guides/file-uploads.md",sourceDirName:"guides",slug:"/guides/file-uploads",permalink:"/docs/guides/file-uploads",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/guides/file-uploads.md",tags:[],version:"current",frontMatter:{title:"\u6587\u4ef6\u4e0a\u4f20"},sidebar:"tutorialSidebar",previous:{title:"\u5e38\u89c1\u95ee\u9898",permalink:"/docs/guides/faq"},next:{title:"\u8868\u5355\u9a8c\u8bc1",permalink:"/docs/guides/form-validation"}},s={},i=[{value:"\u4e0a\u4f20\u5904\u7406\u7a0b\u5e8f\u7ec4\u5408",id:"\u4e0a\u4f20\u5904\u7406\u7a0b\u5e8f\u7ec4\u5408",level:3}];function c(e){const n={code:"code",h3:"h3",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("docs-warning",{children:"\u6b64\u6587\u6863\u6b63\u5728\u8fdb\u884c\u4e2d\uff1a\u5b83\u662f\u4ece\u6587\u4ef6\u4e0a\u4f20\u7684API\u6587\u6863\u4e2d\u63d0\u53d6\u7684\uff0c\u56e0\u6b64\u6709\u4e9b\u4e0d\u592a\u76f8\u5173\u3002\u6211\u4eec\u6253\u7b97\u5c06\u5176\u91cd\u5199\u4e3a\u6587\u4ef6\u4e0a\u4f20\u7684\u4e00\u822c\u6307\u5357\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u60a8\u53ef\u80fd\u5e0c\u671b\u5c06\u6587\u4ef6\u4ee3\u7406\u5230\u6587\u4ef6\u4e3b\u673a\u3002"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u793a\u4f8b\uff1a"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-tsx",children:'import type {\n  ActionFunctionArgs,\n  UploadHandler,\n} from "@remix-run/node"; // or cloudflare/deno\nimport {\n  unstable_composeUploadHandlers,\n  unstable_createMemoryUploadHandler,\n  unstable_parseMultipartFormData,\n} from "@remix-run/node"; // or cloudflare/deno\nimport { writeAsyncIterableToWritable } from "@remix-run/node"; // `writeAsyncIterableToWritable` is a Node-only utility\nimport type {\n  UploadApiOptions,\n  UploadApiResponse,\n  UploadStream,\n} from "cloudinary";\nimport cloudinary from "cloudinary";\n\nasync function uploadImageToCloudinary(\n  data: AsyncIterable<Uint8Array>\n) {\n  const uploadPromise = new Promise<UploadApiResponse>(\n    async (resolve, reject) => {\n      const uploadStream =\n        cloudinary.v2.uploader.upload_stream(\n          {\n            folder: "remix",\n          },\n          (error, result) => {\n            if (error) {\n              reject(error);\n              return;\n            }\n            resolve(result);\n          }\n        );\n      await writeAsyncIterableToWritable(\n        data,\n        uploadStream\n      );\n    }\n  );\n\n  return uploadPromise;\n}\n\nexport const action = async ({\n  request,\n}: ActionFunctionArgs) => {\n  const userId = getUserId(request);\n\n  const uploadHandler = unstable_composeUploadHandlers(\n    // our custom upload handler\n    async ({ name, contentType, data, filename }) => {\n      if (name !== "img") {\n        return undefined;\n      }\n      const uploadedImage = await uploadImageToCloudinary(\n        data\n      );\n      return uploadedImage.secure_url;\n    },\n    // fallback to memory for everything else\n    unstable_createMemoryUploadHandler()\n  );\n\n  const formData = await unstable_parseMultipartFormData(\n    request,\n    uploadHandler\n  );\n\n  const imageUrl = formData.get("avatar");\n\n  // because our uploadHandler returns a string, that\'s what the imageUrl will be.\n  // ... etc\n};\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"UploadHandler"}),"\u51fd\u6570\u63a5\u53d7\u6709\u5173\u6587\u4ef6\u7684\u591a\u4e2a\u53c2\u6570\uff1a"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u5c5e\u6027"}),(0,t.jsx)(n.th,{children:"\u7c7b\u578b"}),(0,t.jsx)(n.th,{children:"\u63cf\u8ff0"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"name"}),(0,t.jsx)(n.td,{children:"string"}),(0,t.jsx)(n.td,{children:"\u5b57\u6bb5\u540d\u79f0\uff08\u6765\u81ea\u60a8\u7684HTML\u8868\u5355\u5b57\u6bb5\u7684\u201cname\u201d\u503c\uff09"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"data"}),(0,t.jsx)(n.td,{children:"AsyncIterable"}),(0,t.jsx)(n.td,{children:"\u6587\u4ef6\u5b57\u8282\u7684\u53ef\u8fed\u4ee3\u5bf9\u8c61"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"filename"}),(0,t.jsx)(n.td,{children:"string"}),(0,t.jsxs)(n.td,{children:["\u7528\u6237\u9009\u62e9\u4e0a\u4f20\u7684\u6587\u4ef6\u540d\u79f0\uff08\u5982",(0,t.jsx)(n.code,{children:"rickroll.mp4"}),"\uff09"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"contentType"}),(0,t.jsx)(n.td,{children:"string"}),(0,t.jsxs)(n.td,{children:["\u6587\u4ef6\u7684\u5185\u5bb9\u7c7b\u578b\uff08\u5982",(0,t.jsx)(n.code,{children:"videomp4"}),"\uff09"]})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["\u60a8\u7684\u4efb\u52a1\u662f\u5bf9",(0,t.jsx)(n.code,{children:"data"}),"\u6267\u884c\u6240\u9700\u7684\u64cd\u4f5c\uff0c\u5e76\u8fd4\u56de\u4e00\u4e2a\u6709\u6548\u7684 [",(0,t.jsx)(n.code,{children:"FormData"}),"][form-data] \u503c\uff1a [",(0,t.jsx)(n.code,{children:"File"}),"][the-browser-file-api]\u3001",(0,t.jsx)(n.code,{children:"string"}),"\u6216",(0,t.jsx)(n.code,{children:"undefined"}),"\u4ee5\u8df3\u8fc7\u5c06\u5176\u6dfb\u52a0\u5230\u7ed3\u679cFormData\u4e2d\u3002"]}),"\n",(0,t.jsx)(n.h3,{id:"\u4e0a\u4f20\u5904\u7406\u7a0b\u5e8f\u7ec4\u5408",children:"\u4e0a\u4f20\u5904\u7406\u7a0b\u5e8f\u7ec4\u5408"}),"\n",(0,t.jsxs)(n.p,{children:["\u6211\u4eec\u6709\u5185\u7f6e\u7684 ",(0,t.jsx)(n.code,{children:"unstable_createFileUploadHandler"})," \u548c ",(0,t.jsx)(n.code,{children:"unstable_createMemoryUploadHandler"}),"\uff0c\u5e76\u4e14\u6211\u4eec\u4e5f\u671f\u5f85\u672a\u6765\u4f1a\u5f00\u53d1\u66f4\u591a\u4e0a\u4f20\u5904\u7406\u7a0b\u5e8f\u5de5\u5177\u3002\u5982\u679c\u60a8\u6709\u4e00\u4e2a\u9700\u8981\u4f7f\u7528\u4e0d\u540c\u4e0a\u4f20\u5904\u7406\u7a0b\u5e8f\u7684\u8868\u5355\uff0c\u60a8\u53ef\u4ee5\u4e0e\u81ea\u5b9a\u4e49\u5904\u7406\u7a0b\u5e8f\u7ec4\u5408\u5b83\u4eec\uff0c\u4ee5\u4e0b\u662f\u4e00\u4e2a\u7406\u8bba\u793a\u4f8b\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:"filename=file-upload-handler.server.ts",children:'import type { UploadHandler } from "@remix-run/node"; // or cloudflare/deno\nimport { unstable_createFileUploadHandler } from "@remix-run/node"; // or cloudflare/deno\nimport { createCloudinaryUploadHandler } from "some-handy-remix-util";\n\nexport const standardFileUploadHandler =\n  unstable_createFileUploadHandler({\n    directory: "public/calendar-events",\n  });\n\nexport const cloudinaryUploadHandler =\n  createCloudinaryUploadHandler({\n    folder: "/my-site/avatars",\n  });\n\nexport const fileUploadHandler: UploadHandler = (args) => {\n  if (args.name === "calendarEvent") {\n    return standardFileUploadHandler(args);\n  } else if (args.name === "eventBanner") {\n    return cloudinaryUploadHandler(args);\n  }\n  return undefined;\n};\n'})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>l});var t=r(6540);const a={},d=t.createContext(a);function o(e){const n=t.useContext(d);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),t.createElement(d.Provider,{value:n},e.children)}}}]);